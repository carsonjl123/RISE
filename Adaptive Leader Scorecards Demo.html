<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width,initial-scale=1" name="viewport"/>
<title>Adaptive Leadership Scorecards — v3_23 (All‑in‑One + Manager Insights)</title>
<style>
:root{--bg:#0a0f16;--panel:#0f1620;--text:#e6f0ff;--muted:#9bb0c6;--border:#243243;--card:#101a28}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--text);font:14px/1.4 ui-sans-serif,system-ui,Segoe UI,Roboto,Arial}
header{padding:14px 16px;border-bottom:1px solid var(--border);display:flex;gap:8px;align-items:center;flex-wrap:wrap}
h1{font-size:18px;margin:0 10px 0 0}
.btn,.tab{padding:8px 12px;border:1px solid var(--border);border-radius:10px;background:transparent;color:var(--text);cursor:pointer}
.tab.active{background:linear-gradient(180deg,rgba(255,255,255,.05),rgba(255,255,255,.02))}
main{padding:14px 16px;max-width:1500px;margin:0 auto}
.panel{background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:12px}
.hr{height:1px;background:var(--border);margin:8px 0}
.row-mid{display:flex;align-items:center;gap:8px}
.list{display:grid;gap:8px}
.small{font-size:12px}.muted{color:var(--muted)}

/* Admin layout */
#builder{display:grid;grid-template-columns:420px 1fr 340px;gap:12px}
@media(max-width:1280px){#builder{grid-template-columns:1fr}}

/* Seeds */
.seed-header{position:sticky;top:0;background:var(--panel);padding:4px 0 6px;margin:0 0 6px;border-bottom:1px solid var(--border)}
.seed-row{display:flex;flex-direction:column;gap:6px;padding:6px 4px;border-bottom:1px dashed var(--border)}
.seed-row .top{display:flex;gap:8px;align-items:center;justify-content:space-between}
.seed-row .kpill{font-weight:600}
.seed-row .meta{display:flex;gap:12px;flex-wrap:wrap;align-items:center;justify-content:space-between}
#kpiSeeds{max-height:60vh;overflow:auto;padding-right:4px}

/* Manager */
#compositeCards{display:grid;grid-template-columns:repeat(2,minmax(520px,1fr));gap:12px}
@media(max-width:1200px){#compositeCards{grid-template-columns:1fr}}
.kpi{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:10px}
.kpi .headerline{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px}
.table{width:100%;border-collapse:collapse;table-layout:fixed}
.table th,.table td{border-bottom:1px solid var(--border);padding:6px;text-align:left;font-size:13px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.score-chip{display:inline-block;min-width:44px;text-align:center;padding:2px 8px;border-radius:999px;border:1px solid var(--border);font-weight:700}
.chip-green{background:rgba(34,197,94,.12);border-color:#166534}
.chip-yellow{background:rgba(245,158,11,.12);border-color:#92400e}
.chip-amber{background:rgba(249,115,22,.12);border-color:#9a3412}
.chip-red{background:rgba(239,68,68,.12);border-color:#991b1b}

/* Insights */
.tiles{display:grid;grid-template-columns:repeat(4,minmax(180px,1fr));gap:10px}
.tile{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:10px}
.tile .big{font-size:22px;font-weight:700}
.chartbox{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:8px}
.focuslist{display:grid;gap:8px}
.focusitem{background:var(--card);border:1px dashed var(--border);border-radius:10px;padding:8px}
@media(max-width:1200px){.tiles{grid-template-columns:repeat(2,1fr)}}

/* --- Exec Dashboard add-on --- */
.exec-hidden{display:none}
.exec-card{background:#0f1c28;border:1px solid #1f3447;border-radius:14px;padding:14px;margin-bottom:12px}
.exec-grid{display:grid;gap:12px}
.exec-cols-3{grid-template-columns:1fr 1fr 1fr}
.exec-cols-2{grid-template-columns:1fr 1fr}
.exec-table{width:100%;border-collapse:collapse}
.exec-table th,.exec-table td{border-bottom:1px solid #1f3447;padding:8px 8px;text-align:left;font-size:13px;color:#e6f0ff}
.exec-pill{display:inline-block;padding:3px 10px;border-radius:999px;border:1px solid #1f3447;background:#15293a;font-weight:700;font-size:12px}
.exec-pill.green{color:#0fd47a;border-color:#0fd47a22}
.exec-pill.yellow{color:#e6b400;border-color:#e6b40022}
.exec-pill.amber{color:#ff8a33;border-color:#ff8a3322}
.exec-pill.red{color:#ff5757;border-color:#ff575722}
.exec-muted{color:#9bb0c9;font-size:12px}

.pill{display:inline-block;padding:3px 10px;border-radius:999px;border:1px solid #1f3447;background:#15293a;font-weight:700;font-size:12px}
.pill.green{color:#0fd47a;border-color:#0fd47a22}
.pill.yellow{color:#e6b400;border-color:#e6b40022}
.pill.amber{color:#ff8a33;border-color:#ff8a3322}
.pill.red{color:#ff5757;border-color:#ff575722}

</style>

<style>
:root{
  --bg:#0f1220;
  --surface:#15192e;
  --surface-2:#1b2142;
  --card:#11162a;
  --text:#e8ecff;
  --muted:#a7b0d6;
  --border:rgba(255,255,255,.09);
  --shadow:0 10px 24px rgba(0,0,0,.35);

  /* Bands */
  --g:#24d17e;
  --y:#f7c948;
  --r:#ff5d5d;
  --g-20:rgba(36,209,126,.20);
  --y-20:rgba(247,201,72,.20);
  --r-20:rgba(255,93,93,.20);
}

body{background:var(--bg);color:var(--text);}
.card{background:linear-gradient(180deg,var(--surface),var(--card));border:1px solid var(--border);border-radius:16px;box-shadow:var(--shadow);overflow:hidden;}
.card-title{padding:10px 14px;font-weight:700;letter-spacing:.2px;background:linear-gradient(90deg,rgba(167,176,214,.12),transparent);border-bottom:1px solid var(--border)}

.table th,.table td{border-bottom:1px solid var(--border);}
.table tr:hover td{background:rgba(255,255,255,.025)}

/* Score chips + Band chips */
.score-chip,.band-chip{display:inline-block;border-radius:999px;padding:2px 10px;font-weight:700;letter-spacing:.2px}
.score-chip{border:1px solid var(--border);min-width:44px;text-align:center;background:rgba(255,255,255,.03)}
.band-chip{border:1px solid var(--border);text-transform:capitalize}
.band.red{color:#fff;background:var(--r-20);border-color:var(--r);}
.band.yellow{color:#3a3100;background:var(--y-20);border-color:var(--y);}
.band.green{color:#00351f;background:var(--g-20);border-color:var(--g);}

/* Heatmap cells (Band column) */
td.bandcell{font-weight:700}
td.bandcell .band{min-width:70px;text-align:center}

/* KPI legend (inline) */
.kpi-legend{display:flex;gap:8px;align-items:center;font-size:12px;color:var(--muted);}
.kpi-dot{width:10px;height:10px;border-radius:50%}
.kpi-dot.g{background:var(--g)}
.kpi-dot.y{background:var(--y)}
.kpi-dot.r{background:var(--r)}

/* Emphasis numbers */
.big-num{font-size:42px;font-weight:800;line-height:1.05}
.subtle{opacity:.78}

/* Buttons (if present) */
button, .btn{background:var(--surface-2);color:var(--text);border:1px solid var(--border);padding:8px 12px;border-radius:10px}
button:hover,.btn:hover{filter:brightness(1.05)}
</style>
<!-- === ALS Visual Theme v2 (inspired by v2_2_patched5; CSS-only) ==================== -->
<style>
/* Base palette & tokens */
:root{
  --bg:#0b1420;
  --panel:#0f1e2d;
  --card:#0d1c25;
  --text:#e6f0ff;
  --muted:#9bb3c9;
  --border:#1f3550;
  --glow:rgba(83,177,253,.18);
  --surface-2:#13263b;

  --g:#2ecc71; --y:#ffcc33; --r:#e74c3c;
  --g-20:rgba(46,204,113,.18);
  --y-20:rgba(255,204,51,.20);
  --r-20:rgba(231,76,60,.20);
}

/* Typography */
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap');
html, body{background:#000 !important;}
body{margin:0; background:radial-gradient(1200px 800px at 20% -10%,#13263b 0,#0b1420 45%,#0b1420 100%);}

/* Layout containers */
.container{max-width:2200px;margin:22px auto;padding:0 16px}
.card{
  background:linear-gradient(180deg,var(--panel),var(--card));
  border:1px solid var(--border);
  border-radius:16px;
  box-shadow:0 12px 26px rgba(0,0,0,.35),0 0 0 1px rgba(83,177,253,.08);
  overflow:hidden;
}
.card-title{padding:10px 14px;font-weight:700;letter-spacing:.2px;background:linear-gradient(90deg,rgba(167,176,214,.12),transparent);border-bottom:1px solid var(--border)}
.card-body{padding:12px 14px}

/* Tables */
.table{width:100%;border-collapse:collapse;table-layout:fixed}
.table th,.table td{
  border-bottom:1px solid var(--border);
  padding:6px 6px;
  text-align:left;
  font-size:13px;
  vertical-align:middle;
  white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
}
.table tr:hover td{background:rgba(255,255,255,.025)}

/* Buttons */
button, .btn{
  background:#183856; color:var(--text);
  border:1px solid var(--border);
  padding:8px 12px; border-radius:10px; cursor:pointer;
}
button:hover,.btn:hover{filter:brightness(1.05)}
.btn.green{background:#1b5e42;border-color:#184533}
.btn.red{background:#6b2a24;border-color:#4d1f1b}
.btn.yellow{background:#6f5a16;border-color:#56490f}

/* Chips and band visuals */
.score-chip,.band-chip{
  display:inline-block; border-radius:999px; padding:2px 10px; font-weight:700; letter-spacing:.2px;
  border:1px solid var(--border); background:rgba(255,255,255,.03);
}
.band{ text-transform:capitalize; }
.band.red{color:#fff;background:var(--r-20);border-color:var(--r);}
.band.yellow{color:#3a3100;background:var(--y-20);border-color:var(--y);}
.band.green{color:#00351f;background:var(--g-20);border-color:var(--g);}

/* Legend */
.kpi-legend{display:flex;gap:8px;align-items:center;font-size:12px;color:var(--muted);}
.kpi-dot{width:10px;height:10px;border-radius:50%}
.kpi-dot.g{background:var(--g)} .kpi-dot.y{background:var(--y)} .kpi-dot.r{background:var(--r)}

/* Big number & subtle text */
.big-num{font-size:42px;font-weight:800;line-height:1.05}
.subtle{opacity:.78}

/* Gauges (generic) */
.gauge{height:10px;background:#091320;border-radius:999px;overflow:hidden;border:1px solid var(--border)}
.gauge span{display:block;height:100%;width:0}
.fill-green{background:linear-gradient(90deg,#1f995c,#2ecc71)}
.fill-yellow{background:linear-gradient(90deg,#b68400,#ffcc33)}
.fill-red{background:linear-gradient(90deg,#a6282b,#e74c3c)}

/* Minor polish */
.hr{height:1px;background:linear-gradient(90deg,transparent,#28435f,transparent);margin:8px 0}
.badge{font-size:11px;padding:3px 8px;border-radius:999px;border:1px solid var(--border);color:var(--muted)}
.input,.select,input[type="number"],input[type="text"],input[type="date"],textarea{
  width:100%;background:#102133;border:1px solid var(--border);color:var(--text);padding:8px 10px;border-radius:10px
}
/* Ensure any grids (if present) breathe nicely */
.grid{display:grid;gap:12px}
.row{display:flex;gap:12px;align-items:center}
</style>
<!-- === ALS Futuristic Neon Theme v1 (look & feel + band accents) ================== -->
<style id="als-neon-theme-v1">
:root{
  --bg:#070a12; --bg2:#091325;
  --panel:#0e1524; --card:#0b1220; --card2:#0e1a2e;
  --text:#eaf2ff; --muted:#98afc9; --border:#1b2d48;
  --neon-cyan:#33e1ff; --neon-violet:#9a6bff; --neon-green:#2ff5a3; --neon-amber:#ffc14a; --neon-red:#ff5c7a;
}
html, body{background:#000 !important;}
.card{
  background:linear-gradient(180deg,rgba(18,26,46,.85), rgba(12,18,32,.9));
  border:1px solid var(--border);
  border-radius:16px;
  box-shadow:0 12px 28px rgba(0,0,0,.45), 0 0 0 1px rgba(144,196,255,.08) inset;
  overflow:hidden; position:relative;
}
.card::after{ content:""; position:absolute; inset:0; pointer-events:none;
  background: linear-gradient(120deg, transparent 0%, rgba(51,225,255,.08) 25%, rgba(154,107,255,.06) 50%, transparent 80%);
  mix-blend-mode: screen;
}
.card-title{ padding:10px 14px;font-weight:800;letter-spacing:.2px;
  background:linear-gradient(90deg, rgba(90,160,255,.12), transparent); border-bottom:1px solid var(--border)}
.card-body{padding:14px}
button,.btn{background:linear-gradient(180deg,#15243b,#0f1b2f);border:1px solid var(--border);border-radius:12px;color:var(--text);padding:8px 12px;transition:all .18s ease}
button:hover,.btn:hover{transform:translateY(-1px);box-shadow:0 10px 28px rgba(0,0,0,.5), 0 0 0 1px rgba(51,225,255,.28) inset}
select,input,textarea{background:linear-gradient(180deg,#0e1a2b,#0b1422);border:1px solid var(--border);border-radius:10px;color:var(--text);padding:8px 10px}
.table{width:100%;border-collapse:collapse;table-layout:fixed}
.table th,.table td{border-bottom:1px solid rgba(255,255,255,.06);padding:6px 8px;font-size:13px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.table thead th{color:#cfe1ff;font-weight:800}
.table tr:hover td{background:rgba(255,255,255,.03)}
.score-chip,.band-chip{display:inline-block;border-radius:999px;padding:2px 10px;font-weight:800;letter-spacing:.2px;border:1px solid rgba(255,255,255,.08);background:rgba(255,255,255,.04)}
.band{ text-transform:capitalize; }
.band.red{color:#fff;background:rgba(255,92,122,.18);border-color:var(--neon-red);box-shadow:0 0 12px rgba(255,92,122,.25) inset}
.band.yellow{color:#2c2300;background:rgba(255,193,74,.22);border-color:var(--neon-amber);box-shadow:0 0 12px rgba(255,193,74,.25) inset}
.band.green{color:#002b1b;background:rgba(47,245,163,.20);border-color:var(--neon-green);box-shadow:0 0 12px rgba(47,245,163,.22) inset}
tr.band-red td{ background:linear-gradient(90deg, rgba(255,92,122,.10), transparent) }
tr.band-yellow td{ background:linear-gradient(90deg, rgba(255,193,74,.12), transparent) }
tr.band-green td{ background:linear-gradient(90deg, rgba(47,245,163,.10), transparent) }
.card.band-red{ box-shadow:0 12px 28px rgba(0,0,0,.45), 0 0 0 1px rgba(255,92,122,.25) inset, 0 0 32px rgba(255,92,122,.12) }
.card.band-yellow{ box-shadow:0 12px 28px rgba(0,0,0,.45), 0 0 0 1px rgba(255,193,74,.25) inset, 0 0 32px rgba(255,193,74,.13) }
.card.band-green{ box-shadow:0 12px 28px rgba(0,0,0,.45), 0 0 0 1px rgba(47,245,163,.24) inset, 0 0 32px rgba(47,245,163,.12) }
.big-num{font-size:44px;font-weight:900;letter-spacing:.3px;text-shadow:0 2px 22px rgba(122,228,255,.12)}
.subtle{opacity:.78}
.progress,.gauge{height:8px;border-radius:999px;background:linear-gradient(90deg,#0c1a2b,#0b1727);border:1px solid rgba(255,255,255,.08);overflow:hidden}
.progress .bar,.gauge span{height:100%;display:block;background:linear-gradient(90deg,#ff6b6b 0%, #ffb86b 30%, #ffd56b 55%, #5af59e 100%)}
</style>
<style id="als-neon-strong-bands">
/* Strong band colors with !important to defeat earlier styles */
.band.red{    color:#fff !important; background:rgba(255,92,122,.20) !important; border-color:#ff5c7a !important; box-shadow:0 0 12px rgba(255,92,122,.28) inset !important;}
.band.yellow{ color:#2c2300 !important; background:rgba(255,193,74,.24) !important; border-color:#ffc14a !important; box-shadow:0 0 12px rgba(255,193,74,.28) inset !important;}
.band.green{  color:#002b1b !important; background:rgba(47,245,163,.24) !important; border-color:#2ff5a3 !important; box-shadow:0 0 12px rgba(47,245,163,.25) inset !important;}

/* Row tints */
tr.band-red td{ background:linear-gradient(90deg, rgba(255,92,122,.12), transparent) !important }
tr.band-yellow td{ background:linear-gradient(90deg, rgba(255,193,74,.14), transparent) !important }
tr.band-green td{ background:linear-gradient(90deg, rgba(47,245,163,.12), transparent) !important }

/* Exec card glow by band */
.card.band-red{    box-shadow:0 12px 28px rgba(0,0,0,.45), 0 0 0 1px rgba(255,92,122,.32) inset, 0 0 36px rgba(255,92,122,.16) !important }
.card.band-yellow{ box-shadow:0 12px 28px rgba(0,0,0,.45), 0 0 0 1px rgba(255,193,74,.32) inset, 0 0 36px rgba(255,193,74,.16) !important }
.card.band-green{  box-shadow:0 12px 28px rgba(0,0,0,.45), 0 0 0 1px rgba(47,245,163,.30) inset, 0 0 34px rgba(47,245,163,.15) !important }
</style>
<style id="als-neon-conditional-chips">
.score-chip, .chip, .badge, .pill, .kpi .score > *, .kpi .chip {
  border-radius: 999px;
  padding: 4px 10px;
  font-weight: 800;
  letter-spacing: .2px;
  border: 1px solid rgba(255,255,255,.18);
  color: #fff;
  text-shadow: 0 0 2px rgba(0,0,0,.75), 0 0 6px rgba(0,0,0,.45);
  background: rgba(255,255,255,.06);
}
.is-green  { background: linear-gradient(180deg, rgba(21,208,122,.22), rgba(21,208,122,.10)) !important; border-color: rgba(21,208,122,.55) !important; box-shadow: 0 0 0 1px rgba(21,208,122,.35) inset, 0 0 16px rgba(21,208,122,.25) !important; color: #eafff6 !important; }
.is-yellow { background: linear-gradient(180deg, rgba(255,209,102,.24), rgba(255,209,102,.12)) !important; border-color: rgba(255,209,102,.65) !important; box-shadow: 0 0 0 1px rgba(255,209,102,.35) inset, 0 0 16px rgba(255,209,102,.25) !important; color: #1d1800 !important; }
.is-red    { background: linear-gradient(180deg, rgba(255,107,107,.26), rgba(255,107,107,.12)) !important; border-color: rgba(255,107,107,.7) !important;  box-shadow: 0 0 0 1px rgba(255,107,107,.42) inset, 0 0 16px rgba(255,107,107,.28) !important; color: #fff !important; }
tr.band-red    > td { background: linear-gradient(90deg, rgba(255,107,107,.10), transparent) }
tr.band-yellow > td { background: linear-gradient(90deg, rgba(255,209,102,.12), transparent) }
tr.band-green  > td { background: linear-gradient(90deg, rgba(21,208,122,.10), transparent) }
.card.band-red    { box-shadow: 0 12px 28px rgba(0,0,0,.45), 0 0 0 1px rgba(255,107,107,.30) inset, 0 0 34px rgba(255,107,107,.16) }
.card.band-yellow { box-shadow: 0 12px 28px rgba(0,0,0,.45), 0 0 0 1px rgba(255,209,102,.30) inset, 0 0 34px rgba(255,209,102,.16) }
.card.band-green  { box-shadow: 0 12px 28px rgba(0,0,0,.45), 0 0 0 1px rgba(21,208,122,.30) inset, 0 0 32px rgba(21,208,122,.15) }
</style>
<style>
/* === NEON TWEAKS START === */
:root{
  --neon-bg:#0b0f17;
  --neon-accent:#7cf3ff;
  --neon-accent-2:#9d7cff;
  --neon-hot:#ff6bd6;
  --neon-green:#7dffb0;
  --neon-yellow:#ffd86b;
  --neon-border:rgba(124,243,255,.35);
  --neon-text:#e7f6ff;
}

/* Futuristic headers */
h1, .page-title, header h1, .module-header h1{
  font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji";
  font-weight: 800;
  letter-spacing: .02em;
  text-transform: uppercase;
  color: var(--neon-text);
  background: linear-gradient(90deg, var(--neon-accent), var(--neon-accent-2), var(--neon-hot));
  -webkit-background-clip: text;
  background-clip: text;
  color: transparent;
  filter: drop-shadow(0 0 10px rgba(124,243,255,.25));
}

/* Dropdowns */
select, .select, .kpi-filter select, .toolbar select{
  background: radial-gradient(120% 180% at 10% 10%, rgba(124,243,255,.08), rgba(157,124,255,.06) 40%, rgba(11,15,23,.95) 60%) var(--neon-bg);
  color: var(--neon-text);
  border: 1px solid var(--neon-border);
  border-radius: 10px;
  padding: .55rem .95rem;
  
  box-shadow: 0 0 0 3px rgba(124,243,255,0) inset, 0 6px 18px rgba(0,0,0,.35);
  transition: box-shadow .2s ease, border-color .2s ease, transform .08s ease;
}
select:hover, .select:hover, .kpi-filter select:hover, .toolbar select:hover{
  border-color: rgba(157,124,255,.65);
}
select:focus, .select:focus, .kpi-filter select:focus, .toolbar select:focus{
  box-shadow: 0 0 0 3px rgba(124,243,255,.25) inset, 0 0 18px rgba(124,243,255,.25);
  border-color: var(--neon-accent);
  transform: translateY(-1px);
}
/* Ensure dropdown options are readable */
select option{
  color: #0b0f17;
  background: #d6faff;
}

/* Admin Builder: selected KPI glow */
.admin-builder .kpi-card.selected, .admin-builder .kpi.selected, .kpi-card.is-selected{
  position: relative;
  border: 1px solid rgba(157,124,255,.55);
  box-shadow:
    0 0 0 1px rgba(124,243,255,.25) inset,
    0 0 24px rgba(157,124,255,.35),
    0 8px 28px rgba(0,0,0,.45);
  transform: translateZ(0);
}
.admin-builder .kpi-card.selected::after, .admin-builder .kpi.selected::after, .kpi-card.is-selected::after{
  content: "SELECTED";
  position: absolute;
  top: 10px; right: 12px;
  font-size: .65rem;
  letter-spacing: .12em;
  padding: .15rem .4rem;
  border: 1px solid rgba(124,243,255,.45);
  border-radius: 999px;
  background: rgba(124,243,255,.08);
  color: var(--neon-accent);
  text-shadow: 0 0 8px rgba(124,243,255,.5);
}

/* 12-week look-back & look-forward lines for charts
   Target common libs: Chart.js, ApexCharts, ECharts via per-class styling */
.lookback-12-line{
  stroke: var(--neon-yellow) !important;
  stroke-width: 3 !important;
}
.lookforward-12-line{
  stroke: var(--neon-green) !important;
  stroke-width: 3 !important;
  stroke-dasharray: 6 6 !important; /* dotted */
}

/* Fallback for canvas-based charts (Chart.js) by legend badges */
.chart-legend .lookback-12::before,
.legend .lookback-12::before{
  content:"";
  display:inline-block;
  width:12px;height:3px;margin-right:8px;
  background: var(--neon-yellow);
}
.chart-legend .lookforward-12::before,
.legend .lookforward-12::before{
  content:"";
  display:inline-block;
  width:12px;height:3px;margin-right:8px;
  background: var(--neon-green);
  border-bottom: 3px dotted var(--neon-green);
}

/* Optional dark background polish */
body{
  background-color: var(--neon-bg);
}
/* === NEON TWEAKS END === */

</style>
<style id="als-exec-visual-boost">
/* ===== Executive Tab Visual Distinction (append-only) ===== */
/* Root surface */
.exec-surface {
  background: radial-gradient(900px 600px at 85% 0%, rgba(157,125,255,.08), transparent 60%),
              radial-gradient(1000px 650px at 10% 100%, rgba(0,231,255,.08), transparent 60%);
  border-radius: 16px;
  padding: 8px;
}

/* Cards inside executive */
.exec-card {
  border: 1px solid rgba(124,243,255,.22) !important;
  box-shadow: 0 0 0 1px rgba(124,243,255,.10) inset,
              0 14px 36px rgba(0,0,0,.45),
              0 0 34px rgba(124,243,255,.10);
  position: relative;
}

.exec-card::before {
  content: "";
  position: absolute; inset: -1px;
  border-radius: inherit;
  pointer-events: none;
  background: linear-gradient(135deg, rgba(124,243,255,.35), rgba(157,125,255,.35), rgba(255,107,214,.30));
  -webkit-mask: 
    linear-gradient(#000 0 0) content-box, 
    linear-gradient(#000 0 0);
  -webkit-mask-composite: xor;
          mask-composite: exclude;
  padding: 1px;
  opacity: .18;
}

/* Accent header strip for exec section titles */
.exec-title, .exec-card h2, .exec-card h3 {
  position: relative;
}
.exec-title::after, .exec-card h2::after, .exec-card h3::after {
  content: "";
  position: absolute;
  left: 0; bottom: -6px;
  width: 140px; height: 2px;
  background: linear-gradient(90deg, #00e7ff, #9d7dff, #ff6bd6);
  box-shadow: 0 0 12px rgba(0,231,255,.35);
  border-radius: 999px;
  opacity: .85;
}

/* Trend / Forecasting panel colorization (solid lookback / dotted forecast) */
.trend-visual {
  border: 1px solid rgba(157,125,255,.28);
  box-shadow: 0 0 0 1px rgba(157,125,255,.12) inset, 0 10px 26px rgba(0,0,0,.38);
  background: linear-gradient(180deg, rgba(26,31,59,.85), rgba(16,20,36,.85));
  border-radius: 14px;
  padding: 10px;
}

/* Generic SVG/line color hooks (if chart library exposes classes) */
.trend-visual .series-lookback line,
.trend-visual .series-lookback path { stroke: #ffd86b !important; stroke-width: 3 !important; }
.trend-visual .series-forecast line,
.trend-visual .series-forecast path { stroke: #7dffb0 !important; stroke-width: 3 !important; stroke-dasharray: 6 6 !important; }

</style>
<style>
/* === Legend styling (glow) === */
.perf-bonus-card { position: relative; }
.perf-legend {
  position: absolute;
  right: 18px;
  top: 1pt;
  display: inline-flex;
  gap: 14px;
  padding: 6px 12px;
  border-radius: 20px;
  background: rgba(10,20,30,0.45);
  backdrop-filter: blur(4px);
  border: 1px solid rgba(68,116,178,0.28);
  box-shadow: 0 6px 18px rgba(0, 180, 255, 0.08), inset 0 0 10px rgba(0,0,0,0.25);
  align-items: center;
  z-index: 5;
}
.perf-legend .legend-chip {
  display: inline-flex;
  align-items: center;
  font-size: 12px;
  letter-spacing: .2px;
  color: #d6eaff;
  padding: 4px 8px;
  border-radius: 14px;
  background: rgba(22, 32, 44, .35);
  border: 1px solid rgba(93,152,255,.18);
}
.perf-legend .legend-dot {
  width: 9px;
  height: 9px;
  border-radius: 50%;
  margin-right: 8px;
  box-shadow: 0 0 8px currentColor, 0 0 16px currentColor;
  display: inline-block;
}
.perf-legend .legend-dot.cyan {
  color: #28d7ff;
  background: radial-gradient(circle at 40% 40%, #7ff0ff, #28d7ff 55%, #0aa6d1 100%);
}
.perf-legend .legend-dot.amber {
  color: #ffc24a;
  background: radial-gradient(circle at 40% 40%, #ffd98a, #ffc24a 55%, #c98707 100%);
}
/* Make sure the header area has spacing so the legend doesn't overlap text */
.perf-bonus-card .panel-title, 
.perf-bonus-card h2, 
.perf-bonus-card h3 {
  padding-right: 170px !important;
}

/* Responsive fallback: move legend under header on very narrow widths */
@media (max-width: 900px) {
  .perf-legend { position: static; margin: 8px 0 0 auto; display: flex; }
  .perf-bonus-card .panel-title, 
  .perf-bonus-card h2, 
  .perf-bonus-card h3 { padding-right: 0 !important; }
}

/* Color the trend lines to match legend (if present) */
svg[data-trend='lookback'] path,
canvas[data-trend='lookback'] ~ .trend-line-lookback {
  stroke: #28d7ff !important;
}
svg[data-trend='forecast'] path.dotted,
canvas[data-trend='forecast'] ~ .trend-line-forecast {
  stroke: #ffc24a !important;
}
</style>
<style>
/* --- Patch: hide legacy non-glow legend duplicates --- */

</style>
<style id="ghost-legend-suppressor">
/* Force-hide any legacy ghost legend if something remains */
.trend-legend{ display:none !important; visibility:hidden !important; height:0 !important; overflow:hidden !important; }
</style>


<style>
/* === Futuristic Cyan Grid + Panel Glow (Enhanced) ======================= */
:root{
  --grid-gap: 96px;
  --grid-line: rgba(64, 160, 255, 0.07);
  --grid-glow: rgba(64, 160, 255, 0.04);
  --panel-border: rgba(64, 160, 255, 0.18);
  --panel-glow: 0 0 22px rgba(64, 160, 255, 0.25), 0 0 2px rgba(64, 160, 255, 0.12);
}

html, body{background:#000 !important;}

html::before {
  content: "";
  position: fixed;
  inset: 0;
  z-index: 0;
  background-image: linear-gradient(var(--line) 1px, transparent 1px), linear-gradient(90deg, var(--line) 1px, transparent 1px);
  background-size: var(--gap) var(--gap), var(--gap) var(--gap);
  background-position: center center, center center;
  pointer-events: none;
  animation: gridDrift 28s ease-in-out infinite;
}

html::after{content:"";position:fixed;inset:0;z-index:0;background:radial-gradient(40vw 40vw at 70% 20%, rgba(64,160,255,0.035), transparent 60%) , radial-gradient(45vw 45vw at 30% 80%, rgba(64,160,255,0.03), transparent 65%);pointer-events:none;}

body > * { position: relative; z-index: 1; }

@keyframes gridDrift {
  0%   { background-position: center center, center center; }
  50%  { background-position: calc(50% + 12px) calc(50% + 12px), calc(50% + 12px) calc(50% - 12px); }
  100% { background-position: center center, center center; }
}

.panel, .card, .tile, .module, .kpi,
[class*="card"], [class*="panel"], [class*="tile"], [class*="module"], [class*="kpi"] {
  position: relative;
  border-radius: 14px;
  
  
}

.panel::before, .card::before, .tile::before, .module::before, .kpi::before,
[class*="card"]::before, [class*="panel"]::before, [class*="tile"]::before, [class*="module"]::before, [class*="kpi"]::before {
  content: "";
  position: absolute;
  inset: -8px;
  border-radius: inherit;
  z-index: -1;
  box-shadow: var(--panel-glow);
  pointer-events: none;
}

</style>



<style>
/* === Electric Neon Grid + Panel Neon Glow ================================= */
:root{
  --gap: 88px;                       /* grid spacing */
  --neon-r: 64; --neon-g: 160; --neon-b: 255;
  --line: rgba(var(--neon-r), var(--neon-g), var(--neon-b), 0.11);
  --node: rgba(var(--neon-r), var(--neon-g), var(--neon-b), 0.12);
  --haze1: rgba(var(--neon-r), var(--neon-g), var(--neon-b), 0.04);
  --haze2: rgba(var(--neon-r), var(--neon-g), var(--neon-b), 0.03);
  --panel-stroke: rgba(var(--neon-r), var(--neon-g), var(--neon-b), 0.28);
  --panel-backglow: rgba(var(--neon-r), var(--neon-g), var(--neon-b), 0.22);
  --panel-innershine: rgba(var(--neon-r), var(--neon-g), var(--neon-b), 0.18);
}

html, body{background:#000 !important;}

/* Single crisp grid on html::before, plus subtle "node" dots and a sweeping light */
html::before{
  content:"";
  position:fixed; inset:0; z-index:0; pointer-events:none;
  background-image: linear-gradient(var(--line) 1px, transparent 1px), linear-gradient(90deg, var(--line) 1px, transparent 1px);
  background-size: var(--gap) var(--gap), var(--gap) var(--gap);
  background-position: center center, center center;
  mix-blend-mode: screen;
}

/* Animated sweep light for an electric feel */
html::after{
  content:"";
  position:fixed; inset:0; z-index:0; pointer-events:none;
  background:
    linear-gradient(130deg,
      transparent 30%,
      rgba(var(--neon-r), var(--neon-g), var(--neon-b), 0.08) 50%,
      transparent 70%);
  background-size: 200% 200%;
  animation: neonSweep 7s linear infinite;
  mix-blend-mode: screen;
}
@keyframes neonSweep{
  0%{ background-position: 0% 0%; }
  100%{ background-position: 200% 200%; }
}

/* Ambient haze (very light) — optional but adds depth */
body::after{
  content:""; position:fixed; inset:0; z-index:0; pointer-events:none;
  background:
    radial-gradient(40vw 40vw at 75% 20%, var(--haze1), transparent 60%),
    radial-gradient(45vw 45vw at 25% 80%, var(--haze2), transparent 65%);
}

/* Ensure app content sits above effects */
body > *{ position:relative; z-index:1; }

/* === Neon Panel Glow (inner + backlight, no gaps) ======================== */
.panel, .card, .tile, .module, .kpi,
[class*="card"], [class*="panel"], [class*="tile"], [class*="module"], [class*="kpi"]{
  position:relative;
  border-radius:14px;
  /* Inner neon ring */
  box-shadow:
    inset 0 0 0 1px var(--panel-stroke),
    inset 0 0 14px var(--panel-innershine),
    0 0 0 0 rgba(0,0,0,0); /* placeholder so we can easily append shadows elsewhere if needed */
}

/* Backlight glow behind the element (no visible gap) */
.panel::after, .card::after, .tile::after, .module::after, .kpi::after,
[class*="card"]::after, [class*="panel"]::after, [class*="tile"]::after, [class*="module"]::after, [class*="kpi"]::after{
  content:"";
  position:absolute;
  inset: -1px;                      /* sits just outside without making a gap */
  z-index:-1;
  border-radius: inherit;
  background:
    radial-gradient(120% 120% at 50% 0%,
      var(--panel-backglow),
      rgba(var(--neon-r), var(--neon-g), var(--neon-b), 0.10) 30%,
      transparent 65%);
  filter: blur(20px);               /* soft bloom */
  pointer-events:none;
}

/* Optional: tiny top-edge shimmer for a glassy feel */
.panel::before, .card::before, .tile::before, .module::before, .kpi::before,
[class*="card"]::before, [class*="panel"]::before, [class*="tile"]::before, [class*="module"]::before, [class*="kpi"]::before{
  content:"";
  position:absolute;
  left:8px; right:8px; top:6px; height:1px;
  border-radius:2px;
  background: linear-gradient(90deg,
    transparent,
    rgba(var(--neon-r), var(--neon-g), var(--neon-b), 0.25),
    transparent);
  pointer-events:none;
  mix-blend-mode: screen;
}

</style>

<style>
/* === RISE Futuristic Theme: Black + Neon Glass ============================ */
:root{
  --gap: 88px;
  --accent-r: 64;    /* adjust to taste */
  --accent-g: 160;
  --accent-b: 255;
  --line: rgba(var(--accent-r), var(--accent-g), var(--accent-b), 0.12);
  --haze1: rgba(var(--accent-r), var(--accent-g), var(--accent-b), 0.05);
  --haze2: rgba(var(--accent-r), var(--accent-g), var(--accent-b), 0.03);
  --panel-surface: rgba(255,255,255,0.03);    /* carbon glass */
  --panel-ring: rgba(var(--accent-r), var(--accent-g), var(--accent-b), 0.38);
  --panel-bloom: rgba(var(--accent-r), var(--accent-g), var(--accent-b), 0.22);
  --panel-shine: rgba(var(--accent-r), var(--accent-g), var(--accent-b), 0.16);
}

/* Keep single crisp grid and animated sweep (already present); background is pure black */
html, body{ background:#000 !important; }

/* Optional ambient haze (very subtle, for depth) */
body::after{
  content:""; position:fixed; inset:0; z-index:0; pointer-events:none;
  background:
    radial-gradient(40vw 40vw at 70% 20%, var(--haze1), transparent 60%),
    radial-gradient(45vw 45vw at 25% 80%, var(--haze2), transparent 65%);
}

/* Content above effects */
body > *{ position:relative; z-index:1; }

/* === Panel Redesign: Carbon Glass + Neon Accent ========================== */
.panel, .card, .tile, .module, .kpi,
[class*="card"], [class*="panel"], [class*="tile"], [class*="module"], [class*="kpi"]{
  position: relative;
  border-radius: 14px;
  background: linear-gradient(180deg, rgba(255,255,255,0.04), rgba(255,255,255,0.02)) !important;
  background-color: var(--panel-surface) !important; /* fallback */
  /* Inner accent ring + subtle glass depth */
  box-shadow:
    inset 0 0 0 1px rgba(255,255,255,0.05),
    inset 0 0 0 2px rgba(var(--accent-r), var(--accent-g), var(--accent-b), 0.06),
    inset 0 12px 24px rgba(0,0,0,0.35);
  backdrop-filter: blur(8px) saturate(120%);
  -webkit-backdrop-filter: blur(8px) saturate(120%);
}

/* Neon edge (true ring) using gradient border mask (no gaps) */
.panel::before, .card::before, .tile::before, .module::before, .kpi::before,
[class*="card"]::before, [class*="panel"]::before, [class*="tile"]::before, [class*="module"]::before, [class*="kpi"]::before{
  content:"";
  position:absolute; inset:0; border-radius: inherit; pointer-events:none;
  padding:1px;
  background: linear-gradient(90deg,
    rgba(var(--accent-r), var(--accent-g), var(--accent-b), 0.0),
    rgba(var(--accent-r), var(--accent-g), var(--accent-b), 0.6),
    rgba(var(--accent-r), var(--accent-g), var(--accent-b), 0.0));
  -webkit-mask: 
    linear-gradient(#000 0 0) content-box, 
    linear-gradient(#000 0 0);
  -webkit-mask-composite: xor;
          mask-composite: exclude;
  border-radius: inherit;
}

/* Soft bloom behind the panel (tight, no visible gap) */
.panel::after, .card::after, .tile::after, .module::after, .kpi::after,
[class*="card"]::after, [class*="panel"]::after, [class*="tile"]::after, [class*="module"]::after, [class*="kpi"]::after{
  content:"";
  position:absolute; inset:0; z-index:-1; border-radius: inherit; pointer-events:none;
  background:
    radial-gradient(120% 120% at 50% 0%,
      var(--panel-bloom),
      rgba(var(--accent-r), var(--accent-g), var(--accent-b), 0.10) 30%,
      transparent 65%);
  filter: blur(18px);
  opacity: 0.9;
}

/* Subtle top shimmer for glass */
.neon-top-shimmer,
.panel .shimmer, .card .shimmer, .tile .shimmer, .module .shimmer, .kpi .shimmer{
  position:absolute; left:10px; right:10px; top:8px; height:2px; border-radius:2px; pointer-events:none;
  background: linear-gradient(90deg, transparent, rgba(255,255,255,0.45), transparent);
  mix-blend-mode: screen;
}

/* === Easy Themes: swap accent color by setting CSS variables on body ===== */
body.theme-teal{ --accent-r: 0; --accent-g: 200; --accent-b: 180; }
body.theme-violet{ --accent-r: 160; --accent-g: 120; --accent-b: 255; }
body.theme-gold{ --accent-r: 255; --accent-g: 200; --accent-b: 80; }

</style>

<style>body.theme-electric{ --accent-r: 0; --accent-g: 180; --accent-b: 255; }</style>

<style id="als-neon-chip-override">
/* === ALS Neon Status Overrides: Chips / Pills / Bands ===================== */
:root{
  --neon-green: 39,255,20;    /* #39FF14 */
  --neon-yellow: 249,255,0;   /* #F9FF00 */
  --neon-red: 255,46,99;      /* #FF2E63 */
}

/* Base style unification for chips/pills */
.score-chip, .chip, .badge, .pill, .exec-pill{
  border-radius: 999px !important;
  font-weight: 800 !important;
  letter-spacing: 0.2px;
  background: rgba(255,255,255,0.04) !important; /* subtle glass */
  border: 1px solid rgba(255,255,255,0.06) !important;
  box-shadow: inset 0 0 12px rgba(255,255,255,0.03) !important;
}

/* GREEN (Good) */
.chip-green, .exec-pill.green, .is-green{
  color: rgba(var(--neon-green), 0.95) !important;
  border-color: rgba(var(--neon-green), 0.35) !important;
  background: radial-gradient(120% 120% at 50% 0%, rgba(var(--neon-green), 0.12), rgba(255,255,255,0.03)) !important;
  text-shadow: 0 0 6px rgba(var(--neon-green), 0.35);
  box-shadow:
    0 0 14px rgba(var(--neon-green), 0.28),
    inset 0 0 8px rgba(var(--neon-green), 0.10) !important;
}

/* YELLOW / AMBER (Warning) */
.chip-yellow, .chip-amber, .exec-pill.amber, .is-yellow{
  color: rgba(var(--neon-yellow), 0.95) !important;
  border-color: rgba(var(--neon-yellow), 0.35) !important;
  background: radial-gradient(120% 120% at 50% 0%, rgba(var(--neon-yellow), 0.12), rgba(255,255,255,0.03)) !important;
  text-shadow: 0 0 6px rgba(var(--neon-yellow), 0.35);
  box-shadow:
    0 0 14px rgba(var(--neon-yellow), 0.28),
    inset 0 0 8px rgba(var(--neon-yellow), 0.10) !important;
}

/* RED (Alert) */
.chip-red, .exec-pill.red, .is-red{
  color: rgba(var(--neon-red), 0.95) !important;
  border-color: rgba(var(--neon-red), 0.38) !important;
  background: radial-gradient(120% 120% at 50% 0%, rgba(var(--neon-red), 0.12), rgba(255,255,255,0.03)) !important;
  text-shadow: 0 0 6px rgba(var(--neon-red), 0.35);
  box-shadow:
    0 0 14px rgba(var(--neon-red), 0.30),
    inset 0 0 8px rgba(var(--neon-red), 0.10) !important;
}

/* Table bands for KPI rows (if used) */
tr.band-green > td{
  background: linear-gradient(90deg, rgba(var(--neon-green), 0.065), transparent) !important;
  border-top: 1px solid rgba(var(--neon-green), 0.15) !important;
}
tr.band-yellow > td, tr.band-amber > td{
  background: linear-gradient(90deg, rgba(var(--neon-yellow), 0.065), transparent) !important;
  border-top: 1px solid rgba(var(--neon-yellow), 0.15) !important;
}
tr.band-red > td{
  background: linear-gradient(90deg, rgba(var(--neon-red), 0.065), transparent) !important;
  border-top: 1px solid rgba(var(--neon-red), 0.18) !important;
}

/* Icon accents, if status icons exist */
.icon-green, .status-green{ color: rgba(var(--neon-green), 0.95) !important; filter: drop-shadow(0 0 6px rgba(var(--neon-green), 0.35)); }
.icon-yellow, .status-yellow, .status-amber{ color: rgba(var(--neon-yellow), 0.95) !important; filter: drop-shadow(0 0 6px rgba(var(--neon-yellow), 0.35)); }
.icon-red, .status-red{ color: rgba(var(--neon-red), 0.95) !important; filter: drop-shadow(0 0 6px rgba(var(--neon-red), 0.35)); }

</style>

<style id="als-neon-kpi-banding">
/* === Neon KPI Row Banding (matches chip colors) =========================== */
/* Fallback for existing classes if the app already sets them */
tr.band-green > td{
  background: linear-gradient(90deg, rgba(39,255,20,0.06), transparent 65%) !important;
  border-top: 1px solid rgba(39,255,20,0.15) !important;
}
tr.band-yellow > td, tr.band-amber > td{
  background: linear-gradient(90deg, rgba(249,255,0,0.06), transparent 65%) !important;
  border-top: 1px solid rgba(249,255,0,0.15) !important;
}
tr.band-red > td{
  background: linear-gradient(90deg, rgba(255,46,99,0.06), transparent 65%) !important;
  border-top: 1px solid rgba(255,46,99,0.18) !important;
}

/* Modern auto-banding: detect chip color inside the row using :has() */
.kpi table tbody tr{ position: relative; }
.kpi table tbody tr::before{
  content:""; position:absolute; left:6px; top:6px; bottom:6px; width:3px; border-radius:3px; opacity:0.9; pointer-events:none;
}

/* Green rows */
.kpi table tbody tr:has(.chip-green), 
.kpi table tbody tr:has(.exec-pill.green),
.kpi table tbody tr:has(.is-green){
  background-image: linear-gradient(90deg, rgba(39,255,20,0.055), transparent 65%) !important;
}
.kpi table tbody tr:has(.chip-green)::before, 
.kpi table tbody tr:has(.exec-pill.green)::before,
.kpi table tbody tr:has(.is-green)::before{
  background: radial-gradient(60% 60% at 50% 20%, rgba(39,255,20,0.45), rgba(39,255,20,0.0));
  box-shadow: 0 0 12px rgba(39,255,20,0.35);
}

/* Yellow/Amber rows */
.kpi table tbody tr:has(.chip-yellow), 
.kpi table tbody tr:has(.chip-amber), 
.kpi table tbody tr:has(.exec-pill.amber),
.kpi table tbody tr:has(.is-yellow){
  background-image: linear-gradient(90deg, rgba(249,255,0,0.055), transparent 65%) !important;
}
.kpi table tbody tr:has(.chip-yellow)::before, 
.kpi table tbody tr:has(.chip-amber)::before, 
.kpi table tbody tr:has(.exec-pill.amber)::before,
.kpi table tbody tr:has(.is-yellow)::before{
  background: radial-gradient(60% 60% at 50% 20%, rgba(249,255,0,0.45), rgba(249,255,0,0.0));
  box-shadow: 0 0 12px rgba(249,255,0,0.35);
}

/* Red rows */
.kpi table tbody tr:has(.chip-red), 
.kpi table tbody tr:has(.exec-pill.red),
.kpi table tbody tr:has(.is-red){
  background-image: linear-gradient(90deg, rgba(255,46,99,0.055), transparent 65%) !important;
}
.kpi table tbody tr:has(.chip-red)::before, 
.kpi table tbody tr:has(.exec-pill.red)::before,
.kpi table tbody tr:has(.is-red)::before{
  background: radial-gradient(60% 60% at 50% 20%, rgba(255,46,99,0.45), rgba(255,46,99,0.0));
  box-shadow: 0 0 12px rgba(255,46,99,0.35);
}

/* Hover polish */
.kpi table tbody tr:hover{
  outline: 1px solid rgba(255,255,255,0.06);
  outline-offset: -1px;
  filter: saturate(120%);
}

</style>

<style id="als-host-flattening">
/* === Host Container Flattening (no outer neon ring/bloom) ================= */
/* Utility: add class="no-neon" to any container you want to flatten */
.no-neon{
  box-shadow: inset 0 0 0 1px rgba(255,255,255,0.04) !important;
  background: linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.02)) !important;
}
.no-neon::before,
.no-neon::after{ display:none !important; }

/* Auto-detect host panels wrapping tiles/gauges and flatten them */
.panel:has(.tiles),
.panel:has(.gauge),
.panel:has(.gauges),
.panel:has(.kpi-cards),
.panel:has(.score-tiles),
.panel:has(.mini-cards){
  box-shadow: inset 0 0 0 1px rgba(255,255,255,0.04) !important;
  background: linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.02)) !important;
}
.panel:has(.tiles)::before,
.panel:has(.gauge)::before,
.panel:has(.gauges)::before,
.panel:has(.kpi-cards)::before,
.panel:has(.score-tiles)::before,
.panel:has(.mini-cards)::before,
.panel:has(.tiles)::after,
.panel:has(.gauge)::after,
.panel:has(.gauges)::after,
.panel:has(.kpi-cards)::after,
.panel:has(.score-tiles)::after,
.panel:has(.mini-cards)::after{
  display:none !important;
}

/* Optional: thin seam highlight at inner tile boundaries for polish */
.tiles > *{
  position: relative;
}
.tiles > *::after{
  content:"";
  position:absolute;
  top:-1px; bottom:-1px; right:-1px; width:1px;
  background: linear-gradient(180deg, rgba(255,255,255,0.10), rgba(255,255,255,0.02));
  opacity: 0.25;
  pointer-events:none;
}
.tiles > *:last-child::after{ display:none; }

</style>

<style id="als-performance-polish">
/* === Section Polish: Performance & Bonus Insights ========================= */
/* Reset older blue tokens to neutral black/glass */
:root{
  --card: rgba(255,255,255,0.05);
  --border: rgba(255,255,255,0.06);
  --panel: rgba(255,255,255,0.035);
}

/* Inner tiles & chart boxes: remove heavy borders and strengthen fill */
.tiles .tile,
.chartbox,
.focusitem{
  background: linear-gradient(180deg, rgba(255,255,255,0.06), rgba(255,255,255,0.035)) !important;
  border: 1px solid rgba(255,255,255,0.05) !important;
  box-shadow: inset 0 0 0 1px rgba(255,255,255,0.02);
}
/* strip any extra rings on inner tiles; keep them clean */
.tiles .tile::before, .tiles .tile::after,
.chartbox::before, .chartbox::after,
.focusitem::before, .focusitem::after{ display:none !important; }

/* Optional subtle top-edge shimmer */
.tiles .tile .shimmer, .chartbox .shimmer{ display:none; }
.tiles .tile::after{
  content:""; position:absolute; left:10px; right:10px; top:8px; height:2px; border-radius:2px; pointer-events:none;
  background: linear-gradient(90deg, transparent, rgba(255,255,255,0.35), transparent);
  opacity:.35;
}

/* KPI header tiles (the four small summary boxes) spacing & seam separators */
.tiles{ gap: 12px !important; }
.tiles .tile + .tile{ position:relative; }
.tiles .tile + .tile::before{
  content:""; position:absolute; left:-6px; top:10px; bottom:10px; width:2px; border-radius:2px;
  background: linear-gradient(180deg, rgba(255,255,255,0.12), rgba(255,255,255,0.02));
  opacity:.18; pointer-events:none;
}

/* Chart line coloring (ApexCharts common targets) */
.apexcharts-series.apexcharts-series-0 path,
.apexcharts-series.apexcharts-series[rel="1"] path{
  stroke: var(--als-lookback) !important;
  filter: drop-shadow(0 0 6px rgba(57,199,255,.55));
  stroke-width: 3 !important;
}
.apexcharts-series.apexcharts-series-1 path,
.apexcharts-series.apexcharts-series[rel="2"] path{
  stroke: var(--als-forecast) !important;
  filter: drop-shadow(0 0 6px rgba(255,190,59,.55));
  stroke-dasharray: 6 8 !important;
  stroke-width: 3 !important;
}

/* Dotted gridlines softer */
.apexcharts-gridline{ stroke: rgba(255,255,255,0.18) !important; }

</style>

<style id="als-perf-futuristic-colors">
/* === Futuristic Color Polish: Performance Section ======================== */
:root{
  /* already defined elsewhere, but ensure fallback */
  --als-lookback: #39c7ff;
  --als-forecast: #ffbe3b;
}

/* Big chart container glow framing */
.chartbox{
  position: relative;
  overflow: hidden;
  background:
    radial-gradient(120% 100% at 0% 0%, rgba(57,199,255,0.05), transparent 50%),
    radial-gradient(120% 100% at 100% 0%, rgba(255,190,59,0.05), transparent 50%),
    linear-gradient(180deg, rgba(255,255,255,0.04), rgba(255,255,255,0.03)) !important;
}

/* Animated neon sweep across the chartbox */
.chartbox::after{
  content:"";
  position:absolute; inset:-40%; z-index:0; pointer-events:none;
  background: conic-gradient(from 0deg, transparent 65%, rgba(57,199,255,0.08), rgba(255,190,59,0.08), transparent 85%);
  animation: chartSweep 12s linear infinite;
  filter: blur(20px);
}
@keyframes chartSweep{
  0%{ transform: rotate(0deg); }
  100%{ transform: rotate(360deg); }
}

/* Corner glyphs (subtle futuristic brackets) */
.chartbox::before{
  content:"";
  position:absolute; inset:10px; pointer-events:none; z-index:1;
  border-radius:14px;
  --c: rgba(255,255,255,0.10);
  background:
    /* TL */ radial-gradient(12px 12px at 0% 0%, var(--c) 2px, transparent 3px),
    linear-gradient(90deg, var(--c), transparent 40%) top left / 50px 1px no-repeat,
    linear-gradient(180deg, var(--c), transparent 40%) top left / 1px 40px no-repeat,
    /* TR */ radial-gradient(12px 12px at 100% 0%, var(--c) 2px, transparent 3px),
    linear-gradient(270deg, var(--c), transparent 40%) top right / 50px 1px no-repeat,
    linear-gradient(180deg, var(--c), transparent 40%) top right / 1px 40px no-repeat,
    /* BL */ radial-gradient(12px 12px at 0% 100%, var(--c) 2px, transparent 3px),
    linear-gradient(90deg, var(--c), transparent 40%) bottom left / 50px 1px no-repeat,
    linear-gradient(0deg, var(--c), transparent 40%) bottom left / 1px 40px no-repeat,
    /* BR */ radial-gradient(12px 12px at 100% 100%, var(--c) 2px, transparent 3px),
    linear-gradient(270deg, var(--c), transparent 40%) bottom right / 50px 1px no-repeat,
    linear-gradient(0deg, var(--c), transparent 40%) bottom right / 1px 40px no-repeat;
  mix-blend-mode: screen;
  opacity:.35;
}

/* Ensure chart inner SVGs sit above the background glows */
.chartbox > *{ position: relative; z-index: 2; }

/* ApexCharts: axis & grid colors */
.apexcharts-gridline{ stroke: rgba(255,255,255,0.18) !important; }
.apexcharts-xaxis text, .apexcharts-yaxis text{ fill: rgba(255,255,255,0.75) !important; }

/* Trend lines reinforced to match legend (cyan solid, amber dashed) */
.apexcharts-series.apexcharts-series-0 path,
.apexcharts-series.apexcharts-series[rel="1"] path{
  stroke: var(--als-lookback) !important;
  filter: drop-shadow(0 0 6px rgba(57,199,255,.6));
  stroke-width: 3 !important;
}
.apexcharts-series.apexcharts-series-1 path,
.apexcharts-series.apexcharts-series[rel="2"] path{
  stroke: var(--als-forecast) !important;
  filter: drop-shadow(0 0 6px rgba(255,190,59,.6));
  stroke-dasharray: 6 10 !important;
  stroke-width: 3 !important;
}

/* Focus items: left neon spine + hover sheen */
.focusitem{
  position: relative;
  background: linear-gradient(180deg, rgba(255,255,255,0.05), rgba(255,255,255,0.035)) !important;
  border: 1px solid rgba(255,255,255,0.05) !important;
}
.focusitem::before{
  content:"";
  position:absolute; left:10px; top:10px; bottom:10px; width:3px; border-radius:3px;
  background: linear-gradient(180deg, var(--als-lookback), var(--als-forecast));
  filter: drop-shadow(0 0 10px rgba(57,199,255,0.4));
  opacity:.8;
}
.focusitem:hover{
  box-shadow: 0 0 14px rgba(57,199,255,0.08), inset 0 0 0 1px rgba(255,255,255,0.06);
}
.focusitem:hover::after{
  content:""; position:absolute; left:14px; right:12px; top:8px; height:2px; border-radius:2px;
  background: linear-gradient(90deg, rgba(255,255,255,0.4), transparent);
  opacity:.35; pointer-events:none;
}

/* Section header: thin cyan/amber micro-underline */
.panel h2, .panel h3{
  position: relative;
}
.panel h2::after, .panel h3::after{
  content:""; position:absolute; left:0; right:0; bottom:-6px; height:2px; border-radius:2px;
  background: linear-gradient(90deg, var(--als-lookback), var(--als-forecast));
  opacity:.35;
}

/* Make inner tiles (the small KPI summary cards) feel crisper here */
.tiles .tile{
  background: linear-gradient(180deg, rgba(255,255,255,0.065), rgba(255,255,255,0.04)) !important;
  border: 1px solid rgba(255,255,255,0.06) !important;
  box-shadow: inset 0 0 0 1px rgba(255,255,255,0.02);
}
.tiles .tile .big{ text-shadow: 0 0 8px rgba(255,255,255,0.15); }


</style>
</head>
<body class="theme-electric"><header>
<h1>Adaptive Leadership Scorecards</h1>
<button class="tab active" data-tab="admin">Admin</button>
<button class="tab" data-tab="manager">Manager</button>
<button class="tab" data-tab="exec">Executive</button>
<button class="btn" id="refreshSeeds">Refresh Seeds</button>
</header>
<main>
<section id="admin">
<h2>Admin Builder</h2>
<div id="builder">
<!-- Column 1: Seed Library -->
<div class="panel">
<div class="small muted">Composite Library</div>
<select id="compLib">
<option>Safety Integrity &amp; Culture</option>
<option>Servant Leadership &amp; Development</option>
<option>Operational Delivery &amp; Quality</option>
<option>Regulatory Compliance &amp; Governance</option>
<option>People &amp; Resource Stewardship</option>
<option>CI Culture &amp; Improvement</option>
</select>
<div class="hr"></div>
<div class="small muted">KPI Seeds</div>
<div class="list" id="kpiSeeds"></div>
</div>
<!-- Column 2: Build Queue + Assignments -->
<div class="panel">
<div class="row-mid" style="flex-wrap:wrap">
<div class="small muted">Composite Name</div>
<input id="compName" placeholder="Optional — auto-uses pillar name" style="flex:1;min-width:260px"/>
<button class="btn" id="publishSelected">Publish Selected</button>
<button class="btn" id="clearQueue">Clear Queue</button>
</div>
<div class="hr"></div>
<div class="small muted">Assignment (optional)</div>
<div class="panel" id="assignBar" style="padding:8px;display:grid;grid-template-columns:220px 1fr auto;gap:8px">
<div>
<div class="small muted">Assign Type</div>
<select id="assignType">
<option value="GLOBAL">GLOBAL (applies to all)</option>
<option value="SITE">SITE</option>
<option value="DEPT">DEPT</option>
<option value="POSITION">POSITION</option>
</select>
</div>
<div>
<div class="small muted">Pick values</div>
<div class="row-mid" id="assignList" style="flex-wrap:wrap"></div>
</div>
<div style="display:flex;align-items:flex-end">
<button class="btn" id="applyAssignAll">Apply to Queue</button>
</div>
</div>
<div class="hr"></div>
<div class="small muted">Build Queue</div>
<div class="list" id="buildList"><div class="small muted">Nothing added yet.</div></div>
</div>
<!-- Column 3: Global Bonus Settings side panel -->
<div class="panel" id="bonusSettingsPanel">
<div class="small muted">Global Bonus Settings</div>
<div class="hr"></div>
<div class="small muted">Full Bonus (% of base)</div>
<input id="bs_fullPct" step="0.1" type="number" value="12"/>
<div class="small muted" style="margin-top:8px">Pro‑rate inside band?</div>
<select id="bs_prorate">
<option selected="" value="true">Yes</option>
<option value="false">No</option>
</select>
<div class="small muted" style="margin-top:8px">Target Score (info)</div>
<input id="bs_target" step="1" type="number" value="90"/>
<div class="hr" style="margin:10px 0"></div>
<div class="small muted">Band Thresholds — R/Y/G</div>
<div class="small">Red &lt; <input id="bs_red" step="1" style="width:64px" type="number" value="50"/></div>
<div class="small">(removed) <input id="bs_amber" step="1" style="width:64px" type="number" value="50"/></div>
<div class="small">Yellow ≥ <input id="bs_yellow" step="1" style="width:64px" type="number" value="75"/></div>
<div class="small">Green ≥ <input id="bs_green" step="1" style="width:64px" type="number" value="100"/></div>
<div class="hr" style="margin:10px 0"></div>
<div class="small muted">Payout by Band (% of full bonus)</div>
<div class="small">Red: <input id="bp_red" step="1" style="width:64px" type="number" value="0"/></div>
<div class="small">Amber: <input id="bp_amber" step="1" style="width:64px" type="number" value="25"/></div>
<div class="small">Yellow: <input id="bp_yellow" step="1" style="width:64px" type="number" value="60"/></div>
<div class="small">Green: <input id="bp_green" step="1" style="width:64px" type="number" value="100"/></div>
<div class="hr" style="margin:10px 0"></div>
<div class="small muted">Pay Bands — STI/LTI Split (% of total bonus)</div>
<div class="list" id="bandsEditor" style="margin-top:6px"></div>
<div class="row-mid" style="gap:8px;flex-wrap:wrap;margin-top:6px">
<button class="btn" id="bands_add">Add Band</button>
<button class="btn" id="bands_reset">Reset Default Bands</button>
</div>
<div class="small muted" id="bs_preview" style="margin-top:6px">Green ≥100 → 100% payout of full bonus</div>
</div>
</div>
</section>
<section id="manager" style="display:none">
<h2>Manager Scorecard</h2>
<div class="row-mid" style="flex-wrap:wrap;gap:12px"><div class="small muted">Manager</div><select id="mgrSelect"><option selected="">Jordan Lee</option></select></div>
<div class="hr"></div>
<div data-fixed="1" id="compositeCards"></div>
<div class="panel" style="margin-top:12px">
<div class="small muted">Bonus Projection</div>
<div class="small muted" id="mgr_bonus_summary">—</div>
</div>
<!-- Insights addendum -->
<section class="panel" id="mgrInsights" style="margin-top:12px">
<div class="row-mid" style="justify-content:space-between;flex-wrap:wrap">
<h3 style="margin:0">Performance &amp; Bonus Insights</h3>
<div class="perf-legend" style="position:absolute;right:18px;top: 1pt;display:inline-flex;gap:14px;padding:6px 12px;border-radius:18px;background:rgba(10,20,30,0.45);backdrop-filter:blur(4px);-webkit-backdrop-filter:blur(4px);border:1px solid rgba(68,116,178,0.28);box-shadow:0 0 0 1px rgba(255,255,255,0.05) inset,0 6px 18px rgba(0,0,0,0.35),0 0 22px rgba(20,211,255,0.10);align-items:center;z-index:6;">
  <span class="chip" style="display:inline-flex;align-items:center;gap:8px;padding:4px 10px;border-radius:14px;background:rgba(22,32,44,0.35);border:1px solid rgba(93,152,255,0.18);color:#d6eaff;font-weight:600;font-size:12.5px;letter-spacing:.2px;"><span class="dot" style="width:9px;height:9px;border-radius:999px;display:inline-block;box-shadow:0 0 8px #22d3ee,0 0 16px #22d3ee;background:#22d3ee;"></span>Lookback</span>
  <span class="chip" style="display:inline-flex;align-items:center;gap:8px;padding:4px 10px;border-radius:14px;background:rgba(22,32,44,0.35);border:1px solid rgba(93,152,255,0.18);color:#d6eaff;font-weight:600;font-size:12.5px;letter-spacing:.2px;"><span class="dot" style="width:9px;height:9px;border-radius:999px;display:inline-block;box-shadow:0 0 8px #fbbf24,0 0 16px #fbbf24;background:#fbbf24;"></span>Forecast</span>
</div>

</div>
<div class="tiles" style="margin-top:8px">
<div class="tile"><div class="small muted">Current Overall</div><div class="big" id="tile_now">—</div><div class="small muted" id="tile_band">—</div></div>
<div class="tile"><div class="small muted">12‑Week Change</div><div class="big" id="tile_delta">—</div><div class="small muted">vs prior 12 weeks</div></div>
<div class="tile"><div class="small muted">Forecast (12w)</div><div class="big" id="tile_fore">—</div><div class="small muted">continuation path</div></div>
<div class="tile"><div class="small muted">Projected Bonus</div><div class="big" id="tile_bonus">—</div><div class="small muted" id="tile_split">—</div></div>
</div>
<div class="chartbox" style="margin-top:10px">
<div class="small muted">Overall Score — 12‑week lookback &amp; 12‑week forecast</div>
<svg id="trendSVG" preserveaspectratio="none" style="width:100%;height:180px" viewbox="0 0 600 180"></svg>
</div>
<div style="margin-top:10px">
<div class="small muted">Focus Areas (biggest lift to reach target)</div>
<div class="focuslist" id="focusList"></div>
</div>
</section>
</section>
<section id="exec" style="display:none">
<h2>Executive Roll‑Up</h2><div class="exec-muted" style="margin:6px 0 12px 0"><button class="exec-btn" id="seedExec">Seed Exec Demo</button> • Seeds 12 managers across regions/depts/sites/positions.</div>
<div class="exec-card">
<div class="exec-grid exec-cols-3">
<label class="exec-muted">Region
          <select id="exRegion"></select>
</label>
<label class="exec-muted">Department
          <select id="exDept"></select>
</label>
<label class="exec-muted">Site
          <select id="exSite"></select>
</label>
</div>
<div class="exec-grid exec-cols-2" style="margin-top:8px">
<label class="exec-muted">Position
          <select id="exPos"></select>
</label>
<div class="exec-muted">Choose “All …” to roll up.</div>
</div>
</div>
<div class="exec-grid exec-cols-3">
<div class="exec-card">
<h3 style="margin:0 0 8px 0">Avg Weighted Total</h3>
<div id="exAvg" style="font-size:32px;font-weight:800;margin-top:10px">—</div>
<div class="exec-muted" id="exBand">Band: —</div>
</div>
<div class="exec-card">
<h3 style="margin:0 0 8px 0">Tier Distribution</h3>
<div id="exTiers" style="display:flex;gap:8px;flex-wrap:wrap"></div>
</div>
<div class="exec-card">
<h3 style="margin:0 0 8px 0">Managers Included</h3>
<div class="exec-muted" id="exCount">—</div>
</div>
</div>
<div class="exec-grid exec-cols-2">
<div class="exec-card">
<h3 style="margin:0 0 8px 0">Pillar Heatmap</h3>
<table class="exec-table" id="exPillars">
<thead><tr><th>Pillar</th><th>Avg Score</th><th>Band</th></tr></thead>
<tbody></tbody>
</table>
</div>
<div class="exec-card">
<h3 style="margin:0 0 8px 0">Top Leaders</h3>
<div id="exLeaders"></div>
</div>
</div>
</section>
</main>
<script>
  const SETTINGS = { bands:{ red:50, amber:75, yellow:90, green:100 } };
</script>
<script>
(function(){
  /* === Minimal state/utility === */
  let BUILD=[], SCORECARD=[], MANAGERS=[]; 
  const SETTINGS={target:90, bonus:{}};
  const $=id=>document.getElementById(id);
  function normalizeBuild(){ if(!BUILD.length) return; let s=BUILD.reduce((a,b)=>a+(+b.w||0),0)||1; BUILD.forEach(k=>k.w=+(k.w/s).toFixed(4)); }
  function bandFromScore(s){ return s>=100?'green':s>=75?'yellow':s>=50?'amber':'red'; }
  function kpiScore(k, raw){
  if(raw==null||isNaN(raw)) return 0;
  const clamp=(v,lo,hi)=> Math.max(lo, Math.min(hi, v));
  const lerp=(a,b,t)=> a + (b-a)*t;
  if(k.dir==='HigherBetter'){
    if(raw>=k.g) return 100;
    if(raw>=k.y){ const t=(raw-k.y)/Math.max(1e-9,(k.g-k.y)); return lerp(75,100, clamp(t,0,1)); }
    if(raw>=k.r){ const t=(raw-k.r)/Math.max(1e-9,(k.y-k.r)); return lerp(25,75, clamp(t,0,1)); }
    const t = (k.r<=0)? 0 : clamp(raw/k.r, 0, 1);
    return lerp(0,25,t);
  } else {
    if(raw<=k.g) return 100;
    if(raw<=k.y){ const t=(k.y-raw)/Math.max(1e-9,(k.y-k.g)); return lerp(75,100, clamp(t,0,1)); }
    if(raw<=k.r){ const t=(k.r-raw)/Math.max(1e-9,(k.r-k.y)); return lerp(25,75, clamp(t,0,1)); }
    const span = Math.max(1e-9, (k.r));
    return lerp(0,25, 1 - Math.min(1, (raw-k.r)/(span*2)) );
  }
}
  const PILLAR_LIST = [
    'Safety Integrity & Culture','Servant Leadership & Development','Operational Delivery & Quality',
    'Regulatory Compliance & Governance','People & Resource Stewardship','CI Culture & Improvement'
  ];
  const SITES = ['Wilmington Shop','Chicago Yard','Los Angeles Terminal','New Orleans','Seattle Base'];
  const DEPTS = ['Mechanical','Operations','Medical Services','Safety','CI Office'];
  const POSITIONS = ['Manager','Supervisor','Technician','RN','Safety Specialist'];

  const SEED_HTML = {
    "Safety Integrity & Culture": `
      <div class="seed-header small muted">KPI • Dir • R/Y/G • Weight • Add</div>
      ${[
        ['Psychological Safety Pulse','HigherBetter',3.0,3.6,4.2,20],
        ['Voice→Action Ratio','HigherBetter',0.5,0.7,0.85,20],
        ['Anonymous Feedback Participation %','HigherBetter',30,45,60,20],
        ['Speak‑Up Follow‑Through %','HigherBetter',55,70,85,20],
        ['Safety Trust Index','HigherBetter',2.4,3.2,3.8,20]
      ].map(([n,d,r,y,g,w])=>`
        <div class="seed-row" data-name="${n}" data-dir="${d}" data-r="${r}" data-y="${y}" data-g="${g}" data-w="${w}">
          <div class="top"><div class="kpill">${n}</div></div>
          <div class="meta">
            <div class="small muted">${d} • ${r} / ${y} / ${g}</div>
            <div class="row-mid"><span class="small muted">Weight %</span><input type="number" step="0.5" value="${w}"/></div>
            <button class="btn">Add</button>
          </div>
        </div>`).join('')}
    `,
    "Servant Leadership & Development": `
      <div class="seed-header small muted">KPI • Dir • R/Y/G • Weight • Add</div>
      ${[
        ['1:1 Coaching Completion %','HigherBetter',50,70,90,25],
        ['Action Closeout On‑Time %','HigherBetter',60,75,90,25],
        ['Gemba Walk Frequency / wk','HigherBetter',0.8,1.5,2.0,25],
        ['Recognition Moments / FTE / mo','HigherBetter',0.3,0.6,1.2,25]
      ].map(([n,d,r,y,g,w])=>`
        <div class="seed-row" data-name="${n}" data-dir="${d}" data-r="${r}" data-y="${y}" data-g="${g}" data-w="${w}">
          <div class="top"><div class="kpill">${n}</div></div>
          <div class="meta">
            <div class="small muted">${d} • ${r} / ${y} / ${g}</div>
            <div class="row-mid"><span class="small muted">Weight %</span><input type="number" step="0.5" value="${w}"/></div>
            <button class="btn">Add</button>
          </div>
        </div>`).join('')}
    `,
    "Operational Delivery & Quality": `
      <div class="seed-header small muted">KPI • Dir • R/Y/G • Weight • Add</div>
      ${[
        ['Throughput Δ % vs Plan','HigherBetter',-5,0,3,34],
        ['Rework / Defect Rate %','LowerBetter',8,5,2,33],
        ['First‑Pass Yield %','HigherBetter',85,93,98,33]
      ].map(([n,d,r,y,g,w])=>`
        <div class="seed-row" data-name="${n}" data-dir="${d}" data-r="${r}" data-y="${y}" data-g="${g}" data-w="${w}">
          <div class="top"><div class="kpill">${n}</div></div>
          <div class="meta">
            <div class="small muted">${d} • ${r} / ${y} / ${g}</div>
            <div class="row-mid"><span class="small muted">Weight %</span><input type="number" step="0.5" value="${w}"/></div>
            <button class="btn">Add</button>
          </div>
        </div>`).join('')}
    `,
    "Regulatory Compliance & Governance": `
      <div class="seed-header small muted">KPI • Dir • R/Y/G • Weight • Add</div>
      ${[
        ['Audit Conformance %','HigherBetter',85,93,98,34],
        ['Repeat Findings Rate %','LowerBetter',15,9,4,33],
        ['Timely Corrective Actions %','HigherBetter',70,82,92,33]
      ].map(([n,d,r,y,g,w])=>`
        <div class="seed-row" data-name="${n}" data-dir="${d}" data-r="${r}" data-y="${y}" data-g="${g}" data-w="${w}">
          <div class="top"><div class="kpill">${n}</div></div>
          <div class="meta">
            <div class="small muted">${d} • ${r} / ${y} / ${g}</div>
            <div class="row-mid"><span class="small muted">Weight %</span><input type="number" step="0.5" value="${w}"/></div>
            <button class="btn">Add</button>
          </div>
        </div>`).join('')}
    `,
    "People & Resource Stewardship": `
      <div class="seed-header small muted">KPI • Dir • R/Y/G • Weight • Add</div>
      ${[
        ['Absence Rate %','LowerBetter',8,6,4,25],
        ['Overtime Utilization %','LowerBetter',18,12,8,25],
        ['Training Currency %','HigherBetter',75,88,95,25],
        ['Vacancy Fill Time (days)','LowerBetter',60,45,30,25]
      ].map(([n,d,r,y,g,w])=>`
        <div class="seed-row" data-name="${n}" data-dir="${d}" data-r="${r}" data-y="${y}" data-g="${g}" data-w="${w}">
          <div class="top"><div class="kpill">${n}</div></div>
          <div class="meta">
            <div class="small muted">${d} • ${r} / ${y} / ${g}</div>
            <div class="row-mid"><span class="small muted">Weight %</span><input type="number" step="0.5" value="${w}"/></div>
            <button class="btn">Add</button>
          </div>
        </div>`).join('')}
    `,
    "CI Culture & Improvement": `
      <div class="seed-header small muted">KPI • Dir • R/Y/G • Weight • Add</div>
      ${[
        ['Ideas Submitted / 100 FTE','HigherBetter',6,12,20,20],
        ['Ideas Implemented %','HigherBetter',25,45,65,20],
        ['Idea→Action Lead Time (days)','LowerBetter',45,30,14,15],
        ['Countermeasure Sustainment @90d %','HigherBetter',55,70,85,20],
        ['PI Participation (unique / mo)','HigherBetter',8,14,22,15],
        ['Experiment→Impact Ratio','HigherBetter',0.6,0.9,1.2,10]
      ].map(([n,d,r,y,g,w])=>`
        <div class="seed-row" data-name="${n}" data-dir="${d}" data-r="${r}" data-y="${y}" data-g="${g}" data-w="${w}">
          <div class="top"><div class="kpill">${n}</div></div>
          <div class="meta">
            <div class="small muted">${d} • ${r} / ${y} / ${g}</div>
            <div class="row-mid"><span class="small muted">Weight %</span><input type="number" step="0.5" value="${w}"/></div>
            <button class="btn">Add</button>
          </div>
        </div>`).join('')}
    `
  };

  // Helper funcs that need DOM
  function showSeeds(){ const sel=$('compLib'); const host=$('kpiSeeds'); if(!sel||!host) return; const pillar=sel.value; host.innerHTML = SEED_HTML[pillar] || '<div class="small muted">No seeds.</div>'; }
  function renderAssignList(){
    const typeEl=$('assignType'); const host=$('assignList'); if(!typeEl||!host) return;
    const t=typeEl.value; host.innerHTML='';
    const items = t==='SITE' ? SITES : t==='DEPT' ? DEPTS : t==='POSITION' ? POSITIONS : [];
    if(!items.length){ host.innerHTML = '<span class="small muted">Global (no selection needed)</span>'; return; }
    items.forEach(v=>{
      const id='chk_'+t+'_'+v.replace(/\s+/g,'_');
      const wrap=document.createElement('label'); wrap.className='row-mid'; wrap.style.gap='6px';
      wrap.innerHTML=`<input type="checkbox" id="${id}" value="${v}"><span class="small">${v}</span>`;
      host.appendChild(wrap);
    });
  }
  function addToBuild(seed){
    for(let i=0;i<BUILD.length;i++){
      const k=BUILD[i];
      if(k.pillar===seed.pillar && k.name===seed.name && (k.assignType||'GLOBAL')===(seed.assignType||'GLOBAL') && JSON.stringify((k.assignValues||[]).sort())===JSON.stringify((seed.assignValues||[]).sort())){
        BUILD[i]={...k,w:seed.w}; normalizeBuild(); renderBuild(); return;
      }
    }
    BUILD.push(seed); normalizeBuild(); renderBuild();
  }
  function currentAssignment(){
    const t=$('assignType')?.value||'GLOBAL';
    if(t==='GLOBAL') return {type:'GLOBAL',values:[]};
    const checks = Array.from(($('assignList')||document.createElement('div')).querySelectorAll('input[type=checkbox]:checked'));
    return {type:t, values:checks.map(c=>c.value)};
  }
  function renderBuild(){
    const host=$('buildList'); if(!host) return;
    host.innerHTML='';
    if(!BUILD.length){ host.innerHTML='<div class="small muted">Nothing added yet.</div>'; return; }
    normalizeBuild();
    BUILD.forEach((k,i)=>{
      const chips=(k.assignType && k.assignType!=='GLOBAL') ? (k.assignValues||[]).map(v=>`<span class="small" style="padding:2px 6px;border:1px solid var(--border);border-radius:8px">${k.assignType}:${v}</span>`).join(' ')
        : '<span class="small muted">GLOBAL</span>';
      const row=document.createElement('div'); row.className='row-mid'; row.style.flexWrap='wrap';
      row.innerHTML = `<div style="min-width:260px">${k.pillar} — <b>${k.name}</b></div>
        <div class="small muted">${k.dir}</div>
        <div class="small">R/Y/G: ${k.r}/${k.y}/${k.g}</div>
        <div class="row-mid" style="gap:6px">${chips}</div>
        <input style="min-width:90px" type="number" step="0.5" value="${(k.w*100).toFixed(1)}" title="weight %"/>
        <button class="btn">✕</button>`;
      row.querySelector('button').onclick=()=>{ BUILD.splice(i,1); renderBuild(); };
      row.querySelector('input').onchange=(e)=>{ const v=parseFloat(e.target.value)||0; BUILD[i].w=v/100; renderBuild(); };
      host.appendChild(row);
    });
    const totPct=(BUILD.reduce((a,b)=>a+(b.w*100),0)).toFixed(1);
    const footer=document.createElement('div'); footer.className='row-mid';
    footer.innerHTML = `<span class="small muted">Weight total:</span><b>${totPct}%</b><span class="small muted"> (auto‑balanced)</span>`;
    host.appendChild(footer);
  }
  function kpiVisibleInContext(k){ return true; }

  // Bonus settings (+pay bands) — same as previous build, guarded for null el
  const BONUS_DEFAULT = {
    fullPct: 12, prorate: true, target: 90,
    thresholds: { red:50, amber:50, yellow:75, green:100 },
    payoutPct: { red:0, amber:25, yellow:60, green:100 },
    bands: [
      { name:'Band A – Non‑Exempt', sti:100, lti:0 },
      { name:'Band B – Manager',    sti:80,  lti:20 },
      { name:'Band C – Director',   sti:60,  lti:40 },
      { name:'Band D – VP',         sti:40,  lti:60 },
      { name:'Band E – SVP/EVP',    sti:30,  lti:70 }
    ]
  };
  function loadBonusSettings(){ try{ const s=JSON.parse(localStorage.getItem('RISE_BONUS_SETTINGS')||'null'); SETTINGS.bonus = s? {...BONUS_DEFAULT, ...s} : {...BONUS_DEFAULT}; }catch{ SETTINGS.bonus={...BONUS_DEFAULT}; } }
  function saveBonusSettings(){ try{ localStorage.setItem('RISE_BONUS_SETTINGS', JSON.stringify(SETTINGS.bonus)); }catch{} }
  function bonusPreview(){ const el=$('bs_preview'); if(!el) return; const b=SETTINGS.bonus; el.textContent=`Bands: Red<${b.thresholds.red} • Amber≥${b.thresholds.amber} • Yellow≥${b.thresholds.yellow} • Green≥${b.thresholds.green} • Payouts: R ${b.payoutPct.red}% / A ${b.payoutPct.amber}% / Y ${b.payoutPct.yellow}% / G ${b.payoutPct.green}% of full`; }
  function uiFromBonus(){
    const b=SETTINGS.bonus, set=(id,val)=>{ const el=$(id); if(el) el.value=val; };
    set('bs_fullPct', b.fullPct); set('bs_prorate', b.prorate?'true':'false'); set('bs_target', b.target);
    set('bs_red', b.thresholds.red); set('bs_amber', b.thresholds.amber); set('bs_yellow', b.thresholds.yellow); set('bs_green', b.thresholds.green);
    set('bp_red', b.payoutPct.red); set('bp_amber', b.payoutPct.amber); set('bp_yellow', b.payoutPct.yellow); set('bp_green', b.payoutPct.green);
    renderBandsEditor(); populateMgrBand(); bonusPreview();
  }
  function uiToBonus(){
    const num=id=>+($(id)?.value||0), sel=id=>($(id)?.value)||'';
    SETTINGS.bonus.fullPct=num('bs_fullPct'); SETTINGS.bonus.prorate = sel('bs_prorate')==='true'; SETTINGS.bonus.target=num('bs_target');
    SETTINGS.bonus.thresholds={ red:num('bs_red'), amber:num('bs_amber'), yellow:num('bs_yellow'), green:num('bs_green') };
    SETTINGS.bonus.payoutPct={ red:num('bp_red'), amber:num('bp_amber'), yellow:num('bp_yellow'), green:num('bp_green') };
    bonusPreview(); saveBonusSettings(); renderManager();
  }
  function renderBandsEditor(){
    const host=$('bandsEditor'); if(!host) return;
    host.innerHTML='';
    SETTINGS.bonus.bands.forEach((b,i)=>{
      const row=document.createElement('div'); row.className='row-mid'; row.style.flexWrap='wrap';
      row.innerHTML=`
        <input class="band_name" data-i="${i}" value="${b.name}" style="min-width:200px;flex:1">
        <span class="small muted">STI%</span><input class="band_sti" data-i="${i}" type="number" step="1" value="${b.sti}" style="width:70px">
        <span class="small muted">LTI%</span><input class="band_lti" data-i="${i}" type="number" step="1" value="${b.lti}" style="width:70px">
        <button class="btn band_del" data-i="${i}">✕</button>`;
      host.appendChild(row);
    });
    const syncPct=i=>{
      const sti=+document.querySelector(`.band_sti[data-i="${i}"]`)?.value||0;
      let lti=+document.querySelector(`.band_lti[data-i="${i}"]`)?.value||0;
      if(sti+lti!=100){ lti=Math.max(0,100-sti); const l=document.querySelector(`.band_lti[data-i="${i}"]`); if(l) l.value=lti; }
      SETTINGS.bonus.bands[i].sti=+sti; SETTINGS.bonus.bands[i].lti=+lti; saveBonusSettings(); renderManager();
    };
    host.querySelectorAll('.band_name').forEach(el=> el.onchange=e=>{ const i=+e.target.dataset.i; SETTINGS.bonus.bands[i].name=e.target.value; saveBonusSettings(); populateMgrBand(); });
    host.querySelectorAll('.band_sti').forEach(el=> el.onchange=e=> syncPct(+e.target.dataset.i));
    host.querySelectorAll('.band_lti').forEach(el=> el.onchange=e=> syncPct(+e.target.dataset.i));
    host.querySelectorAll('.band_del').forEach(el=> el.onclick=e=>{ const i=+e.target.dataset.i; SETTINGS.bonus.bands.splice(i,1); saveBonusSettings(); renderBandsEditor(); populateMgrBand(); renderManager(); });
  }
  function populateMgrBand(){
    const sel=$('mgrBand'); if(!sel) return;
    const cur=sel.value; sel.innerHTML='';
    SETTINGS.bonus.bands.forEach(b=>{ const o=document.createElement('option'); o.value=b.name; o.textContent=b.name; sel.appendChild(o); });
    sel.value = SETTINGS.bonus.bands.find(b=>b.name===cur)?.name || (SETTINGS.bonus.bands[0]?.name||'');
    sel.onchange=renderManager;
  }
  function bandForScoreBonus(s,thr){ if(s>=thr.green) return 'green'; if(s>=thr.yellow) return 'yellow'; if(s>=thr.amber) return 'amber'; return 'red'; }
  function payoutForScore(s){
    const b=SETTINGS.bonus, thr=b.thresholds, pay=b.payoutPct;
    const band = bandForScoreBonus(s, thr);
    if(!b.prorate) return pay[band];
    const lerp=(lo,hi,plo,phi)=>{ if(hi<=lo) return phi; const t=Math.max(0,Math.min(1,(s-lo)/(hi-lo))); return +(plo+t*(phi-plo)); };
    if(band==='red') return pay.red;
    if(band==='amber') return lerp(thr.red, thr.yellow, pay.red, pay.amber);
    if(band==='yellow') return lerp(thr.yellow, thr.green, pay.amber, pay.yellow);
    return pay.green;
  }
  function computeVisibleOverallScore(mgr){
    const byName = {}; (SCORECARD||[]).forEach(c=> byName[c.pillar]=c);
    let sum=0,cnt=0;
    PILLAR_LIST.forEach(p=>{
      const c=byName[p]; if(!c) return;
      const vis=c.kpis.filter(k=> kpiVisibleInContext(k));
      if(!vis.length) return;
      const sc=vis.reduce((a,k)=>{ const raw=(mgr.kpiRaw[c.pillar]||{})[k.name]; return a + (kpiScore(k,raw)*(k.w||0)); },0);
      sum+=sc; cnt+=1;
    });
    return cnt ? +(sum/cnt).toFixed(1) : 0;
  }
  function bonusSummary(){
    const idx=parseInt(($('mgrSelect')?.value||0),10); const m=MANAGERS[idx]||MANAGERS[0]; if(!m) return;
    const overall=computeVisibleOverallScore(m);
    const pctOfFull=payoutForScore(overall);
    const fullPct=SETTINGS.bonus.fullPct;
    const totalBasePct=+((fullPct*(pctOfFull/100))).toFixed(2);
    const bandName=($('mgrBand')?.value)||(SETTINGS.bonus.bands[0]?.name||'');
    const band=SETTINGS.bonus.bands.find(b=>b.name===bandName)||{sti:100,lti:0};
    const stiPctBase=+((totalBasePct*band.sti/100)).toFixed(2);
    const ltiPctBase=+((totalBasePct*band.lti/100)).toFixed(2);
    const el=$('mgr_bonus_summary'); if(el) el.textContent=`Overall: ${overall}% • Payout: ${pctOfFull}% of full → ≈ ${totalBasePct}% of base (full ${fullPct}%).  Pay Band: ${bandName} → STI ≈ ${stiPctBase}% of base, LTI ≈ ${ltiPctBase}% of base.`;
  }

  // Insights
  function getOverallHistory(mgr){ return (mgr?.history||[]).map(h=> +((h.total)).toFixed(1)); }
  function forecastNextPoints(history,n=12){
    const T=SETTINGS.bonus.target||90; const pts=history.slice(-12); const recent=pts.slice(-4);
    let slope=0; if(recent.length>=2){ const x=recent.map((_,i)=>i), y=recent; const n2=recent.length;
      const sx=x.reduce((a,b)=>a+b,0), sy=y.reduce((a,b)=>a+b,0), sxy=x.reduce((a,xi,i)=>a+xi*y[i],0), sxx=x.reduce((a,xi)=>a+xi*xi,0);
      const denom=(n2*sxx-sx*sx)||1; slope=(n2*sxy - sx*sy)/denom;
    }
    const out=[]; let cur=pts[pts.length-1] ?? 75;
    for(let i=0;i<n;i++){ const pull=(T-cur)*0.25/12; cur=cur+slope+pull+(Math.random()-0.5)*0.6; cur=Math.max(0,Math.min(110,cur)); out.push(+cur.toFixed(1)); }
    return out;
  }
  function drawTrend(svgId,lookback,forecast){
    const svg=$(svgId); if(!svg) return;
    const W=600,H=180,pad=30; svg.innerHTML='';
    const all=lookback.concat(forecast); const minY=0,maxY=110,total=all.length;
    const toX=i=> pad+(i/(total-1))*(W-2*pad); const toY=v=> H-pad - ((v-minY)/(maxY-minY))*(H-2*pad);
    [50,75,(SETTINGS.bonus?.target||90),100].forEach(yv=>{
      const y=toY(yv);
      const l=document.createElementNS('http://www.w3.org/2000/svg','line'); l.setAttribute('x1',pad); l.setAttribute('x2',W-pad); l.setAttribute('y1',y); l.setAttribute('y2',y); l.setAttribute('stroke','rgba(255,255,255,0.15)'); l.setAttribute('stroke-dasharray','4 4'); svg.appendChild(l);
      const t=document.createElementNS('http://www.w3.org/2000/svg','text'); t.setAttribute('x',4); t.setAttribute('y',y-2); t.setAttribute('fill','var(--muted)'); t.setAttribute('font-size','10'); t.textContent=yv; svg.appendChild(t);
    });
    const pathD=(arr,offset=0)=> arr.map((v,i)=> (i===0?'M':'L') + toX(i+offset)+','+toY(v)).join(' ');
    const p1=document.createElementNS('http://www.w3.org/2000/svg','path'); p1.setAttribute('d',pathD(lookback,0)); p1.setAttribute('fill','none'); p1.setAttribute('stroke','white'); p1.setAttribute('stroke-width','2'); svg.appendChild(p1);
    const p2=document.createElementNS('http://www.w3.org/2000/svg','path'); p2.setAttribute('d',pathD(forecast,lookback.length-1)); p2.setAttribute('fill','none'); p2.setAttribute('stroke','white'); p2.setAttribute('stroke-dasharray','6 4'); p2.setAttribute('stroke-width','2'); svg.appendChild(p2);
  }
  function computeFocusAreas(mgr){
    const byName={}; (SCORECARD||[]).forEach(c=> byName[c.pillar]=c);
    const items=[];
    PILLAR_LIST.forEach(p=>{
      const c=byName[p]; if(!c) return;
      c.kpis.forEach(k=>{
        if(!kpiVisibleInContext(k)) return;
        const raw=(mgr.kpiRaw[c.pillar]||{})[k.name];
        const s=kpiScore(k,raw); const thr=SETTINGS.bonus?.thresholds||{yellow:75,green:100};
        const nextTarget=s>=thr.yellow?thr.green:thr.yellow; const gap=Math.max(0,nextTarget-s);
        const lift=+(gap*(k.w||0)).toFixed(2);
        const suggestion=(k.dir==='HigherBetter')?`Increase ${k.name} from ${raw ?? '—'} toward ${k.y} / ${k.g}.`:`Reduce ${k.name} from ${raw ?? '—'} toward ${k.y} / ${k.g}.`;
        items.push({pillar:p,name:k.name,score:s,weight:k.w||0,gap,lift,suggestion});
      });
    });
    items.sort((a,b)=> b.lift-a.lift); return items.slice(0,6);
  }
  function refreshInsights(){
    const idx=parseInt(($('mgrSelect')?.value||0),10); const m=MANAGERS[idx]||MANAGERS[0]; if(!m) return;
    const hist=getOverallHistory(m); const fore=forecastNextPoints(hist,12); const now=computeVisibleOverallScore(m);
    const prevAvg=hist.length ? (hist.reduce((a,b)=>a+b,0)/hist.length) : now; const delta=+(now-prevAvg).toFixed(1);
    const pctOfFull=payoutForScore(now); const fullPct=SETTINGS.bonus.fullPct; const totalBasePct=+((fullPct*(pctOfFull/100))).toFixed(2);
    const bandName=($('mgrBand')?.value)||(SETTINGS.bonus.bands[0]?.name||''); const band=SETTINGS.bonus.bands.find(b=>b.name===bandName)||{sti:100,lti:0};
    const stiPctBase=+((totalBasePct*band.sti/100)).toFixed(2); const ltiPctBase=+((totalBasePct*band.lti/100)).toFixed(2);
    const set=(id,txt)=>{ const el=$(id); if(el) el.textContent=txt; };
    set('tile_now', now.toFixed(1)+'%'); set('tile_band','Band: '+(bandForScoreBonus(now,SETTINGS.bonus.thresholds).toUpperCase()));
    set('tile_delta', (delta>=0?'+':'')+delta.toFixed(1)+'%');
    const foreAvg=+(fore.reduce((a,b)=>a+b,0)/fore.length).toFixed(1); set('tile_fore', foreAvg.toFixed(1)+'%');
    set('tile_bonus', totalBasePct+'% of base'); set('tile_split', `STI ${stiPctBase}% • LTI ${ltiPctBase}%`);
    drawTrend('trendSVG', hist, fore);
    const focus=computeFocusAreas(m); const host=$('focusList'); if(host){ host.innerHTML=''; focus.forEach(it=>{ const row=document.createElement('div'); row.className='focusitem'; row.innerHTML=`<div><b>${it.pillar}</b> — ${it.name}</div><div class="small muted">Score ${it.score.toFixed(1)} • Weight ${(it.weight*100).toFixed(0)}% • Gap ${it.gap.toFixed(1)}</div><div class="small">Action: ${it.suggestion}</div>`; host.appendChild(row); }); }
  }

  // Render Manager view
  function seedManagers(){
    const base=[
      {id:'m1',name:'Jordan Lee'},
      {id:'m2',name:'Avery Chen'},
      {id:'m3',name:'Riley Patel'}
    ];
    MANAGERS = base.map((m, idx)=>{
      const history = Array.from({length:12},(_,i)=>{
        const season = 4*Math.sin((i/12)*Math.PI*2 + idx*0.7);
        const slope  = (idx%2?1:-1)*i*0.15;
        const noise  = (Math.random()-0.5)*4;
        const basev  = 78 + season + slope + noise;
        return { total: Math.max(40, Math.min(105, +basev.toFixed(1))) };
      });
      return {...m, kpiRaw:{}, history};
    });
  }
  function augmentManagersForComposite(comp){
    // Tri-modal raw variation to ensure realistic spread including some reds
    MANAGERS.forEach((m, mi)=>{
      m.kpiRaw[comp.pillar] = m.kpiRaw[comp.pillar] || {};
      comp.kpis.forEach(k=>{
        if(typeof m.kpiRaw[comp.pillar][k.name]==='number') return;
        const r = Math.random();
        const mode = r < 0.25 ? 'RED' : (r < 0.70 ? 'YELLOW' : 'GREEN');
        const bias = (mi-1.5)*0.12;
        const jitter = (span,f=0.25)=> (Math.random()-0.5)*span*f;
        let raw;
        if(k.dir==='HigherBetter'){
          if(mode==='RED'){
            const span = (k.y - k.r);
            raw = k.r - 0.35*span + jitter(span, 0.9) + (k.r*0.02)*bias;
          } else if(mode==='YELLOW'){
            const center = (k.r + k.g)/2 + (k.g*0.02)*bias;
            raw = center + jitter((k.g - k.r), 0.6);
          } else {
            const center = (k.y + k.g)/2 + (k.g*0.02)*bias;
            raw = center + jitter((k.g - k.y), 0.8);
          }
        } else { // LowerBetter
          if(mode==='RED'){
            const span = (k.r - k.y);
            raw = k.r + 0.45*span + jitter(span, 1.0) - (k.r*0.02)*bias;
          } else if(mode==='YELLOW'){
            const center = (k.g + k.r)/2 - (k.g*0.02)*bias;
            raw = center + jitter((k.r - k.g), 0.6);
          } else {
            const center = (k.g + k.y)/2 - (k.g*0.02)*bias;
            raw = center + jitter((k.y - k.g), 0.8);
          }
        }
        const lo = Math.min(k.r,k.y,k.g) - Math.abs(k.y-k.r)*1.5;
        const hi = Math.max(k.r,k.y,k.g) + Math.abs(k.y-k.r)*1.5;
        raw = Math.max(lo, Math.min(hi, raw));
        m.kpiRaw[comp.pillar][k.name] = +(+raw).toFixed(2);
      });
    });
  }

  
  // Delegate raw edit changes
  (function(){
    const host = document.getElementById('compositeCards');
    if(!host) return;
    host.addEventListener('change', (e)=>{
      const t = e.target;
      if(!t.classList || !t.classList.contains('raw-edit')) return;
      const pillar = t.getAttribute('data-pillar');
      const kname  = t.getAttribute('data-kpi');
      const idx = parseInt((document.getElementById('mgrSelect')?.value||0),10);
      const m = MANAGERS[idx] || MANAGERS[0];
      const v = parseFloat(t.value);
      if(!m || !pillar || !kname || isNaN(v)) return;
      m.kpiRaw[pillar] = m.kpiRaw[pillar] || {};
      m.kpiRaw[pillar][kname] = v;
      renderManager(); // re-score immediately
    });
  })();

  // === Actionable Guidance (rule-based) ===
  const ACTION_LIBRARY = [
    { match:/near\s*miss/i, action:"Increase GEMBA walk frequency by 10% and prompt 1 quick-report per shift.", impact:"Near-miss reporting +15% yields the biggest lift this week." },
    { match:/training/i, action:"Schedule 2 micro-sessions (15 min) for overdue staff and auto-enroll in LMS reminders.", impact:"Training completion +12% measurably improves Safety pillar." },
    { match:/corrective|cap|closure/i, action:"Run daily 10‑min standup to unblock CAPs and enforce 7‑day closure SLA.", impact:"Each 10% CAP closure rise increases pillar score ~3–5 pts." },
    { match:/audit|inspection/i, action:"Convert weekly audits to checklists with photos; sample 20% more high‑risk areas.", impact:"Audit conformance +10% reduces defect recurrence next sprint." },
    { match:/maintenance|pm compliance/i, action:"Lock in PM windows and add pre‑shift checks; escalate repeat overdue items.", impact:"PM compliance +10% reduces unplanned downtime risk." },
    { match:/ergo|musculo/i, action:"Add 5‑min pre‑shift stretch + rotate high‑strain tasks every 90 minutes.", impact:"Expect 10–15% reduction in ergo-related near misses." },
    { match:/quality|first pass/i, action:"Add layer check at the constraint step and poka‑yoke common error.", impact:"First‑pass yield +8% lifts Operations pillar most." },
    { match:/attendance|absen/i, action:"Post transparent schedule; offer shift swaps and 1:1 coaching for repeat cases.", impact:"Reliability +8% improves overall delivery stability." },
    { match:/housekeeping|5s/i, action:"Run a 30‑min 5S blitz; label golden zones and set min/max for top 20 items.", impact:"Sustain 5S score +12%; fewer search‑time delays." },
    { match:/comms|response|handoff/i, action:"Use a standard handoff card and radio check at shift start/end.", impact:"Handoff errors −20%; fewer rework loops." }
  ];

  function guidanceForKPI(pillar, kpiName, score, nextTargetBand, weight){
    const rule = ACTION_LIBRARY.find(r => r.match.test(kpiName)) || {action:"Run a focused Kaizen: define root cause, pick one countermeasure, trial for 2 weeks.", impact:"Expect a 3–6 pt lift if sustained."};
    const liftPts = Math.max(1, Math.round((100 - Math.min(100, score)) * (weight||0.1)));
    return `Focus: <b>${pillar}</b> — <b>${kpiName}</b>. ${rule.action} ${rule.impact} Estimated lift: +${liftPts} pts toward pillar average.`;
  }
function renderManager(){
    const idx=parseInt(($('mgrSelect')?.value||0),10); const m=MANAGERS[idx]||MANAGERS[0]; if(!m) return;
    const host=$('compositeCards'); if(!host) return; host.innerHTML='';
    const byName={}; (SCORECARD||[]).forEach(c=> byName[c.pillar]=c);
    PILLAR_LIST.forEach(pname=>{
      const c = byName[pname] || {pillar:pname, weight:1, kpis:[]};
      const visKpis = c.kpis.filter(k=> kpiVisibleInContext(k));
      // If no KPI would score green, nudge first item's raw slightly toward green to guarantee a visible mix
      (function ensureSomeGreen(){
        try{
          const idxSel=parseInt((document.getElementById('mgrSelect')?.value||0),10);
          const m = MANAGERS[idxSel] || MANAGERS[0];
          if(!m) return;
          const hasGreen = visKpis.some(k=>{
            const raw=(m.kpiRaw[c.pillar]||{})[k.name]; return kpiScore(k, raw) >= 100;
          });
          if(!hasGreen && visKpis.length){
            const k0 = visKpis[0];
            const raw=(m.kpiRaw[c.pillar]||{})[k0.name];
            if(k0.dir==='HigherBetter'){
              m.kpiRaw[c.pillar][k0.name] = Math.max(raw||0, k0.g*0.98);
            } else {
              m.kpiRaw[c.pillar][k0.name] = Math.min(raw||k0.y, k0.g*1.02);
            }
          }
        }catch(e){}
      })();
    
      const score = visKpis.length ? visKpis.reduce((a,k)=>{
        const raw=(m.kpiRaw[c.pillar]||{})[k.name]; return a + (kpiScore(k,raw)*(k.w||0));
      },0) : 0;
      const b = visKpis.length ? bandFromScore(score) : 'yellow';
      const rows = visKpis.length ? visKpis.map(k=>{
        const raw=(m.kpiRaw[c.pillar]||{})[k.name]; const s=kpiScore(k,raw); const bb=bandFromScore(s);
        const tag = (k.assignType && k.assignType!=='GLOBAL') ? `<span class="small muted">${k.assignType}: ${(k.assignValues||[]).join(', ')}</span>` : '<span class="small muted">GLOBAL</span>';
        return `<tr><td>${k.name}<br>${tag}</td><td>${k.dir==='HigherBetter'?'↑':'↓'}</td><td>${k.r}/${k.y}/${k.g}</td><td><input type="number" step="0.01" class="raw-edit" data-pillar="${c.pillar}" data-kpi="${k.name}" value="${raw ?? ''}" style="width:90px"></td><td><span class="score-chip chip-${bb}">${(s!=null && s.toFixed) ? s.toFixed(2) : Number(s).toFixed(2)}</span></td></tr>`;
      }).join('') : `<tr><td colspan="5" class="small muted">No KPIs for current view.</td></tr>`;
      const card=document.createElement('div'); card.className='kpi';
      card.innerHTML = `<div class="headerline"><div><b>${c.pillar}</b></div><span class="score-chip chip-${b}">${Math.round(score)}</span></div>
        <table class="table"><thead><tr><th>KPI</th><th>Dir</th><th>R/Y/G</th><th>Raw</th><th>Score</th></tr></thead>
        <tbody>${rows}</tbody></table>`;
      host.appendChild(card);
    });
    bonusSummary(); refreshInsights();
  }
  function renderViewValueChoices(){
    const t=$('viewType')?.value||'ALL'; const sel=$('viewValue'); if(!sel) return;
    sel.innerHTML=''; const list=t==='SITE'?SITES:t==='DEPT'?DEPTS:t==='POSITION'?POSITIONS:[];
    if(!list.length){ sel.disabled=true; return; } sel.disabled=false;
    list.forEach(v=>{ const o=document.createElement('option'); o.value=v; o.textContent=v; sel.appendChild(o); });
  }

  // Tabs
  function showTab(id){
    document.querySelectorAll('.tab').forEach(t=> t.classList.toggle('active', t.dataset.tab===id));
    ['admin','manager','exec'].forEach(s=>{ const el=$(s); if(el) el.style.display = (s===id?'block':'none'); });
    if(id==='manager') renderManager();
    if(id==='exec' && typeof window.renderExec==='function') window.renderExec();
  }

  // Boot after DOM ready
  document.addEventListener('DOMContentLoaded', ()=>{
    // Seed UI
    loadBonusSettings(); uiFromBonus();
    // Wire simple handlers if elements present
    const compLib=$('compLib'); if(compLib){ compLib.onchange=showSeeds; }
    const refreshBtn=$('refreshSeeds'); if(refreshBtn){ refreshBtn.onclick=showSeeds; }
    const assignType=$('assignType'); if(assignType){ assignType.onchange=renderAssignList; }
    const clearBtn=$('clearQueue'); if(clearBtn){ clearBtn.onclick=()=>{ BUILD=[]; renderBuild(); }; }
    const applyAssign=$('applyAssignAll'); if(applyAssign){ applyAssign.onclick=()=>{ const a=currentAssignment(); BUILD=BUILD.map(k=>({...k,assignType:a.type,assignValues:[...a.values]})); renderBuild(); }; }
    const publish=$('publishSelected'); if(publish){ publish.onclick=()=>{
      if(!BUILD.length){ alert('Add KPIs to the Build Queue first.'); return; }
      const byPillar={}; BUILD.forEach(k=>{ (byPillar[k.pillar] ||= []).push({...k}); });
      SCORECARD=[]; PILLAR_LIST.forEach(p=>{ const list=byPillar[p]||[]; if(list.length){ let sum=list.reduce((a,b)=>a+(+b.w||0),0)||1; const kpis=list.map(k=>({...k,w:+(k.w/sum).toFixed(2)})); SCORECARD.push({pillar:p,weight:1,kpis}); } else { SCORECARD.push({pillar:p,weight:1,kpis:[]}); }});
      if(!MANAGERS.length) seedManagers();
      SCORECARD.forEach(c=> augmentManagersForComposite(c));
      BUILD=[]; renderBuild(); showTab('manager'); populateManagerSelectors(); renderManager();
    }; }
    const kpiSeeds=$('kpiSeeds'); if(kpiSeeds){
      kpiSeeds.addEventListener('click',(e)=>{
        const btn=e.target.closest('button.btn'); if(!btn) return;
        const row=e.target.closest('.seed-row'); if(!row) return;
        const pillar=($('compLib')?.value)||PILLAR_LIST[0];
        const get=k=> row.getAttribute('data-'+k);
        const wInput=row.querySelector('input'); const w=wInput ? (parseFloat(wInput.value)||parseFloat(get('w'))||10) : (parseFloat(get('w'))||10);
        const a=currentAssignment();
        const seed={ pillar, name:get('name'), dir:get('dir'), r:parseFloat(get('r')), y:parseFloat(get('y')), g:parseFloat(get('g')), w:w/100, assignType:a.type, assignValues:[...a.values] };
        addToBuild(seed);
      });
    }
    // View scope
    
    const mgrSel=$('mgrSelect'); if(mgrSel){ mgrSel.onchange=renderManager; }
    const regen=$('regenInsights'); if(regen){ regen.onclick=refreshInsights; }
    // Tabs
    document.querySelectorAll('.tab').forEach(b=> b.onclick=()=> showTab(b.dataset.tab) );
    // Initial paint
    renderAssignList(); showSeeds(); seedManagers(); populateManagerSelectors(); try{ const ms=document.getElementById('mgrSelect'); if(ms && ms.options.length){ ms.value='0'; } }catch(e){}  showTab('admin');
  });
})();
</script>
<div id="buildTag" style="position:fixed;right:10px;bottom:10px;padding:6px 10px;border-radius:8px;
background:#111;color:#fff;font-size:12px;opacity:.7;z-index:9999">
ALS Manager Guidance vFINAL-05 (safe)
</div>
<script>
(function(){
  function prettyNum(v){
    const n = (v===null||v===undefined||v==='') ? NaN : +String(v).replace(/[^0-9.\-]/g,'');
    if(!isFinite(n)) return String(v ?? '');
    return (Math.round(n*100)/100).toString();
  }
  function getBonusConfig(){
    const b = (window.SETTINGS && SETTINGS.bonus) ? SETTINGS.bonus : {};
    const full = b.fullBonusPct ?? b.full ?? 12; // % of base (default 12%)
    const payouts = b.payouts || b.payoutByBand || { red: 0, amber: 50, yellow: 100, green: 110 };
    const prorate = (b.prorate !== undefined) ? b.prorate : (b.proRate ?? true);
    return { full, payouts, prorate };
  }
  function bonusImpactText(){
    const { full, payouts, prorate } = getBonusConfig();
    const y = payouts.yellow ?? 100;
    const g = payouts.green  ?? 110;
    const deltaFull = (g - y);
    const deltaBase = Math.round((deltaFull/100) * full * 10)/10; // % of base
    const pr = prorate ? " (pro‑rated inside band)" : "";
    return `Bonus impact: Yellow ≈ ${y}% of full${pr}; Green ≈ ${g}% of full. Δ (Y→G): +${deltaFull}% of full ≈ +${deltaBase}% of base.`;
  }
  function buildGuidanceSentence(kpiName, raw, target, stretch, dir){
    const r = prettyNum(raw), t = prettyNum(target), g = prettyNum(stretch);
    const lower = String(dir||'').toLowerCase().includes('lower');
    const actionVerb = lower ? 'Reduce' : 'Increase';
    const deltaPart = (isFinite(+r) && isFinite(+t)) ? ` from ${r} to ${t}` : ` to ${t}`;
    const main = `${actionVerb} ${kpiName}${deltaPart} this cycle.`;
    const stretchTxt = (g!=='' && g!=='NaN')
      ? (lower ? ` Stretch goal: reduce to ${g} over the next two quarters.`
               : ` Stretch goal: reach ${g} over the next two quarters.`)
      : '';
    return main + stretchTxt + ' ' + bonusImpactText();
  }

  // Hard override the guidance function used by Manager view
  window.guidanceForKPI = function(pillar, kpiName, score, nextTargetBand, weight, kpi, raw){
    const y = (kpi && ('y' in kpi)) ? kpi.y : (window.SETTINGS?.bands?.yellow ?? 75);
    const g = (kpi && ('g' in kpi)) ? kpi.g : (window.SETTINGS?.bands?.green  ?? 100);
    const dir = kpi?.dir || 'HigherBetter';
    return buildGuidanceSentence(kpiName, raw, y, g, dir);
  };

  // If focus areas are computed elsewhere, normalize their text too
  if (typeof window.computeFocusAreas === 'function'){
    const _compute = window.computeFocusAreas;
    window.computeFocusAreas = function(mgr){
      const areas = _compute(mgr) || [];
      areas.forEach(a=>{
        const k = a.kpi || a.k || {};
        const dir = k.dir || 'HigherBetter';
        const raw = (a.raw !== undefined) ? a.raw : (mgr?.kpiRaw?.[a.pillar]?.[k.name]);
        a.suggestion = buildGuidanceSentence(k.name || a.name, raw, k.y, k.g, dir);
      });
      return areas;
    };
  }

  // Final scrub for any stale 'toward x/y' phrasing left in static templates
  Array.from(document.querySelectorAll('#mgrInsights, .focus-areas, .suggestion, .kpi-tip')).forEach(el=>{
    if(!el) return;
    el.innerHTML = el.innerHTML.replace(/\btowards?\s*\d+(?:\.\d+)?\s*\/\s*\d+(?:\.\d+)?/gi, '');
  });

  // Re-render the Manager view so new copy appears immediately
  if (typeof window.renderManager === 'function'){
    requestAnimationFrame(()=> window.renderManager());
  }
})();
</script>
<script>
(function(){
  function prettyNum(v){
    const n = (v===null||v===undefined||v==='') ? NaN : +String(v).replace(/[^0-9.\-]/g,'');
    if(!isFinite(n)) return String(v ?? '');
    return (Math.round(n*100)/100).toString();
  }
  function buildGuidanceSentence(kpiName, raw, target, stretch, dir){
    const r = prettyNum(raw), t = prettyNum(target), g = prettyNum(stretch);
    const lower = String(dir||'').toLowerCase().includes('lower');
    const verb = lower ? 'Reduce' : 'Increase';
    const deltaPart = (isFinite(+r) && isFinite(+t)) ? ` from ${r} to ${t}` : ` to ${t}`;
    const main = `${verb} ${kpiName}${deltaPart} this cycle.`;
    const stretchTxt = (g!=='' && g!=='NaN')
      ? (lower ? ` Stretch goal: reduce to ${g} over the next two quarters.`
               : ` Stretch goal: reach ${g} over the next two quarters.`)
      : '';
    return main + stretchTxt;
  }

  // Hard override: replace guidanceForKPI to only output action+stretch
  window.guidanceForKPI = function(pillar, kpiName, score, nextTargetBand, weight, kpi, raw){
    const y = (kpi && ('y' in kpi)) ? kpi.y : (window.SETTINGS?.bands?.yellow ?? 75);
    const g = (kpi && ('g' in kpi)) ? kpi.g : (window.SETTINGS?.bands?.green  ?? 100);
    const dir = kpi?.dir || 'HigherBetter';
    return buildGuidanceSentence(kpiName, raw, y, g, dir);
  };

  // Normalize prebuilt focus areas if used
  if (typeof window.computeFocusAreas === 'function'){
    const _compute = window.computeFocusAreas;
    window.computeFocusAreas = function(mgr){
      const areas = _compute(mgr) || [];
      areas.forEach(a=>{
        const k = a.kpi || a.k || {};
        const dir = k.dir || 'HigherBetter';
        const raw = (a.raw !== undefined) ? a.raw : (mgr?.kpiRaw?.[a.pillar]?.[k.name]);
        a.suggestion = buildGuidanceSentence(k.name || a.name, raw, k.y, k.g, dir);
      });
      return areas;
    };
  }

  // Re-render manager view immediately
  if (typeof window.renderManager === 'function'){
    requestAnimationFrame(()=> window.renderManager());
  }
})();
</script>
<script>
(function(){
  function prettyNum(v){
    const n = (v===null||v===undefined||v==='') ? NaN : +String(v).replace(/[^0-9.\-]/g,'');
    if(!isFinite(n)) return String(v ?? '');
    return (Math.round(n*100)/100).toString();
  }
  function buildGuidanceSentence(kpiName, raw, target, stretch, dir){
    const r = prettyNum(raw), t = prettyNum(target), g = prettyNum(stretch);
    const lower = String(dir||'').toLowerCase().includes('lower');
    const verb = lower ? 'Reduce' : 'Increase';
    const deltaPart = (isFinite(+r) && isFinite(+t)) ? ` from ${r} to ${t}` : ` to ${t}`;
    const main = `${verb} ${kpiName}${deltaPart} this cycle.`;
    const stretchTxt = (g!=='' && g!=='NaN')
      ? (lower ? ` Stretch goal: reduce to ${g} over the next two quarters.`
               : ` Stretch goal: reach ${g} over the next two quarters.`)
      : '';
    return main + stretchTxt;
  }
  // Hard override
  window.guidanceForKPI = function(pillar, kpiName, score, nextTargetBand, weight, kpi, raw){
    const y = (kpi && ('y' in kpi)) ? kpi.y : (window.SETTINGS?.bands?.yellow ?? 75);
    const g = (kpi && ('g' in kpi)) ? kpi.g : (window.SETTINGS?.bands?.green  ?? 100);
    const dir = kpi?.dir || 'HigherBetter';
    return buildGuidanceSentence(kpiName, raw, y, g, dir);
  };
})();
</script>
<script>
(function(){
  function rewriteLine(txt){
    // Action: Increase KPI from 0.7 toward 1.5 / 2.
    let m = txt.match(/Action:\s*(Increase|Reduce)\s+(.+?)\s+from\s+([0-9.]+)\s*toward\s*([0-9.]+)\s*\/\s*([0-9.]+)/i);
    if(m){
      const verb = m[1].toLowerCase()==='reduce' ? 'Reduce' : 'Increase';
      const kpi  = m[2].trim();
      const raw  = m[3], y = m[4], g = m[5];
      const stretchVerb = verb==='Reduce' ? 'reduce to' : 'reach';
      return `${verb} ${kpi} from ${raw} to ${y} this cycle. Stretch goal: ${stretchVerb} ${g} over the next two quarters.`;
    }
    // Action: Increase KPI toward 1.5 / 2.
    m = txt.match(/Action:\s*(Increase|Reduce)\s+(.+?)\s+toward\s*([0-9.]+)\s*\/\s*([0-9.]+)/i);
    if(m){
      const verb = m[1].toLowerCase()==='reduce' ? 'Reduce' : 'Increase';
      const kpi  = m[2].trim();
      const y = m[3], g = m[4];
      const stretchVerb = verb==='Reduce' ? 'reduce to' : 'reach';
      return `${verb} ${kpi} to ${y} this cycle. Stretch goal: ${stretchVerb} ${g} over the next two quarters.`;
    }
    // Action: Reduce KPI from 12 toward 7.
    m = txt.match(/Action:\s*(Increase|Reduce)\s+(.+?)\s+from\s+([0-9.]+)\s*toward\s*([0-9.]+)/i);
    if(m){
      const verb = m[1].toLowerCase()==='reduce' ? 'Reduce' : 'Increase';
      const kpi  = m[2].trim();
      const raw  = m[3], y = m[4];
      return `${verb} ${kpi} from ${raw} to ${y} this cycle.`;
    }
    return txt.replace(/^Action:\s*/,''); // strip "Action:" if present
  }

  function normalizeGuidance(root){
    const sel = root || document;
    const blocks = sel.querySelectorAll('.focus-areas, #mgrInsights, .suggestion, .kpi-tip, .kpi-line, .focus-area-item');
    blocks.forEach(block=>{
      // Rewrite text nodes inside common containers
      const walker = document.createTreeWalker(block, NodeFilter.SHOW_TEXT, null);
      let node;
      while(node = walker.nextNode()){
        const t = node.nodeValue;
        if(/Action:\s*(Increase|Reduce).+toward/i.test(t)){
          node.nodeValue = rewriteLine(t.trim());
        }
      }
    });
  }

  // Run after initial render and on "Regenerate Insights" click
  requestAnimationFrame(()=> normalizeGuidance());
  document.addEventListener('click', (e)=>{
    const t = e.target;
    if(!t) return;
    const label = (t.innerText||'').toLowerCase();
    if(label.includes('regenerate insights') || label.includes('refresh') || label.includes('recompute')){
      setTimeout(()=> normalizeGuidance(), 80);
    }
  });

  // Observe changes in the focus area container
  const fa = document.querySelector('.focus-areas') || document.getElementById('mgrInsights');
  if(fa && 'MutationObserver' in window){
    const mo = new MutationObserver(()=> normalizeGuidance(fa));
    mo.observe(fa, {subtree:true, childList:true, characterData:true});
  }
})();
</script>
<script>
// Safe guidance normalizer: update only text nodes that contain the old "toward y / g" phrasing
(function(){
  function rewriteLine(txt){
    let m = txt.match(/Action:\s*(Increase|Reduce)\s+(.+?)\s+from\s+([0-9.]+)\s*toward\s*([0-9.]+)\s*\/\s*([0-9.]+)/i);
    if(m){
      const verb = m[1].toLowerCase()==='reduce' ? 'Reduce' : 'Increase';
      const kpi  = m[2].trim();
      const raw  = m[3], y = m[4], g = m[5];
      const stretchVerb = verb==='Reduce' ? 'reduce to' : 'reach';
      return `${verb} ${kpi} from ${raw} to ${y} this cycle. Stretch goal: ${stretchVerb} ${g} over the next two quarters.`;
    }
    m = txt.match(/Action:\s*(Increase|Reduce)\s+(.+?)\s+toward\s*([0-9.]+)\s*\/\s*([0-9.]+)/i);
    if(m){
      const verb = m[1].toLowerCase()==='reduce' ? 'Reduce' : 'Increase';
      const kpi  = m[2].trim();
      const y = m[3], g = m[4];
      const stretchVerb = verb==='Reduce' ? 'reduce to' : 'reach';
      return `${verb} ${kpi} to ${y} this cycle. Stretch goal: ${stretchVerb} ${g} over the next two quarters.`;
    }
    m = txt.match(/Action:\s*(Increase|Reduce)\s+(.+?)\s+from\s+([0-9.]+)\s*toward\s*([0-9.]+)/i);
    if(m){
      const verb = m[1].toLowerCase()==='reduce' ? 'Reduce' : 'Increase';
      const kpi  = m[2].trim();
      const raw  = m[3], y = m[4];
      return `${verb} ${kpi} from ${raw} to ${y} this cycle.`;
    }
    return null;
  }

  function normalizeIn(root){
    const walker = document.createTreeWalker(root, NodeFilter.SHOW_TEXT, null);
    let node;
    while(node = walker.nextNode()){
      const t = node.nodeValue;
      if(!t || t.indexOf('Action:') === -1 || t.indexOf('toward') === -1) continue;
      const newTxt = rewriteLine(t.trim());
      if(newTxt){
        node.nodeValue = newTxt;
      }
    }
  }

  function normalizeAll(){
    const regions = [
      document.querySelector('.focus-areas'),
      document.getElementById('mgrInsights')
    ].filter(Boolean);
    if (regions.length === 0){
      // As a fallback, normalize only within the performance & insights block if present
      const perfBlocks = Array.from(document.querySelectorAll('*')).filter(el=>/Performance & Bonus Insights/i.test(el.textContent||''));
      perfBlocks.forEach(el=> normalizeIn(el));
    } else {
      regions.forEach(el=> normalizeIn(el));
    }
  }

  // Initial + delayed runs
  requestAnimationFrame(normalizeAll);
  setTimeout(normalizeAll, 80);
  setTimeout(normalizeAll, 200);

  // Re-run after "Regenerate Insights" clicks
  document.addEventListener('click', (e)=>{
    const label = (e.target && e.target.innerText || '').toLowerCase();
    if(label.includes('regenerate insights') || label.includes('refresh') || label.includes('recompute')){
      setTimeout(normalizeAll, 120);
    }
  });

  // Watch typical container for changes
  const fa = document.querySelector('.focus-areas') || document.getElementById('mgrInsights') || document.body;
  if('MutationObserver' in window && fa){
    const mo = new MutationObserver(()=> setTimeout(normalizeAll, 10));
    mo.observe(fa, {subtree:true, childList:true, characterData:true});
  }
})();
</script>
<script>
(function(){
  // Use existing SETTINGS if present (bands, pillars)
  window.SETTINGS = window.SETTINGS || {};
  SETTINGS.bands = SETTINGS.bands || { red:50, amber:75, yellow:90, green:100 };
  SETTINGS.pillars = SETTINGS.pillars || [
    {key:'Safety Integrity & Culture',  name:'Safety Integrity & Culture',            w:1.0},
    {key:'Servant Leadership & Development', name:'Servant Leadership & Development', w:1.0},
    {key:'Operational Delivery & Quality',   name:'Operational Delivery & Quality',   w:1.0},
    {key:'Regulatory Compliance & Governance', name:'Regulatory Compliance & Governance', w:1.0},
    {key:'People & Resource Stewardship',    name:'People & Resource Stewardship',    w:1.0},
    {key:'CI Culture & Improvement',         name:'CI Culture & Improvement',         w:1.0},
  ];

  const PILLAR_NAMES = (SETTINGS.pillars||[]).map(p=>p.name) || [
    'Safety Integrity & Culture',
    'Servant Leadership & Development',
    'Operational Delivery & Quality',
    'Regulatory Compliance & Governance',
    'People & Resource Stewardship',
    'CI Culture & Improvement'
  ];

  // Demo org filters
  const Regions=['East','West'];
  const Depts=['Operations','Quality','Maintenance'];
  const Sites=['Wilmington','Seattle','Chicago','LA'];
  const Pos=['Manager','Safety Specialist','Shop Lead'];

  
  // Managers (expanded seed set for Exec demo; used only if Manager data not present)
  const Managers = [
    {id:'m1', name:'Jordan Lee',  region:'East', dept:'Operations',  site:'Wilmington', position:'Manager'},
    {id:'m2', name:'Avery Chen',  region:'East', dept:'Maintenance', site:'Wilmington', position:'Manager'},
    {id:'m3', name:'Riley Patel', region:'West', dept:'Operations',  site:'LA',         position:'Manager'},
    {id:'m4', name:'Sam Taylor',  region:'West', dept:'Quality',     site:'Seattle',    position:'Manager'},
    {id:'m5', name:'Alex Rivera', region:'West', dept:'Operations',  site:'Chicago',    position:'Safety Specialist'},
    {id:'m6', name:'Morgan Lee',  region:'East', dept:'Quality',     site:'Wilmington', position:'Manager'},
    {id:'m7', name:'Jamie Fox',   region:'East', dept:'Operations',  site:'Chicago',    position:'Shop Lead'},
    {id:'m8', name:'Toni Diaz',   region:'West', dept:'Maintenance', site:'LA',         position:'Manager'},
    {id:'m9', name:'Chris Park',  region:'West', dept:'Operations',  site:'Seattle',    position:'Manager'},
    {id:'m10',name:'Priya Singh', region:'East', dept:'Maintenance', site:'Chicago',    position:'Safety Specialist'},
    {id:'m11',name:'Noah Green',  region:'East', dept:'Operations',  site:'Wilmington', position:'Manager'},
    {id:'m12',name:'Evan Brooks', region:'West', dept:'Quality',     site:'LA',         position:'Manager'}
  ];

  // Exec-only seed scores (fallback when Manager tab data isn't wired)
  const ExecScores = {};
  let execSeed = 20251028;
  function execRand(){ execSeed = (execSeed*1664525 + 1013904223) >>> 0; return execSeed/4294967296; }
  function execJitter(mid, span){ return Math.max(35, Math.min(100, mid + (execRand()*2-1)*span)); }
  function seedExecScores(){
    Managers.forEach((m)=>{
      ExecScores[m.id] = {
        'Safety Integrity & Culture':        execJitter(68 + (m.region==='East'? 2 : -2), 18),
        'Servant Leadership & Development':  execJitter(66 + (m.dept==='Quality'? 3 : -1), 16),
        'Operational Delivery & Quality':    execJitter(70 + (m.site==='Wilmington'? 2 : 0), 20),
        'Regulatory Compliance & Governance':execJitter(64 + (m.dept==='Maintenance'? -3 : 2), 18),
        'People & Resource Stewardship':     execJitter(65 + (m.position==='Safety Specialist'? -2 : 1), 14),
        'CI Culture & Improvement':          execJitter(67 + (m.dept==='Operations'? 2 : 0), 16)
      };
    });
  }
  seedExecScores();

  // Allow manual reseed from UI
  document.addEventListener('click', (e)=>{
    if(e.target && e.target.id === 'seedExec'){
      execSeed = Math.floor(Math.random()*1e9);
      seedExecScores();
      renderExec();
    }
  });

  // Pull per-manager KPI raw values that were seeded in Manager view (if available)
 that were seeded in Manager view
  function getScoresFor(mgr){
    // SCORECARD & MANAGERS exist in Manager script
    if(!window.SCORECARD || !window.MANAGERS){ const m=ExecScores[mgr.id]||{}; const vals=Object.values(m); return { pillarAvg:m, overall: (vals.length? vals.reduce((a,b)=>a+b,0)/vals.length : 0) }; }
    const m = (window.MANAGERS||[]).find(x=>x.name===mgr.name) || null;
    if(!m) return null;
    // Build pillar averages using the same scoring function
    const byName={}; (window.SCORECARD||[]).forEach(c=> byName[c.pillar]=c);
    const pAvg={}; let total=0, wsum=0;
    PILLAR_NAMES.forEach(p=>{
      const comp = byName[p]; if(!comp) return;
      const kpis = comp.kpis||[];
      const sc = kpis.reduce((a,k)=>{
        const raw=(m.kpiRaw[p]||{})[k.name];
        return a + (window.kpiScore ? window.kpiScore(k,raw)*(k.w||0) : 0);
      },0);
      pAvg[p]=sc; total+=sc; wsum+=1;
    });
    const overall = wsum? total/wsum : 0;
    return {pillarAvg:pAvg, overall};
  }

  function bandOf(score){
  const b = (typeof BANDS!=='undefined' && BANDS) ? BANDS : ((window.SETTINGS && SETTINGS.bands) ? SETTINGS.bands : {red:50, yellow:75, green:100});
  const s = Math.round(score||0);
  if(s < b.red)   return {cls:'red',    label:'red'};
  if(s < b.yellow)return {cls:'yellow', label:'yellow'};
  if(s < b.green) return {cls:'yellow', label:'yellow'};
  return {cls:'green',label:'green'};
}

  function fillSelect(sel, arr, all){ sel.innerHTML=''; const o=document.createElement('option'); o.value='*'; o.textContent=all; sel.appendChild(o); arr.forEach(v=>{ const x=document.createElement('option'); x.value=v; x.textContent=v; sel.appendChild(x); }); }

  function currentFilters(){
    const $=id=>document.getElementById(id);
    return { r:$('#exRegion').value, d:$('#exDept').value, s:$('#exSite').value, p:$('#exPos').value };
  }
  function pass(m,f){
    return (f.r==='*'||m.region===f.r) && (f.d==='*'||m.dept===f.d) && (f.s==='*'||m.site===f.s) && (f.p==='*'||m.position===f.p);
  }

  window.renderExec = function(){
    const $=id=>document.getElementById(id);
    // init filters once
    if(!$('#exRegion').options.length){
      fillSelect($('#exRegion'),Regions,'All Regions');
      fillSelect($('#exDept'),Depts,'All Departments');
      fillSelect($('#exSite'),Sites,'All Sites');
      fillSelect($('#exPos'),Pos,'All Positions');
      ['exRegion','exDept','exSite','exPos'].forEach(id=> document.getElementById(id).addEventListener('change', renderExec));
    }

    const f=currentFilters();
    const set = Managers.filter(m=> pass(m,f) );
    // Aggregate
    const pillarAgg={}; PILLAR_NAMES.forEach(p=> pillarAgg[p]=[]);
    const leaders=[];
    set.forEach(m=>{
      const sc = getScoresFor(m); if(!sc) return;
      leaders.push({name:m.name, avg:sc.overall, org:`${m.region} • ${m.dept}`});
      PILLAR_NAMES.forEach(p=> { if(sc.pillarAvg && (p in sc.pillarAvg)) pillarAgg[p].push(sc.pillarAvg[p]); });
    });

    const pillarAvg={};
    let sum=0, cnt=0;
    PILLAR_NAMES.forEach(p=>{
      const arr=pillarAgg[p]||[];
      const avg = arr.length? arr.reduce((a,b)=>a+b,0)/arr.length : 0;
      pillarAvg[p]=avg; sum+=avg; cnt+=1;
    });
    const avgWeighted = cnt? sum/cnt : 0;

    // Paint headline
    const exAvg=document.getElementById('exAvg'); if(exAvg) exAvg.textContent = isFinite(avgWeighted)? (Math.round(avgWeighted*10)/10)+'%' : '—';
    const b=bandOf(avgWeighted);
    const exBand=document.getElementById('exBand'); if(exBand) exBand.textContent = `Band: ${b.label.toUpperCase()}`;
    const exCount=document.getElementById('exCount'); if(exCount) exCount.textContent = `${set.length} manager(s)`;

    // Tier chips
    const tiers={green:0,yellow:0,red:0};
    leaders.forEach(ld=> tiers[bandOf(ld.avg).k]++ );
    const tc=document.getElementById('exTiers'); if(tc){
      tc.innerHTML='';
      [['green','green'],['yellow','yellow'],['red','red']].forEach(([k,lab])=>{
        const s=document.createElement('span'); s.className='exec-pill '+(k==='risk'?'red':k); s.textContent = `${lab} ${tiers[k]||0}`; tc.appendChild(s);
      });
    }

    // Pillar table
    const tb=document.querySelector('#exPillars tbody'); if(tb){
      tb.innerHTML='';
      PILLAR_NAMES.forEach(p=>{
        const s=pillarAvg[p]||0; const bb=bandOf(s);
        const tr=document.createElement('tr');
        tr.innerHTML = `<td>${p}</td><td>${(Math.round(s*10)/10)}%</td><td><span class="exec-pill ${bb.cls}">${bb.label}</span></td>`;
        tb.appendChild(tr);
      });
    }

    // Leaders
    const L=document.getElementById('exLeaders'); if(L){
      L.innerHTML='';
      leaders.sort((a,b)=>b.avg-a.avg).slice(0,8).forEach(ld=>{
        const row=document.createElement('div'); row.style.cssText='display:flex;justify-content:space-between;padding:8px;border-top:1px dashed #1f3447';
        row.innerHTML = `<div><strong>${ld.name}</strong><div class="exec-muted">${ld.org}</div></div>
                         <div><span class="exec-pill ${bandOf(ld.avg).cls}">${(Math.round(ld.avg*10)/10)}%</span></div>`;
        L.appendChild(row);
      });
    }
  };

  // If user clicks the Exec tab immediately, render now
  document.addEventListener('DOMContentLoaded', ()=>{
    const execTab = Array.from(document.querySelectorAll('.tab')).find(t=>t.dataset.tab==='exec');
    if(execTab) execTab.addEventListener('click', ()=> setTimeout(window.renderExec,0));
    if(document.getElementById('exec') && document.getElementById('exec').style.display!=='none') window.renderExec();
  });
})();
</script>
<script>
/* ===== RISE Exec Roll-Up — Standalone Seed + Renderer (auto-seeded) ===== */
(function(){
  const $ = (q,s=document)=>s.querySelector(q);

  // Bands + pillars (uses your settings if present; else defaults)
  const SETTINGS = window.SETTINGS || {};
  const BANDS = (SETTINGS.bands) || { red:50, amber:60, yellow:75, green:100 };
  const PILLARS = (SETTINGS.pillars && SETTINGS.pillars.map(p=>p.name||p)) || [
    'Safety Integrity & Culture',
    'Servant Leadership & Development',
    'Operational Delivery & Quality',
    'Regulatory Compliance & Governance',
    'People & Resource Stewardship',
    'CI Culture & Improvement'
  ];

  // Ensure Exec filter selects exist (no-op if already present)
  function ensureSelect(id,label,opts,allLabel){
    if(document.getElementById(id)) return;
    const filtersHost = document.querySelector('#exec .card');
    if(!filtersHost) return;
    const firstGrid = filtersHost.querySelector('.grid');
    const lbl = document.createElement('label');
    lbl.className = 'muted';
    lbl.innerHTML = label + '<br><select id="'+id+'"></select>';
    (firstGrid || filtersHost).appendChild(lbl);
  }
  ensureSelect('exRegion','Region',['East','West'],'All Regions');
  ensureSelect('exDept','Department',['Operations','Quality','Maintenance'],'All Departments');
  ensureSelect('exSite','Site',['Wilmington','Seattle','Chicago','LA'],'All Sites');
  ensureSelect('exPos','Position',['Manager','Safety Specialist','Shop Lead'],'All Positions');

  function fillSelect(sel,arr,all){
    if(!sel) return;
    sel.innerHTML='';
    const o=document.createElement('option'); o.value='*'; o.textContent=all; sel.appendChild(o);
    arr.forEach(v=>{ const x=document.createElement('option'); x.value=v; x.textContent=v; sel.appendChild(x); });
  }
  fillSelect(document.getElementById('exRegion'),['East','West'],'All Regions');
  fillSelect(document.getElementById('exDept'),['Operations','Quality','Maintenance'],'All Departments');
  fillSelect(document.getElementById('exSite'),['Wilmington','Seattle','Chicago','LA'],'All Sites');
  fillSelect(document.getElementById('exPos'),['Manager','Safety Specialist','Shop Lead'],'All Positions');

  // Seed dataset (independent of Manager tab)
  const Managers=[
    {id:'m1', name:'Jordan Lee',  region:'East', dept:'Operations',  site:'Wilmington', position:'Manager'},
    {id:'m2', name:'Avery Chen',  region:'East', dept:'Maintenance', site:'Wilmington', position:'Manager'},
    {id:'m3', name:'Riley Patel', region:'West', dept:'Operations',  site:'LA',         position:'Manager'},
    {id:'m4', name:'Sam Taylor',  region:'West', dept:'Quality',     site:'Seattle',    position:'Manager'},
    {id:'m5', name:'Alex Rivera', region:'West', dept:'Operations',  site:'Chicago',    position:'Safety Specialist'},
    {id:'m6', name:'Morgan Lee',  region:'East', dept:'Quality',     site:'Wilmington', position:'Manager'},
    {id:'m7', name:'Jamie Fox',   region:'East', dept:'Operations',  site:'Chicago',    position:'Shop Lead'},
    {id:'m8', name:'Toni Diaz',   region:'West', dept:'Maintenance', site:'LA',         position:'Manager'},
    {id:'m9', name:'Chris Park',  region:'West', dept:'Operations',  site:'Seattle',    position:'Manager'},
    {id:'m10',name:'Priya Singh', region:'East', dept:'Maintenance', site:'Chicago',    position:'Safety Specialist'},
    {id:'m11',name:'Noah Green',  region:'East', dept:'Operations',  site:'Wilmington', position:'Manager'},
    {id:'m12',name:'Evan Brooks', region:'West', dept:'Quality',     site:'LA',         position:'Manager'}
  ];
  const ExecScores = {}; // pillar averages per manager id
  let _seed = 20251029;
  const rnd = ()=>{ _seed = (_seed*1664525 + 1013904223) >>> 0; return _seed/4294967296; };
  const jit = (mid,span)=> Math.max(35, Math.min(100, mid + (rnd()*2-1)*span));

  function reseed(){
  const b = (typeof BANDS!=='undefined' && BANDS) ? BANDS : ((window.SETTINGS && SETTINGS.bands) ? SETTINGS.bands : {red:50, yellow:75, green:100});
  const redMid   = (b.red||50) - 5;
  const yellowMid= (b.red||50 + (b.yellow||75)) / 2;
  const nearGreen= (b.green||100) - 5;
  const tierOrder = ['red','yellow','green','yellow','red','green','yellow','red','green','yellow','red','green'];
  Managers.forEach((m,idx)=>{
    const tier = tierOrder[idx % tierOrder.length];
    let base = yellowMid; if(tier==='red') base = redMid; if(tier==='green') base = nearGreen;
    const span = 12;
    const row = {};
    PILLARS.forEach(p=> row[p] = jitter(base, span));
    row['Operational Delivery & Quality']     = Math.max(0, Math.min(100, jitter(base + (m.site==='Wilmington'? 2:0), span+2)));
    row['Regulatory Compliance & Governance'] = Math.max(0, Math.min(100, jitter(base + (m.dept==='Maintenance'? -3:2), span)));
    row['People & Resource Stewardship']      = Math.max(0, Math.min(100, jitter(base + (m.position==='Safety Specialist'? -2:1), span-2)));
    row['Safety Integrity & Culture']         = Math.max(0, Math.min(100, jitter(base + (m.region==='East'? 2:-2), span)));
    row['Servant Leadership & Development']   = Math.max(0, Math.min(100, jitter(base + (m.dept==='Quality'? 3:-1), span-1)));
    row['CI Culture & Improvement']           = Math.max(0, Math.min(100, jitter(base + (m.dept==='Operations'? 2:0), span)));
    ExecScores[m.id] = row;
  });
}
  reseed();

  function bandOf(score){
    const s=Math.round(score||0);
    if(s < BANDS.red)   return {cls:'red',    label:'risk'};
    if(s < BANDS.amber) return {cls:'red',    label:'red'};
    if(s < BANDS.yellow)return {cls:'amber',  label:'amber'};
    if(s < BANDS.green) return {cls:'yellow', label:'yellow'};
    return {cls:'green',label:'green'};
  }

  function pass(m,f){return (f.r==='*'||m.region===f.r)&&(f.d==='*'||m.dept===f.d)&&(f.s==='*'||m.site===f.s)&&(f.p==='*'||m.position===f.p);}
  function currentF(){ return {
    r:document.getElementById('exRegion').value,
    d:document.getElementById('exDept').value,
    s:document.getElementById('exSite').value,
    p:document.getElementById('exPos').value
  };}

  window.renderExec = function(){
    const set = Managers.filter(m=>pass(m,currentF()));
    const agg = {}; PILLARS.forEach(p=> agg[p]=[]);
    const leaders=[];
    set.forEach(m=>{
      const row = ExecScores[m.id]||{};
      const vals = PILLARS.map(p=>row[p]).filter(v=>typeof v==='number');
      const avg = vals.length? vals.reduce((a,b)=>a+b,0)/vals.length : 0;
      leaders.push({name:m.name, avg, org:`${m.region} • ${m.dept}`});
      PILLARS.forEach(p=> agg[p].push(row[p]));
    });
    let sum=0,cnt=0; const pAvg={};
    PILLARS.forEach(p=>{ const arr=agg[p]; const v=arr.length?arr.reduce((a,b)=>a+b,0)/arr.length:0; pAvg[p]=v; sum+=v; cnt++; });
    const overall = cnt? sum/cnt : 0;

    const exAvg=document.getElementById('exAvg'); if(exAvg) exAvg.textContent = (Math.round(overall*10)/10)+'%';
    const exBand=document.getElementById('exBand'); if(exBand) exBand.textContent = 'Band: '+bandOf(overall).label.toUpperCase();
    const exCount=document.getElementById('exCount'); if(exCount) exCount.textContent = set.length+' manager(s)';

    const tiers={green:0,yellow:0,red:0};
    leaders.forEach(ld=> { const lab=bandOf(ld.avg).label; if(lab in tiers) tiers[lab]++; });
    const tc=document.getElementById('exTiers'); if(tc){ tc.innerHTML='';
      [['green','green'],['yellow','yellow'],['red','red']].forEach(([k,lab])=>{
        const span=document.createElement('span'); span.className='pill '+(k==='risk'?'red':k); span.textContent=`${lab} ${tiers[k]||0}`; tc.appendChild(span);
      });
    }

    const tb=document.querySelector('#exPillars tbody'); if(tb){ tb.innerHTML='';
      PILLARS.forEach(p=>{ const s=pAvg[p]||0; const b=bandOf(s);
        const tr=document.createElement('tr');
        tr.innerHTML = `<td>${p}</td><td>${(Math.round(s*10)/10)}%</td><td><span class="pill ${b.cls}">${b.label}</span></td>`;
        tb.appendChild(tr);
      });
    }

    const L=document.getElementById('exLeaders'); if(L){ L.innerHTML='';
      leaders.sort((a,b)=>b.avg-a.avg).slice(0,8).forEach(ld=>{
        const row=document.createElement('div'); row.style.cssText='display:flex;justify-content:space-between;padding:8px;border-top:1px dashed #1f3447';
        row.innerHTML = `<div><strong>${ld.name}</strong><div class="muted">${ld.org}</div></div>
                         <div><span class="pill ${bandOf(ld.avg).cls}">${(Math.round(ld.avg*10)/10)}%</span></div>`;
        L.appendChild(row);
      });
    }
  };

  // Hook filters, seed button (if present), tab click, and auto render
  ;['exRegion','exDept','exSite','exPos'].forEach(id=>{ const el=document.getElementById(id); if(el) el.addEventListener('change', window.renderExec); });
  const seedBtn = document.getElementById('seedExec'); if(seedBtn){ seedBtn.addEventListener('click', ()=>{ _seed=(Math.random()*1e9)|0; reseed(); window.renderExec(); }); }

  // Ensure Exec renders when tab is opened and once on load if Exec is visible
  document.querySelectorAll('.tab[data-tab=\"exec\"]').forEach(btn=> btn.addEventListener('click', ()=> setTimeout(window.renderExec,0)));
  document.addEventListener('DOMContentLoaded', ()=>{
    const exec = document.getElementById('exec');
    if(exec && getComputedStyle(exec).display !== 'none') window.renderExec();
  });
})();
</script>
<script>
(function(){
  function onceReady(fn){
    if(document.readyState === 'loading'){
      document.addEventListener('DOMContentLoaded', fn);
    } else { fn(); }
  }

  onceReady(function(){
    try{
      // 1) Find the Global Bonus card (anchor) narrowly
      var bonusCard = Array.prototype.slice.call(document.querySelectorAll('.card, section, article, div'))
        .find(function(el){
          var t = (el.querySelector('.card-title') ? el.querySelector('.card-title').textContent : el.textContent) || '';
          return /Global Bonus Settings/i.test(t);
        });

      // 2) Remove only the Band Thresholds card (very narrow: look for exact title)
      var thresholdsCard = Array.prototype.slice.call(document.querySelectorAll('.card, section, article, div'))
        .find(function(el){
          var h = el.querySelector('.card-title');
          return !!h && /Band Thresholds/i.test(h.textContent||'');
        });
      if(thresholdsCard && thresholdsCard.parentNode){
        thresholdsCard.parentNode.removeChild(thresholdsCard);
      }

      // 3) Inject read-only summary after Global Bonus card
      if(bonusCard && bonusCard.parentNode){
        var ro = document.createElement('div');
        ro.className = bonusCard.className;
        ro.innerHTML = ''
          + '<div class="card-title">Thresholds (from KPI Master)</div>'
          + '<div class="muted" style="margin-bottom:8px">Read-only • Values come from each KPI’s definition.</div>'
          + '<div id="als-kpi-thresh" class="muted" style="max-height:200px;overflow:auto;border:1px dashed var(--border);padding:8px;border-radius:8px">'
          + '  <div>No KPIs selected yet. Add items to the Build Queue to preview R/Y/G cutpoints here.</div>'
          + '</div>';
        bonusCard.parentNode.insertBefore(ro, bonusCard.nextSibling);

        function refresh(){
          var box = document.getElementById('als-kpi-thresh'); if(!box) return;
          // Look for common build-queue containers
          var qSel = ['#buildQueue','.build-queue','.queue','[data-queue]'];
          var rows = [];
          qSel.forEach(function(sel){
            var el = document.querySelector(sel);
            if(el){
              rows = rows.concat(Array.prototype.slice.call(el.querySelectorAll('*')));
            }
          });

          var items = [];
          rows.forEach(function(r){
            var txt = (r.textContent||'').replace(/\s+/g,' ').trim();
            var m = txt.match(/^(.*?)(?:R\/Y\/G[:\s]+)([0-9.\-]+)\s*\/\s*([0-9.\-]+)\s*\/\s*([0-9.\-]+)/i);
            if(m){
              var name = m[1].trim();
              if(name) items.push({name:name, r:m[2], y:m[3], g:m[4]});
            }
          });
          if(items.length === 0){
            box.innerHTML = '<div>No KPIs selected yet. Add items to the Build Queue to preview R/Y/G cutpoints here.</div>';
          } else {
            box.innerHTML = items.map(function(it){
              return '<div style="margin-bottom:6px"><strong>'+it.name+'</strong><br/>R/Y/G: '+it.r+' / '+it.y+' / '+it.g+'</div>';
            }).join('');
          }
        }

        // Observe changes to the build queue
        var obEl = document.querySelector('#buildQueue') || document.querySelector('.build-queue') || document.querySelector('.queue') || document.querySelector('[data-queue]');
        if(obEl){
          var mo = new MutationObserver(refresh);
          mo.observe(obEl, {childList:true, subtree:true, characterData:true});
        }
        refresh();
      }
    }catch(e){
      console.warn('ALS read-only thresholds patch error:', e);
    }
  });
})();
</script>
<script>
/* ALS patch: remove editable KPI band thresholds card (keep bonus & pay bands) */
(function(){
  function nodelist(a){ return Array.prototype.slice.call(a || []); }
  function killThresholdCard(){
    // Strategy 1: remove any card whose title matches "Band Thresholds"
    var candidates = nodelist(document.querySelectorAll('.card, section, article, div'));
    var removed = false;
    candidates.forEach(function(el){
      var tEl = el.querySelector('.card-title');
      var title = (tEl && tEl.textContent || '').trim();
      if (/^band\s*thresholds/i.test(title)) {
        el.remove();
        removed = true;
      }
    });
    if (removed) return;

    // Strategy 2: find a container that has labels for Red/Yellow/Green threshold inputs
    candidates.forEach(function(el){
      var txt = (el.textContent || '').replace(/\s+/g,' ').toLowerCase();
      // try to ensure it's a compact settings card, not the payout-by-band section
      var hasRYG = /red[^a-z0-9]{1,6}[<≥]|yellow[^a-z0-9]{1,6}[<≥]|green[^a-z0-9]{1,6}[<≥]/.test(txt);
      var looksLikePayout = /payout by band/i.test(el.textContent || '');
      if (hasRYG && !looksLikePayout) {
        // also avoid removing the read-only summary (which doesn't show inputs)
        var hasInputs = el.querySelector('input, select, textarea');
        if (hasInputs) {
          el.remove();
          removed = true;
        }
      }
    });
  }
  function run(){
    try{ killThresholdCard(); }catch(e){}
  }
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', function(){ run(); setTimeout(run, 200); });
  } else {
    run(); setTimeout(run, 200);
  }
})();
</script>
<script>
// Final cleanup: nuke the entire "Band Thresholds" settings card (and any stray "(removed)" row)
(function(){
  function nukeThresholdsCard(){
    // Remove by explicit card-title
    var titles = Array.prototype.slice.call(document.querySelectorAll('.card-title, h3, h4, .title'));
    var removed = false;
    titles.forEach(function(t){
      var txt = (t.textContent||'').trim();
      if (/^Band\s*Thresholds/i.test(txt)) {
        var card = t.closest('.card') || t.parentElement;
        if (card && card.parentElement) {
          card.parentElement.removeChild(card);
          removed = true;
        }
      }
    });
    // Fallback: remove any settings block that still shows "(removed)"
    if (!removed) {
      var suspects = Array.prototype.slice.call(document.querySelectorAll('.card, section, article, div'));
      suspects.forEach(function(el){
        var text = (el.textContent||'').replace(/\s+/g,' ').toLowerCase();
        if (text.includes('(removed)')) {
          var card = el.closest('.card') || el;
          // Ensure it's not the bonus payout by band or pay bands sections
          var keep = /payout by band/i.test(el.textContent||'') || /pay bands/i.test(el.textContent||'') || /global bonus settings/i.test(el.textContent||'');
          if (!keep && card.parentElement) {
            card.parentElement.removeChild(card);
          }
        }
      });
    }
  }
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', function(){ nukeThresholdsCard(); setTimeout(nukeThresholdsCard,200); });
  } else {
    nukeThresholdsCard(); setTimeout(nukeThresholdsCard,200);
  }
})();
</script>
<script>
// Micro-patch: remove stray "Band Thresholds" heading line if any remains.
(function(){
  function stripHeading(){
    var nodes = Array.prototype.slice.call(document.querySelectorAll('*'));
    nodes.forEach(function(el){
      var txt = (el.textContent || '').trim();
      if (/^Band\s*Thresholds/i.test(txt)) {
        // Ensure we're not touching 'Payout by Band' or 'Pay Bands'
        var ctx = (el.closest('.card') || el.parentElement);
        var ctxText = (ctx && ctx.textContent) ? ctx.textContent : '';
        if (!/Payout by Band/i.test(ctxText) && !/Pay Bands/i.test(ctxText)) {
          el.remove();
        }
      }
    });
  }
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', function(){ stripHeading(); setTimeout(stripHeading,150); });
  } else {
    stripHeading(); setTimeout(stripHeading,150);
  }
})();
</script>
<script>
/* Text-node level removal for "Band Thresholds" label lines */
(function(){
  function stripTextNodes(){
    // Look inside the settings column only (right-hand side)
    var roots = Array.prototype.slice.call(document.querySelectorAll('.card, section, article, div'));
    roots.forEach(function(root){
      var txtAll = (root.textContent||'');
      if(/Payout by Band/i.test(txtAll) || /Pay Bands/i.test(txtAll) || /Global Bonus Settings/i.test(txtAll)){
        // stay within this container but do not remove these sections
        return;
      }
      // Walk all child nodes and remove text nodes that equal "Band Thresholds ..." line
      var walker = document.createTreeWalker(root, NodeFilter.SHOW_TEXT, null, false);
      var removals = [];
      while(walker.nextNode()){
        var node = walker.currentNode;
        var t = (node.nodeValue || '').replace(/\s+/g,' ').trim();
        if(/^Band\s*Thresholds(\s*—\s*R\/Y\/G)?$/i.test(t)){
          removals.append(node);
        }
      }
      removals.forEach(function(n){
        try{ n.parentNode.removeChild(n); }catch(e){}
      });
    });
  }
  function run(){ try{ stripTextNodes(); }catch(e){} }
  if(document.readyState==='loading'){
    document.addEventListener('DOMContentLoaded', function(){ run(); setTimeout(run,200); });
  } else { run(); setTimeout(run,200); }
})();
</script>
<script>
// Watch + remove any "Band Thresholds — R/Y/G" label that may re-render later.
(function(){
  function killNode(node){
    try{ node.remove(); }catch(e){ if(node.parentNode){ try{ node.parentNode.removeChild(node);}catch(_){ node.nodeValue=''; } } }
  }
  function looksLikeBandHeadingText(t){
    if(!t) return false;
    t = String(t).replace(/\s+/g,' ').trim();
    return /^Band\s*Thresholds(?:\s*—\s*R\/Y\/G)?$/i.test(t);
  }
  function sweep(root){
    // 1) element nodes with heading text
    var all = root.querySelectorAll ? root.querySelectorAll('*') : [];
    for(var i=0;i<all.length;i++){
      var el = all[i];
      var txt = (el.textContent||'').replace(/\s+/g,' ').trim();
      if(looksLikeBandHeadingText(txt)){
        // ensure not part of payout or pay bands blocks
        var ctx = el.closest('.card') || el.parentElement;
        var ctxText = (ctx && ctx.textContent) ? ctx.textContent : '';
        if(!/Payout by Band/i.test(ctxText) && !/Pay Bands/i.test(ctxText) && !/Global Bonus Settings/i.test(ctxText)){
          // remove this element
          killNode(el);
          // remove trailing divider rule if any
          var ns = el.nextElementSibling;
          if(ns && (ns.tagName==='HR' || /divider|rule|separator/i.test(ns.className||''))){ killNode(ns); }
        }
      }
    }
    // 2) text nodes level
    var walker = document.createTreeWalker(root, NodeFilter.SHOW_TEXT, null, false);
    var victims = [];
    var n;
    while(n = walker.nextNode()){
      if(looksLikeBandHeadingText(n.nodeValue)){
        victims.push(n);
      }
    }
    victims.forEach(function(tn){
      // also nuke a following hr if it exists
      var el = tn.parentNode;
      if(el){
        // if the text node is the only child, remove the element
        if(el.childNodes.length===1){
          killNode(el);
        }else{
          try{ el.removeChild(tn); }catch(e){ tn.nodeValue=''; }
        }
        var ns = el.nextElementSibling;
        if(ns && (ns.tagName==='HR' || /divider|rule|separator/i.test(ns.className||''))){ killNode(ns); }
      }else{
        tn.nodeValue='';
      }
    });
  }

  function run(){ sweep(document.body || document); }

  if(document.readyState==='loading'){
    document.addEventListener('DOMContentLoaded', run);
  } else { run(); }
  // Mutation observer to catch later re-renders
  var mo = new MutationObserver(function(muts){
    for(var i=0;i<muts.length;i++){
      var m = muts[i];
      if(m.addedNodes){
        for(var j=0;j<m.addedNodes.length;j++){
          var node = m.addedNodes[j];
          if(node.nodeType===3){
            if(looksLikeBandHeadingText(node.nodeValue)){ node.nodeValue=''; }
          }else if(node.nodeType===1){
            sweep(node);
          }
        }
      }
    }
  });
  mo.observe(document.body || document, { childList:true, subtree:true, characterData:true });
})();
</script>
<script>
/* Failsafe: if Executive tab shows empty, auto-trigger demo seeding */
(function(){
  function text(el){ return (el && (el.textContent||'')).trim(); }
  function findSeedButton(root){
    var buttons = (root||document).querySelectorAll('button, .btn');
    for(var i=0;i<buttons.length;i++){
      if(/seed\s*exec/i.test(text(buttons[i]))) return buttons[i];
    }
    return null;
  }
  function execLooksEmpty(){
    // heuristic: no numbers rendered in metric tiles, empty managers list, or pillar table rows
    var execPanel = document.querySelector('.exec, #exec, [data-pane="exec"]') || document;
    var hasTiles = execPanel.querySelectorAll('.kpi, .tile, .metric, .leaders li, .leaders .row, table tr').length > 8;
    var hasNumbers = /\d/.test((execPanel.textContent||''));
    // If panel exists but either has very few items or no digits, treat as empty
    return !hasTiles || !hasNumbers;
  }
  function ensureExecSeeds(){
    try{
      // only act if we're on Executive view or it is visible
      var execTabVisible = false;
      var execPanel = document.querySelector('.exec, #exec, [data-pane="exec"]');
      if(execPanel){
        var style = getComputedStyle(execPanel);
        execTabVisible = style && style.display !== 'none' && style.visibility !== 'hidden';
      }
      if(!execPanel) execTabVisible = true; // some builds use single-page panels
      if(!execTabVisible) return;
      if(!execLooksEmpty()) return;

      var btn = findSeedButton(document);
      if(btn){
        btn.click();
      } else if (window.seedExecutiveDemo) {
        try{ window.seedExecutiveDemo(); }catch(e){}
      }
    }catch(e){}
  }

  // Run after load and shortly after
  if(document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', function(){
      setTimeout(ensureExecSeeds, 250);
      setTimeout(ensureExecSeeds, 1000);
    });
  } else {
    setTimeout(ensureExecSeeds, 250);
    setTimeout(ensureExecSeeds, 1000);
  }

  // When user clicks the Executive tab, try again
  document.addEventListener('click', function(e){
    var t = e.target;
    var label = (t && (t.textContent||'')).trim();
    if(/^\s*Executive\s*$/i.test(label) || (t && (t.matches && t.matches('[data-tab="exec"], #exec-tab, .nav-exec')))){
      setTimeout(ensureExecSeeds, 200);
      setTimeout(ensureExecSeeds, 800);
    }
  });
})();
</script>
<!-- removed old injected exec block -->
<section class="container" id="als-exec-injected" style="margin-top:18px">
<h3 class="card-title" style="margin:0 0 8px">Executive Roll‑up (Demo — Injected)</h3>
<div id="als-exec-injected-host"></div>
</section>
<script>
(function(){
  function rnd(a,b){ return Math.round(a + Math.random()*(b-a)); }
  function band(s){ return s<60?'red':(s<75?'yellow':'green'); }
  function buildDemo(){
    var regions=['East','West','North','South'];
    var depts=['Operations','Maintenance','Quality','Safety'];
    var sites=['Wilmington','Chicago','LA','Seattle','Atlanta','Philly'];
    var names=['Jordan Lee','Avery Chen','Riley Patel','Casey Smith','Morgan Diaz','Taylor Brooks','Alex Nguyen','Jamie Park','Sam Rivera','Cameron Lee','Quinn Hall','Drew Fox'];
    var tiers=[58,66,72,78,84,91,62,69,76,83,88,95];
    var leaders = names.map(function(n,i){
      return {name:n, region:regions[i%4], dept:depts[i%4], site:sites[i%6], score: tiers[i%tiers.length] + rnd(-2,2)};
    });
    var pillars=['Safety Integrity & Culture','Servant Leadership & Development','Operational Delivery & Quality','Regulatory Compliance & Governance','People & Resource Stewardship','CI Culture & Improvement'];
    var baseline=[62,73,81,69,88,77];
    var pillarRows = pillars.map(function(p,i){ return {pillar:p, avg: Math.max(50, Math.min(100, baseline[i%6] + rnd(-3,3)))}; });
    var avg = Math.round(leaders.reduce((a,b)=>a+b.score,0)/leaders.length);
    var dist = {red:0,yellow:0,green:0}; leaders.forEach(function(l){ dist[band(l.score)]++; });
    return {leaders:leaders, pillarRows:pillarRows, avg:avg, dist:dist};
  }
  function paint(){
    var host = document.getElementById('als-exec-injected-host');
    if(!host) return;
    var data = buildDemo();
    host.innerHTML = `
      <div style="display:grid;grid-template-columns:repeat(12,1fr);gap:12px">
        <div style="grid-column: span 4" class="card"><div class="card-title">Avg Weighted Total</div>
          <div style="font-size:42px;font-weight:800;padding:8px 12px">${data.avg}</div>
          <div style="opacity:.75;padding:0 12px">Band: ${data.avg<60?'red':(data.avg<75?'yellow':'green')}</div>
        </div>
        <div style="grid-column: span 4" class="card"><div class="card-title">Tier Distribution</div>
          <div style="padding:8px 12px">red <b>${data.dist.red}</b> · yellow <b>${data.dist.yellow}</b> · green <b>${data.dist.green}</b></div>
        </div>
        <div style="grid-column: span 4" class="card"><div class="card-title">Managers Included</div>
          <div style="padding:8px 12px">${data.leaders.length}</div>
        </div>
        <div style="grid-column: span 7" class="card"><div class="card-title">Pillar Heatmap</div>
          <table class="table" style="width:100%;border-collapse:collapse;margin:8px 12px">
            <thead><tr><th style="text-align:left">Pillar</th><th style="text-align:right">Avg Score</th><th style="text-align:right">Band</th></tr></thead>
            <tbody>
              ${data.pillarRows.map(r=>`<tr>
                <td>${r.pillar}</td>
                <td style="text-align:right">${r.avg}</td>
                <td style="text-align:right">${r.avg<60?'red':(r.avg<75?'yellow':'green')}</td>
              </tr>`).join('')}
            </tbody>
          </table>
        </div>
        <div style="grid-column: span 5" class="card"><div class="card-title">Top Leaders</div>
          <div style="padding:8px 12px">
            ${data.leaders.slice().sort((a,b)=>b.score-a.score).slice(0,6).map(l=>`
              <div style="display:flex;gap:12px;align-items:center;justify-content:space-between;padding:6px 0;border-bottom:1px solid var(--border,rgba(255,255,255,.08))">
                <div>${l.name}</div>
                <div style="opacity:.8;flex:1;text-align:center">${l.region} • ${l.dept}</div>
                <div><span class="score-chip" style="display:inline-block;min-width:40px;text-align:center;border:1px solid var(--border,rgba(255,255,255,.2));border-radius:999px;padding:2px 8px;font-weight:700">${l.score}</span></div>
              </div>`).join('')}
          </div>
        </div>
      </div>`;
  }
  if (document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', function(){ paint(); setTimeout(paint, 250); });
  } else { paint(); setTimeout(paint, 250); }
})();
</script>
<script>
/* === ALS Executive Targeted Seeding =========================================
   Finds the EXISTING Executive containers and paints the demo data INSIDE them.
   If an earlier 'injected' section exists, it is removed.
=============================================================================*/
(function(){
  function byText(nodes, keys){
    keys = keys.map(k=>k.toLowerCase());
    for (var i=0;i<nodes.length;i++){
      var t = (nodes[i].textContent||'').trim().toLowerCase();
      for (var k of keys){ if (t.indexOf(k) !== -1) return nodes[i]; }
    }
    return null;
  }
  function findCardByTitle(keys){
    var titles = document.querySelectorAll('.card-title, .title, h3, h4, h5');
    var hit = byText(titles, keys);
    if (!hit) return null;
    return hit.closest('.card') || hit.parentElement;
  }
  function ensureBody(card){
    if (!card) return null;
    var body = card.querySelector('.card-body');
    if (!body){
      body = document.createElement('div');
      body.className = 'card-body';
      card.appendChild(body);
    } else {
      body.innerHTML = '';
    }
    return body;
  }
  function rnd(a,b){ return Math.round(a + Math.random()*(b-a)); }
  function band(s){ return s<60?'red':(s<75?'yellow':'green'); }
  function buildDemo(){
    var regions=['East','West','North','South'];
    var depts=['Operations','Maintenance','Quality','Safety'];
    var sites=['Wilmington','Chicago','LA','Seattle','Atlanta','Philly'];
    var names=['Jordan Lee','Avery Chen','Riley Patel','Casey Smith','Morgan Diaz','Taylor Brooks','Alex Nguyen','Jamie Park','Sam Rivera','Cameron Lee','Quinn Hall','Drew Fox'];
    var tiers=[58,66,72,78,84,91,62,69,76,83,88,95];
    var leaders = names.map(function(n,i){
      return {name:n, region:regions[i%4], dept:depts[i%4], site:sites[i%6], score: tiers[i%tiers.length] + rnd(-2,2)};
    });
    var pillars=['Safety Integrity & Culture','Servant Leadership & Development','Operational Delivery & Quality','Regulatory Compliance & Governance','People & Resource Stewardship','CI Culture & Improvement'];
    var baseline=[62,73,81,69,88,77];
    var pillarRows = pillars.map(function(p,i){ return {pillar:p, avg: Math.max(50, Math.min(100, baseline[i%6] + rnd(-3,3)))}; });
    var avg = Math.round(leaders.reduce((a,b)=>a+b.score,0)/leaders.length);
    var dist = {red:0,yellow:0,green:0}; leaders.forEach(function(l){ dist[band(l.score)]++; });
    return {leaders:leaders, pillarRows:pillarRows, avg:avg, dist:dist};
  }

  function paintExec(){
    // Remove previously injected standalone section if present
    var injected = document.getElementById('als-exec-injected');
    if (injected && injected.parentNode) injected.parentNode.removeChild(injected);

    // Identify existing executive grid cards by title text
    var avgCard = findCardByTitle(['avg weighted total']);
    var tierCard = findCardByTitle(['tier distribution']);
    var mgrCard = findCardByTitle(['managers included']);
    var heatCard = findCardByTitle(['pillar heatmap']);
    var leadCard = findCardByTitle(['top leaders']);

    if (!(avgCard && tierCard && mgrCard && heatCard && leadCard)) return; // nothing to do

    var data = buildDemo();

    // Avg
    var avgBody = ensureBody(avgCard);
    avgBody.innerHTML = '<div style="font-size:42px;font-weight:800;">'+data.avg+'</div>'
      + '<div style="opacity:.75">Band: '+(data.avg<60?'red':(data.avg<75?'yellow':'green'))+'</div>';

    // Tier distribution
    var td = ensureBody(tierCard);
    td.innerHTML = 'red <b>'+data.dist.red+'</b> · yellow <b>'+data.dist.yellow+'</b> · green <b>'+data.dist.green+'</b>';

    // Managers included
    var mi = ensureBody(mgrCard);
    mi.textContent = String(data.leaders.length);

    // Pillar heatmap
    var ph = ensureBody(heatCard);
    ph.innerHTML = '<table class="table" style="width:100%;border-collapse:collapse">'
      + '<thead><tr><th style="text-align:left">Pillar</th><th style="text-align:right">Avg Score</th><th style="text-align:right">Band</th></tr></thead>'
      + '<tbody>' + data.pillarRows.map(function(r){
          return '<tr><td>'+r.pillar+'</td><td style="text-align:right">'+r.avg+'</td><td style="text-align:right">'+(r.avg<60?'red':(r.avg<75?'yellow':'green'))+'</td></tr>';
        }).join('')
      + '</tbody></table>';

    // Top leaders
    var tl = ensureBody(leadCard);
    tl.innerHTML = data.leaders.slice().sort(function(a,b){return b.score-a.score;}).slice(0,6).map(function(l){
      return '<div style="display:flex;gap:12px;align-items:center;justify-content:space-between;padding:6px 0;border-bottom:1px solid var(--border,rgba(255,255,255,.08))">'
         + '<div>'+l.name+'</div>'
         + '<div style="opacity:.8;flex:1;text-align:center">'+l.region+' • '+l.dept+'</div>'
         + '<div><span class="score-chip" style="display:inline-block;min-width:40px;text-align:center;border:1px solid var(--border,rgba(255,255,255,.2));border-radius:999px;padding:2px 8px;font-weight:700">'+l.score+'</span></div>'
         + '</div>';
    }).join('');
  }

  function ready(fn){ if(document.readyState==='loading') document.addEventListener('DOMContentLoaded', fn); else fn(); }
  ready(function(){
    paintExec();
    // Repaint on clicking "Seed Exec Demo" or switching tabs
    document.addEventListener('click', function(e){
      var t=(e.target.textContent||'').trim().toLowerCase();
      if(t==='seed exec demo' || t==='executive') setTimeout(paintExec, 50);
    });
  });
})();
</script>
<script>
/* === ALS Executive Rich Seeder (filters-aware, varied bands & trends) ========
   - Seeds a global dataset of managers with Region, Department, Site, Position.
   - Ensures coverage across bands (red/yellow/green) in every filter slice.
   - Repaints Executive cards on filter change and on "Seed Exec Demo".
=============================================================================*/
(function(){
  // Utility
  const rnd = (a,b)=>Math.round(a+Math.random()*(b-a));
  const clamp = (v,a,b)=>Math.max(a,Math.min(b,v));
  const band = s => s<60 ? 'red' : (s<75 ? 'yellow' : 'green');

  // Domains
  const REGIONS = ['East','West','North','South'];
  const DEPTS   = ['Operations','Maintenance','Quality','Safety'];
  const POS     = ['Manager','Supervisor','Specialist'];
  const SITES   = {
    East: ['Wilmington','Philly','Boston'],
    West: ['LA','Seattle','San Jose'],
    North:['Chicago','Detroit','Minneapolis'],
    South:['Atlanta','Dallas','Houston']
  };
  const PILLARS = [
    'Safety Integrity & Culture',
    'Servant Leadership & Development',
    'Operational Delivery & Quality',
    'Regulatory Compliance & Governance',
    'People & Resource Stewardship',
    'CI Culture & Improvement'
  ];

  // Names (repeat if needed)
  const NAMES = ['Jordan Lee','Avery Chen','Riley Patel','Casey Smith','Morgan Diaz','Taylor Brooks','Alex Nguyen','Jamie Park','Sam Rivera','Cameron Lee','Quinn Hall','Drew Fox','Harper Reed','Reese Martin','Parker James','Rowan Blake','Skylar Cruz','Devin Scott','Eden Wells','Dakota Lane','River Gray','Remy Collins','Shay Morgan','Blair Ellis','Kendall Roy','Charlie West','Taylor Reed','Bailey Quinn','Finley Hart','Logan Snow','Sage Porter','Ari Brooks','Jules Monroe','Kai Turner','Noa Hayes','Zion Pierce','Emery Lane','Lane Avery','Peyton Cole','Hayden Park','Robin Blake','Luca West','Micah Shaw','Rory Dean','Ari Fox','Ainsley Ford','Ellis Lowe','Keegan Rhodes','Rowe Nash','Lane Hart'];

  // Create a stratified dataset with varied bands per slice
  function makeDataset(targetCount=72){
    const rows = [];
    let idx = 0;

    // Build per-region x dept x position grid, stagger bands
    REGIONS.forEach((region,ri)=>{
      DEPTS.forEach((dept,di)=>{
        POS.forEach((pos,pi)=>{
          // three managers per site (varied bands) ensures diversity
          SITES[region].forEach((site, si)=>{
            const count = 1; // one per site x pos x dept ~ 36*? -> keep manageable
            for(let k=0;k<count;k++){
              const name = NAMES[idx % NAMES.length]; idx++;
              // cycle bands deterministically, then add jitter
              const baseTier = (ri+di+pi+si+k)%3; // 0,1,2 => red,yellow,green
              let scoreBase = baseTier===0 ? rnd(52,59) : (baseTier===1 ? rnd(66,74) : rnd(80,92));
              // create pillar profile around scoreBase with noise
              const pillars = PILLARS.map((p,i)=>clamp(scoreBase + rnd(-10,10) + (i%2?rnd(-2,2):0), 40, 100));
              // 12-week lookback & forecast with slight trend
              const trendDelta = rnd(-6,6);
              const lookback = Array.from({length:12}, (_,i)=>clamp(scoreBase + rnd(-4,4) - Math.floor((11-i)/6) + rnd(-1,1), 40, 100));
              const forecast = Array.from({length:12}, (_,i)=>clamp(lookback[11] + Math.round((trendDelta/12)*(i+1)) + rnd(-2,2), 40, 100));

              rows.push({
                name, region, dept, site, pos,
                score: clamp(Math.round(pillars.reduce((a,b)=>a+b,0)/pillars.length), 40, 100),
                pillars, lookback, forecast
              });
            }
          });
        });
      });
    });

    // If too many, trim; if too few, duplicate with jitter
    while(rows.length>targetCount) rows.pop();
    while(rows.length<targetCount){
      const base = rows[rnd(0, rows.length-1)];
      const copy = JSON.parse(JSON.stringify(base));
      copy.name = NAMES[idx % NAMES.length]; idx++;
      copy.score = clamp(copy.score + rnd(-5,5), 40, 100);
      copy.pillars = copy.pillars.map(v=>clamp(v + rnd(-5,5), 40, 100));
      rows.push(copy);
    }
    return rows;
  }

  // Global store
  const STORE = { managers: makeDataset(96) };

  // Helpers to find Executive controls
  function findSelectByLabel(text){
    const labels = Array.from(document.querySelectorAll('label, .label, .card-title, span, div'));
    const target = labels.find(el => (el.textContent||'').trim().toLowerCase() === text.toLowerCase());
    if(!target) return null;
    const sel = target.parentElement.querySelector('select') || target.closest('div')?.querySelector('select');
    return sel || null;
  }
  function getExecFilters(){
    // Fallback to the four selects in the Exec toolbar (by order) if labels aren't available
    const toolbar = document.querySelectorAll('select');
    let regionSel, deptSel, posSel, siteSel;

    // Prefer matching by name/id if present
    regionSel = document.querySelector('select#region') || Array.from(toolbar).find(s=>/region/i.test(s.previousSibling?.textContent||'')) || toolbar[0];
    posSel    = document.querySelector('select#position') || Array.from(toolbar).find(s=>/position/i.test(s.previousSibling?.textContent||'')) || toolbar[1];
    deptSel   = document.querySelector('select#department') || Array.from(toolbar).find(s=>/department/i.test(s.previousSibling?.textContent||'')) || toolbar[2];
    siteSel   = document.querySelector('select#site') || Array.from(toolbar).find(s=>/site/i.test(s.previousSibling?.textContent||'')) || toolbar[3];

    return { regionSel, deptSel, posSel, siteSel };
  }

  // Paint into existing exec cards (re-uses previous targeted painter, but filter-aware)
  function findCardByTitle(keys){
    const titles = document.querySelectorAll('.card-title, .title, h3, h4, h5');
    keys = keys.map(k=>k.toLowerCase());
    for (let i=0;i<titles.length;i++){
      const t = (titles[i].textContent||'').trim().toLowerCase();
      if (keys.some(k=>t.includes(k))) return titles[i].closest('.card') || titles[i].parentElement;
    }
    return null;
  }
  function ensureBody(card){
    if (!card) return null;
    let body = card.querySelector('.card-body');
    if (!body){
      body = document.createElement('div');
      body.className = 'card-body';
      card.appendChild(body);
    } else {
      body.innerHTML = '';
    }
    return body;
  }

  function applyFilters(rows){
    const { regionSel, deptSel, posSel, siteSel } = getExecFilters();
    const region = (regionSel && regionSel.value) || 'All Regions';
    const dept   = (deptSel && deptSel.value)   || 'All Departments';
    const pos    = (posSel && posSel.value)     || 'All Positions';
    const site   = (siteSel && siteSel.value)   || 'All Sites';

    return rows.filter(r =>
      (region==='All Regions'     || r.region===region) &&
      (dept  ==='All Departments' || r.dept  ===dept)   &&
      (pos   ==='All Positions'   || r.pos   ===pos)    &&
      (site  ==='All Sites'       || r.site  ===site)
    );
  }

  function paintExec(){
    const rows = applyFilters(STORE.managers);
    if (!rows.length) return;

    // Cards
    const avgCard  = findCardByTitle(['avg weighted total']);
    const tierCard = findCardByTitle(['tier distribution']);
    const mgrCard  = findCardByTitle(['managers included']);
    const heatCard = findCardByTitle(['pillar heatmap']);
    const leadCard = findCardByTitle(['top leaders']);

    if (!(avgCard && tierCard && mgrCard && heatCard && leadCard)) return;

    // Aggregates
    const avg = Math.round(rows.reduce((a,b)=>a+b.score,0)/rows.length);
    const dist = {red:0,yellow:0,green:0}; rows.forEach(r=>dist[band(r.score)]++);
    const pillarAvgs = PILLARS.map((p,i)=>{
      const s = rows.reduce((a,b)=>a+(b.pillars[i]||0),0);
      return Math.round(s/rows.length);
    });

    // Avg
    const avgBody = ensureBody(avgCard);
    avgBody.innerHTML = `<div style="font-size:42px;font-weight:800;">${avg}</div>
      <div style="opacity:.75">Band: ${band(avg)}</div>`;

    // Tier distribution
    const td = ensureBody(tierCard);
    td.innerHTML = `<div class="kpi-legend"><span class="kpi-dot r"></span>Red <b>${dist.red}</b> <span style="margin:0 6px">·</span><span class="kpi-dot y"></span>Yellow <b>${dist.yellow}</b> <span style="margin:0 6px">·</span><span class="kpi-dot g"></span>Green <b>${dist.green}</b></div>`;

    // Managers included
    const mi = ensureBody(mgrCard);
    mi.textContent = String(rows.length);

    // Pillar heatmap
    const ph = ensureBody(heatCard);
    ph.innerHTML = `<table class="table" style="width:100%;border-collapse:collapse">
      <thead><tr><th style="text-align:left">Pillar</th><th style="text-align:right">Avg Score</th><th style="text-align:right">Band</th></tr></thead>
      <tbody>
        ${pillarAvgs.map((v,i)=>`<tr><td>${PILLARS[i]}</td><td style="text-align:right">${v}</td><td style="text-align:right"><span class="band band-chip ${band(v)}">${band(v)}</span></td></tr>`).join('')}
      </tbody></table>`;

    // Top leaders
    const tl = ensureBody(leadCard);
    const top = rows.slice().sort((a,b)=>b.score-a.score).slice(0,6);
    tl.innerHTML = top.map(l=>`
      <div style="display:flex;gap:12px;align-items:center;justify-content:space-between;padding:6px 0;border-bottom:1px solid var(--border,rgba(255,255,255,.08))">
        <div>${l.name}</div>
        <div style="opacity:.8;flex:1;text-align:center">${l.region} • ${l.dept} • ${l.pos} • ${l.site}</div>
        <div><span class="score-chip" style="display:inline-block;min-width:40px;text-align:center;border:1px solid var(--border,rgba(255,255,255,.2));border-radius:999px;padding:2px 8px;font-weight:700">${l.score}</span></div>
      </div>`).join('');
  }

  // Hook: filter changes + "Seed Exec Demo" button
  function bindExec(){
    const { regionSel, deptSel, posSel, siteSel } = getExecFilters();
    [regionSel, deptSel, posSel, siteSel].forEach(sel => {
      if(!sel) return;
      sel.addEventListener('change', ()=> setTimeout(paintExec, 10));
    });
    document.addEventListener('click', (e)=>{
      const t=(e.target.textContent||'').trim().toLowerCase();
      if(t==='seed exec demo' || t==='executive') setTimeout(paintExec, 10);
    });
  }

  function ready(fn){ if(document.readyState==='loading') document.addEventListener('DOMContentLoaded', fn); else fn(); }
  ready(function(){
    bindExec();
    paintExec();
    setTimeout(paintExec, 150);
  });
})();
</script>
<script>
/* === ALS Executive Seeder v2 (scoped to Exec section; robust selectors) === */
(function(){
  const rnd = (a,b)=>Math.round(a+Math.random()*(b-a));
  const clamp=(v,a,b)=>Math.max(a,Math.min(b,v));
  const band = s => s<60?'red':(s<75?'yellow':'green');

  const REGIONS=['East','West','North','South'];
  const DEPTS=['Operations','Maintenance','Quality','Safety'];
  const POS=['Manager','Supervisor','Specialist'];
  const SITES={East:['Wilmington','Philly','Boston'],West:['LA','Seattle','San Jose'],North:['Chicago','Detroit','Minneapolis'],South:['Atlanta','Dallas','Houston']};
  const PILLARS=['Safety Integrity & Culture','Servant Leadership & Development','Operational Delivery & Quality','Regulatory Compliance & Governance','People & Resource Stewardship','CI Culture & Improvement'];
  const N=['Jordan Lee','Avery Chen','Riley Patel','Casey Smith','Morgan Diaz','Taylor Brooks','Alex Nguyen','Jamie Park','Sam Rivera','Cameron Lee','Quinn Hall','Drew Fox','Harper Reed','Reese Martin','Parker James','Rowan Blake','Skylar Cruz','Devin Scott','Eden Wells','Dakota Lane','River Gray','Remy Collins','Shay Morgan','Blair Ellis','Kendall Roy','Charlie West','Taylor Reed','Bailey Quinn','Finley Hart','Logan Snow','Sage Porter','Ari Brooks','Jules Monroe','Kai Turner','Noa Hayes','Zion Pierce','Emery Lane','Lane Avery','Peyton Cole','Hayden Park','Robin Blake','Luca West','Micah Shaw','Rory Dean','Ari Fox','Ainsley Ford','Ellis Lowe','Keegan Rhodes','Rowe Nash','Lane Hart'];

  function makeDataset(){
    const rows=[]; let i=0;
    REGIONS.forEach((r,ri)=>DEPTS.forEach((d,di)=>POS.forEach((p,pi)=>SITES[r].forEach((s,si)=>{
      const baseTier=(ri+di+pi+si)%3;
      const base= baseTier===0?rnd(52,59):baseTier===1?rnd(66,74):rnd(80,92);
      const pillars=PILLARS.map((_,k)=>clamp(base+rnd(-10,10)+(k%2?rnd(-2,2):0),40,100));
      rows.push({name:N[i++%N.length],region:r,dept:d,pos:p,site:s,score:clamp(Math.round(pillars.reduce((a,b)=>a+b,0)/pillars.length),40,100),pillars});
    }))));
    return rows;
  }
  const STORE={managers:makeDataset()};

  // === Find Executive section and its controls ===
  function findExecSection(){
    // Section header contains "Executive Roll-Up"
    const headers=[...document.querySelectorAll('h1,h2,h3,h4,h5,.card-title,.title,div,span')];
    const head=headers.find(el=>/executive roll-?up/i.test(el.textContent||''));
    return head? (head.closest('section')||head.closest('.card')||head.closest('div')) : null;
  }

  function getExecControls(scope){
    let selects=[...scope.querySelectorAll('select')];
    // expect 4 selects: Region, Position, Department, Site (any order)
    function findByPlaceholder(re){ return selects.find(s=> re.test((s.previousSibling&&s.previousSibling.textContent)||s.parentElement.textContent || '')); }
    const regionSel = findByPlaceholder(/region/i) || selects[0];
    const positionSel = findByPlaceholder(/position/i) || selects[1];
    const deptSel = findByPlaceholder(/department/i) || selects[2];
    const siteSel = findByPlaceholder(/site/i) || selects[3];
    return {regionSel, positionSel, deptSel, siteSel};
  }

  function findCard(scope, key){
    const t=[...scope.querySelectorAll('.card-title,h3,h4,h5,.title,span,div')]
      .find(el=> (el.textContent||'').trim().toLowerCase().includes(key));
    return t? (t.closest('.card')||t.parentElement): null;
  }
  function ensureBody(card){
    if(!card) return null;
    let body=card.querySelector('.card-body');
    if(!body){ body=document.createElement('div'); body.className='card-body'; card.appendChild(body); }
    body.innerHTML=''; return body;
  }

  function applyFilters(rows, region, dept, pos, site){
    return rows.filter(r =>
      (region==='All Regions'||!region||r.region===region) &&
      (dept==='All Departments'||!dept||r.dept===dept) &&
      (pos==='All Positions'||!pos||r.pos===pos) &&
      (site==='All Sites'||!site||r.site===site)
    );
  }

  function paint(){
    const scope = findExecSection();
    if(!scope) return;
    const {regionSel, positionSel, deptSel, siteSel} = getExecControls(scope);
    const rows = applyFilters(STORE.managers, regionSel?.value, deptSel?.value, positionSel?.value, siteSel?.value);
    if(!rows.length) return;

    const avgCard = findCard(scope,'avg weighted total');
    const tierCard= findCard(scope,'tier distribution');
    const mgrCard = findCard(scope,'managers included');
    const heatCard= findCard(scope,'pillar heatmap');
    const leadCard= findCard(scope,'top leaders');

    const avg = Math.round(rows.reduce((a,b)=>a+b.score,0)/rows.length);
    const dist={red:0,yellow:0,green:0}; rows.forEach(r=>dist[band(r.score)]++);
    const pillarAvgs = PILLARS.map((_,i)=>Math.round(rows.reduce((a,b)=>a+(b.pillars[i]||0),0)/rows.length));

    const a=ensureBody(avgCard); if(a){ a.innerHTML=`<div style="font-size:42px;font-weight:800">${avg}</div><div style="opacity:.75">Band: ${band(avg)}</div>`; }
    const t=ensureBody(tierCard); if(t){ t.innerHTML=`<div class="kpi-legend"><span class="kpi-dot r"></span>Red <b>${dist.red}</b> <span style="margin:0 6px">·</span><span class="kpi-dot y"></span>Yellow <b>${dist.yellow}</b> <span style="margin:0 6px">·</span><span class="kpi-dot g"></span>Green <b>${dist.green}</b></div>`; }
    const m=ensureBody(mgrCard); if(m){ m.textContent=String(rows.length); }
    const h=ensureBody(heatCard); if(h){ h.innerHTML=`<table class="table" style="width:100%"><thead><tr><th style="text-align:left">Pillar</th><th style="text-align:right">Avg</th><th style="text-align:right">Band</th></tr></thead><tbody>${pillarAvgs.map((v,i)=>`<tr><td>${PILLARS[i]}</td><td style="text-align:right">${v}</td><td style="text-align:right"><span class="band band-chip ${band(v)}">${band(v)}</span></td></tr>`).join('')}</tbody></table>`; }
    const l=ensureBody(leadCard); if(l){
      const top=rows.slice().sort((a,b)=>b.score-a.score).slice(0,6);
      l.innerHTML = top.map(x=>`<div style="display:flex;gap:12px;align-items:center;justify-content:space-between;padding:6px 0;border-bottom:1px solid var(--border,rgba(255,255,255,.08))"><div>${x.name}</div><div style="opacity:.8;flex:1;text-align:center">${x.region} • ${x.dept} • ${x.pos} • ${x.site}</div><div><span class="score-chip" style="display:inline-block;min-width:40px;text-align:center;border:1px solid var(--border,rgba(255,255,255,.2));border-radius:999px;padding:2px 8px;font-weight:700">${x.score}</span></div></div>`).join('');
    }
  }

  function bind(){
    const scope=findExecSection(); if(!scope) return;
    const {regionSel, positionSel, deptSel, siteSel} = getExecControls(scope);
    [regionSel, positionSel, deptSel, siteSel].forEach(s=> s && s.addEventListener('change', ()=>setTimeout(paint,0)));
    // Seed button
    const seedBtn=[...scope.querySelectorAll('button, a')].find(b=>/seed exec demo/i.test(b.textContent||''));
    if(seedBtn) seedBtn.addEventListener('click', ()=>setTimeout(paint,0));
  }

  function ready(fn){document.readyState==='loading'?document.addEventListener('DOMContentLoaded',fn):fn();}
  ready(function(){ bind(); paint(); setTimeout(paint,150); });
})();
</script>
<script>
/* === ALS Executive Seeder v5 — robust scope/select detection, live filter repaint === */
(function(){
  // Small helpers
  const clamp=(v,a,b)=>Math.max(a,Math.min(b,v));
  const avg = arr => Math.round(arr.reduce((s,v)=>s+v,0)/arr.length);
  const band = s => s<60?'red':(s<75?'yellow':'green');
  // Seeded RNG for stable-per-slice variability
  function mulberry32(a){return function(){var t=a+=0x6D2B79F5;t=Math.imul(t^t>>>15,t|1);t^=t+Math.imul(t^t>>>7,t|61);return ((t^t>>>14)>>>0)/4294967296;}}
  function hashStr(s){let h=2166136261>>>0; for(let i=0;i<s.length;i++){h^=s.charCodeAt(i); h=Math.imul(h,16777619);} return h>>>0;}
  const PILLARS=['Safety Integrity & Culture','Servant Leadership & Development','Operational Delivery & Quality','Regulatory Compliance & Governance','People & Resource Stewardship','CI Culture & Improvement'];
  const NAMES=["Jordan Lee","Avery Chen","Riley Patel","Casey Smith","Morgan Diaz","Taylor Brooks","Alex Nguyen","Jamie Park","Sam Rivera","Cameron Lee","Quinn Hall","Drew Fox","Harper Reed","Reese Martin","Parker James","Rowan Blake","Skylar Cruz","Devin Scott","Eden Wells","Dakota Lane","River Gray","Remy Collins","Shay Morgan","Blair Ellis","Kendall Roy","Charlie West","Taylor Reed","Bailey Quinn","Finley Hart","Logan Snow","Sage Porter","Ari Brooks","Jules Monroe","Kai Turner","Noa Hayes","Zion Pierce","Emery Lane","Lane Avery","Peyton Cole","Hayden Park","Robin Blake","Luca West","Micah Shaw","Rory Dean","Ari Fox","Ainsley Ford","Ellis Lowe","Keegan Rhodes","Rowe Nash","Lane Hart","Indy Webb","Milan Cruz","Rio West","Aspen Vale","Jai Brooks","Rey Collins"];

  // 1) Find Executive scope by id/class or by presence of our 5 card titles
  function findExecScope(){
    const byCommon = document.querySelector('#exec, .exec, [data-pane="exec"]');
    if(byCommon) return byCommon;
    const candidates = Array.from(document.querySelectorAll('section, .tab-pane, .panel, .container, main, .page'));
    function score(el){
      const txt = (el.textContent||'').toLowerCase();
      let n=0;
      if(txt.includes('avg weighted total')) n++;
      if(txt.includes('tier distribution')) n++;
      if(txt.includes('managers included')) n++;
      if(txt.includes('pillar heatmap')) n++;
      if(txt.includes('top leaders')) n++;
      return n;
    }
    let best=null, bestScore=0;
    candidates.forEach(el=>{ const s=score(el); if(s>bestScore){best=el;bestScore=s;} });
    return (bestScore>=3)? best : document.body;
  }

  // 2) Get selects within the scope (any order). We use ALL selects in the exec toolbar row.
  function getExecSelects(scope){
    const selects = Array.from(scope.querySelectorAll('select'));
    // If there are many selects on the page, try to narrow to the row that contains "Tier Distribution" card (assume toolbar near it)
    if(selects.length>4){
      const t = Array.from(scope.querySelectorAll('.card-title,h3,h4')).find(e=>(e.textContent||'').toLowerCase().includes('tier distribution'));
      if(t){
        const row = t.closest('.grid, .row, section, .container') || scope;
        const local = Array.from(row.querySelectorAll('select'));
        if(local.length>=1) return local;
      }
    }
    return selects;
  }

  // Utility to read option label/value uniformly
  function optionLabel(opt){ return (opt && (opt.value || opt.text || '')).toString().trim(); }
  function optionsList(sel){ return sel? Array.from(sel.options).map(optionLabel).filter(Boolean):[]; }
  function selectedLabel(sel){ return sel && sel.selectedIndex>=0 ? optionLabel(sel.options[sel.selectedIndex]) : ''; }
  const isAll = v => /^all\s/i.test(v||'');

  // 3) Build domain from actual selects (drop "All ..."); fallback defaults if missing
  function buildDomain(ctrls){
    const [regionSel, posSel, deptSel, siteSel] = ctrls;
    const regions = optionsList(regionSel).filter(v=>!isAll(v)); if(!regions.length) regions.push('East','West','North','South');
    const depts   = optionsList(deptSel).filter(v=>!isAll(v));   if(!depts.length)   depts.push('Operations','Maintenance','Quality','Safety');
    const positions=optionsList(posSel).filter(v=>!isAll(v));    if(!positions.length) positions.push('Manager','Supervisor','Specialist');
    const sites   = optionsList(siteSel).filter(v=>!isAll(v));   if(!sites.length)   sites.push('Site A','Site B','Site C','Site D');
    return {regions,depts,positions,sites};
  }

  // 4) Make dataset deterministically from current slice key (for stable variability)
  function makeDataset(domain, key){
    const rnd = mulberry32(hashStr(key||'als-exec'));
    const rando=(a,b)=>Math.round(a + rnd()*(b-a));
    const rows=[], {regions,depts,positions,sites}=domain;
    let nameIdx=0, combo=0;
    const cap = 240;
    for(const r of regions){
      for(const d of depts){
        for(const p of positions){
          for(const s of sites){
            const tier = (combo + rando(0,2)) % 3; // rotate bands per combination
            const center = tier===0? rando(52,59) : tier===1? rando(66,74) : rando(80,92);
            const k=2;
            for(let i=0;i<k;i++){
              const pillars = PILLARS.map((_,pi)=> clamp(center + rando(-10,10) + (pi%2? rando(-2,2):0), 40, 100));
              rows.push({
                name: NAMES[nameIdx++ % NAMES.length],
                region:r, dept:d, pos:p, site:s,
                score: avg(pillars),
                pillars
              });
              if(rows.length>=cap) return rows;
            }
            combo++;
          }
        }
      }
    }
    return rows;
  }

  // 5) Paint into cards inside the scope
  function findCard(scope, key){
    const t=[...scope.querySelectorAll('.card-title,h3,h4,h5,.title,span,div')]
      .find(el=> (el.textContent||'').toLowerCase().includes(key));
    return t? (t.closest('.card')||t.parentElement): null;
  }
  function ensureBody(card){
    if(!card) return null;
    let body=card.querySelector('.card-body');
    if(!body){ body=document.createElement('div'); body.className='card-body'; card.appendChild(body); }
    body.innerHTML=''; return body;
  }

  function applyFilters(rows, ctrls){
    const [regionSel, posSel, deptSel, siteSel] = ctrls;
    const region = selectedLabel(regionSel), pos=selectedLabel(posSel), dept=selectedLabel(deptSel), site=selectedLabel(siteSel);
    return rows.filter(r =>
      (isAll(region) || !region || r.region===region) &&
      (isAll(pos)    || !pos    || r.pos===pos) &&
      (isAll(dept)   || !dept   || r.dept===dept) &&
      (isAll(site)   || !site   || r.site===site)
    );
  }

  function paint(scope, ctrls, store){
    const rows = applyFilters(store.rows, ctrls);
    if(!rows.length) return;
    const avgCard = findCard(scope,'avg weighted total');
    const tierCard= findCard(scope,'tier distribution');
    const mgrCard = findCard(scope,'managers included');
    const heatCard= findCard(scope,'pillar heatmap');
    const leadCard= findCard(scope,'top leaders');

    const overall = avg(rows.map(r=>r.score));
    const dist={red:0,yellow:0,green:0}; rows.forEach(r=>dist[band(r.score)]++);
    const pillarAvgs = PILLARS.map((_,i)=> avg(rows.map(r=>r.pillars[i])));

    const a=ensureBody(avgCard); if(a){ a.innerHTML = `<div style="font-size:42px;font-weight:800">${overall}</div><div style="opacity:.75">Band: ${band(overall)}</div>`; }
    const t=ensureBody(tierCard); if(t){ t.innerHTML = `<div class="kpi-legend"><span class="kpi-dot r"></span>Red <b>${dist.red}</b> <span style="margin:0 6px">·</span><span class="kpi-dot y"></span>Yellow <b>${dist.yellow}</b> <span style="margin:0 6px">·</span><span class="kpi-dot g"></span>Green <b>${dist.green}</b></div>`; }
    const m=ensureBody(mgrCard); if(m){ m.textContent = String(rows.length); }
    const h=ensureBody(heatCard); if(h){ h.innerHTML = `<table class="table" style="width:100%"><thead><tr><th style="text-align:left">Pillar</th><th style="text-align:right">Avg</th><th style="text-align:right">Band</th></tr></thead><tbody>${pillarAvgs.map((v,i)=>`<tr><td>${PILLARS[i]}</td><td style="text-align:right">${v}</td><td style="text-align:right"><span class="band band-chip ${band(v)}">${band(v)}</span></td></tr>`).join('')}</tbody></table>`; }
    const l=ensureBody(leadCard); if(l){
      const top = rows.slice().sort((a,b)=>b.score-a.score).slice(0,6);
      l.innerHTML = top.map(x=>`<div style="display:flex;gap:12px;align-items:center;justify-content:space-between;padding:6px 0;border-bottom:1px solid var(--border,rgba(255,255,255,.08))"><div>${x.name}</div><div style="opacity:.8;flex:1;text-align:center">${x.region} • ${x.dept} • ${x.pos} • ${x.site}</div><div><span class="score-chip" style="display:inline-block;min-width:40px;text-align:center;border:1px solid var(--border,rgba(255,255,255,.2));border-radius:999px;padding:2px 8px;font-weight:700">${x.score}</span></div></div>`).join('');
    }
  }

  function bind(){
    const scope = findExecScope();
    if(!scope) return;
    const selects = getExecSelects(scope);
    if(!selects.length) return;

    // Build domain and dataset keyed to the *current* set of filter options (so different option universes produce different populations)
    const key = JSON.stringify(selects.map(s=>optionsList(s)));
    const domain = buildDomain(selects);
    const rows = makeDataset(domain, key);
    const store = {rows, domain, key};

    // Initial paint
    paint(scope, selects, store);

    // Live repaint on ANY select change inside exec scope
    selects.forEach(sel=> sel && sel.addEventListener('change', ()=>{
      // Reuse same underlying population but change the slice; if you want a new population per selection, uncomment reseed:
      // const newKey = selects.map(s=> (s && s.value)||'').join('|');
      // Object.assign(store, {rows: makeDataset(domain, newKey)});
      paint(scope, selects, store);
    }));

    // Also repaint if DOM mutates (some SPAs rebuild the selects)
    const mo = new MutationObserver(()=>{
      const fresh = getExecSelects(scope);
      if(fresh.length && fresh[0] !== selects[0]){
        // Re-bind to new selects
        fresh.forEach(sel=> sel && sel.addEventListener('change', ()=>paint(scope, fresh, store)));
        paint(scope, fresh, store);
      }
    });
    mo.observe(scope, {childList:true, subtree:true});
  }

  if(document.readyState==='loading') document.addEventListener('DOMContentLoaded', bind);
  else bind();
})();
</script>
<script id="als-neon-enhancer-v2">
(function(){
  function bandFromText(txt){
    txt = (txt||"").toLowerCase();
    if(/green/.test(txt)) return "green";
    if(/yellow/.test(txt)) return "yellow";
    if(/red/.test(txt)) return "red";
    return null;
  }
  function applyBands(root){
    // A) Any span/div with class 'band' or 'band-chip' – ensure it carries .band.{color}
    root.querySelectorAll('.band, .band-chip').forEach(el=>{
      const b = bandFromText(el.textContent);
      el.classList.remove('red','yellow','green');
      if(b) el.classList.add(b);
    });
    // B) Pillar Heatmap: band rows based on last cell
    root.querySelectorAll('.card').forEach(card=>{
      const title = (card.querySelector('.card-title')||{}).textContent||'';
      const body = card.querySelector('.card-body');
      if(!body) return;
      if(/pillar heatmap/i.test(title)){
        body.querySelectorAll('tbody tr').forEach(tr=>{
          const bandCell = tr.querySelector('td:last-child');
          const b = bandFromText(bandCell && bandCell.textContent);
          tr.classList.remove('band-red','band-yellow','band-green');
          if(b) tr.classList.add('band-'+b);
        });
      }
      if(/avg weighted total/i.test(title)){
        const bandSpan = body.querySelector('.band, .band-chip');
        const b = bandFromText(bandSpan && bandSpan.textContent);
        card.classList.remove('band-red','band-yellow','band-green');
        if(b) card.classList.add('band-'+b);
      }
    });
  }
  const run = ()=> requestAnimationFrame(()=>applyBands(document));
  if(document.readyState==='loading') document.addEventListener('DOMContentLoaded', run);
  else run();
  const mo = new MutationObserver(run);
  mo.observe(document.body, {subtree:true, childList:true});
})();
</script>
<script id="als-neon-chip-scanner">
(function(){
  function parseNum(s){
    if(s==null) return NaN;
    const m = String(s).replace(/[, %]/g,'').match(/-?\d+(?:\.\d+)?/);
    return m ? parseFloat(m[0]) : NaN;
  }
  function bandFromText(t){
    if(!t) return null;
    t = t.toLowerCase();
    if(t.includes('green')) return 'green';
    if(t.includes('amber') || t.includes('yellow')) return 'yellow';
    if(t.includes('red')) return 'red';
    return null;
  }
  function bandFromNumber(n){
    if(isNaN(n)) return null;
    if(n < 50) return 'red';
    if(n < 75) return 'yellow';
    return 'green';
  }
  function setChip(el, band){
    if(!el || !band) return;
    el.classList.remove('is-green','is-yellow','is-red');
    el.classList.add('is-'+band);
  }
  function setRow(tr, band){
    if(!tr || !band) return;
    tr.classList.remove('band-green','band-yellow','band-red');
    tr.classList.add('band-'+band);
  }
  function setCard(card, band){
    if(!card || !band) return;
    card.classList.remove('band-green','band-yellow','band-red');
    card.classList.add('band-'+band);
  }
  function scan(scope){
    scope = scope || document;
    scope.querySelectorAll('.score-chip, .chip, .badge, .pill, .kpi .score > *, .kpi .chip').forEach(ch=>{
      let band = bandFromText(ch.textContent);
      if(!band) band = bandFromNumber(parseNum(ch.textContent));
      setChip(ch, band);
    });
    scope.querySelectorAll('table tbody tr').forEach(tr=>{
      let band = null;
      const bandCell = tr.querySelector('.band, .status, .tier');
      if(bandCell) band = bandFromText(bandCell.textContent);
      if(!band){
        const last = tr.querySelector('td:last-child');
        if(last) band = bandFromNumber(parseNum(last.textContent));
      }
      if(band) setRow(tr, band);
    });
    scope.querySelectorAll('.avg-weighted-total, .summary-total, .overall, .total-card, .kpi-total, .summary .big-num, .summary .value').forEach(el=>{
      const n = parseNum(el.textContent);
      const band = bandFromNumber(n);
      const card = el.closest('.card, .panel, .tile, .widget, .box');
      if(card) setCard(card, band);
    });
  }
  const repaint = ()=> requestAnimationFrame(()=>scan(document));
  if(document.readyState==='loading') document.addEventListener('DOMContentLoaded', repaint); else repaint();
  new MutationObserver(repaint).observe(document.body, {childList:true, subtree:true, characterData:true});
  window.addEventListener('resize', repaint);
})();
</script>
<script id="als-exec-visual-boost-js">
(function(){
  function findExecRoot(){
    var sel = '[data-tab="executive"], [data-view="executive"], #executive, .executive';
    return document.querySelector(sel) || null;
  }
  function tagExec(){
    var root = findExecRoot();
    if(!root) return;
    if(!root.classList.contains('exec-surface')) root.classList.add('exec-surface');

    // upgrade cards inside exec with a subtle neon frame
    root.querySelectorAll('.card, .panel, .box, .tile, .widget, .container').forEach(function(c){
      c.classList.add('exec-card');
    });

    // trend / forecast sections: find by heading text and add styling + legend if missing
    var candidates = Array.prototype.slice.call(root.querySelectorAll('.card, .panel, .box, .tile'));
    candidates.forEach(function(card){
      var tEl = card.querySelector('h2,h3');
      var t = tEl ? (tEl.textContent || '') : '';
      if(/trend|look\s*back|lookback|forecast|projection/i.test(t)){
        card.classList.add('trend-visual');
        if(!card.querySelector('.trend-legend')){
          /* removed ghost legend builder */
          (card.querySelector('.card-body') || card)/* removed ghost legend append */
        }
      }
    });
  }
  var kick = function(){ requestAnimationFrame(tagExec); };
  if(document.readyState==='loading'){ document.addEventListener('DOMContentLoaded', kick); } else { kick(); }
  new MutationObserver(kick).observe(document.body, {childList:true, subtree:true, characterData:true});
})();
</script>
<style>
  :root{
    --als-lookback:#39c7ff;   /* cyan */
    --als-forecast:#ffbe3b;   /* amber */
    --als-title-glow: 0 0 18px rgba(57,199,255,.35);
  }
  .als-title { position: relative; letter-spacing:.2px; text-shadow: var(--als-title-glow); }
  .als-title::after{ content:""; position:absolute; left:0; bottom:-8px; width:72px; height:2px;
    background: linear-gradient(90deg,var(--als-lookback),transparent); border-radius:2px;
    filter: drop-shadow(0 0 6px rgba(57,199,255,.6)); }
  .als-legend { position:absolute; right:18px; top: 1pt; display:flex; gap:14px; align-items:center;
    padding:6px 12px; border-radius:14px; background: rgba(10,18,32,.55);
    box-shadow: inset 0 0 0 1px rgba(255,255,255,.04), 0 10px 30px rgba(0,0,0,.25);
    backdrop-filter: blur(6px); z-index: 3; }
  .als-dot{width:10px; height:10px; border-radius:50%;}
  .als-dot.lookback{ background: var(--als-lookback); box-shadow:0 0 10px var(--als-lookback);}
  .als-dot.forecast{ background: var(--als-forecast); box-shadow:0 0 10px var(--als-forecast);}
  .als-legend span{ font-size:.86rem; opacity:.9 }
  .als-trend svg path.lookback{ stroke: var(--als-lookback)!important;
    filter: drop-shadow(0 0 6px rgba(57,199,255,.5)); }
  .als-trend svg path.forecast{ stroke: var(--als-forecast)!important; stroke-dasharray:4 8!important;
    filter: drop-shadow(0 0 6px rgba(255,190,59,.45)); }
  .als-trend .regenerate-btn,
  .als-trend button[title*="Regenerate"],
  .als-trend .btn-regenerate { display:none!important; }
</style>
<script>
(() => {
  function findPerfCards() {
    const cards = [];
    const headers = Array.from(document.querySelectorAll('h1,h2,h3,h4'));
    headers.forEach(h => {
      const t = (h.textContent||"").trim().toLowerCase();
      if (t.includes('performance') && t.includes('bonus') && t.includes('insights')) {
        const card = h.closest('[class*="card"],[class*="panel"],section,div');
        if (card && !cards.includes(card)) cards.push(card);
      }
    });
    return cards;
  }
  function findTrendArea(perfCard){
    const labelMatch = Array.from(perfCard.querySelectorAll('*'))
      .find(el => /12.*week.*lookback.*forecast/i.test((el.textContent||'').replace(/\s+/g,' ')));
    if (!labelMatch) return null;
    let box = labelMatch.closest('[class*="card"],[class*="panel"],[class*="box"]');
    if (!box) box = labelMatch.parentElement;
    if (box) box.style.position = 'relative';
    box.classList.add('als-trend');
    return box;
  }
  function ensureLegend(trendBox){
    if (!trendBox || trendBox.querySelector('.als-legend')) return;
    const legend = document.createElement('div');
    legend.className = 'als-legend';
    legend.innerHTML = `<div style="display:flex;gap:12px;align-items:center;">
        <span class="als-dot lookback"></span><span>Lookback</span>
        <span class="als-dot forecast" style="margin-left:10px;"></span><span>Forecast</span>
      </div>`;
    trendBox/* removed ghost legend append */
    Array.from(trendBox.querySelectorAll('button'))
      .filter(btn => /regenerate/i.test(btn.textContent||btn.title||''))
      .forEach(btn => btn.classList.add('regenerate-btn'));
  }
  function colorTrendLines(trendBox){
    const svg = trendBox.querySelector('svg');
    if (!svg) return;
    const paths = Array.from(svg.querySelectorAll('path'));
    if (!paths.length) return;
    let dotted = paths.find(p => {
      const dash = getComputedStyle(p).strokeDasharray || p.getAttribute('stroke-dasharray');
      return dash && /[ ,]/.test(dash);
    });
    let solid = paths.find(p => p !== dotted);
    if (!dotted && paths.length >= 2) {
      solid = paths[0];
      dotted = paths[paths.length-1];
    }
    if (solid) solid.classList.add('lookback');
    if (dotted) dotted.classList.add('forecast');
  }
  function accentTitles(){
    const candidates = Array.from(document.querySelectorAll('h2,h3,h4'))
      .filter(h => /scorecard|roll\-?up|insights|builder/i.test((h.textContent||'').toLowerCase()));
    candidates.forEach(h => h.classList.add('als-title'));
  }
  function boot(){
    accentTitles();
    const cards = findPerfCards();
    cards.forEach(card => {
      const trend = findTrendArea(card);
      if (trend) { ensureLegend(trend); colorTrendLines(trend); }
    });
  }
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', boot);
  } else { boot(); }
  const obs = new MutationObserver(() => boot());
  obs.observe(document.body, {childList:true, subtree:true});
})();
</script>
<script>
// === Inject legend into Performance & Bonus Insights and remove "Regenerate" button ===
(function(){
  function findHeading(text){
    const els = Array.from(document.querySelectorAll('h1,h2,h3,h4,h5,h6'));
    return els.find(el => el.textContent.trim().toLowerCase().includes(text));
  }
  const heading = findHeading('performance & bonus insights') || findHeading('performance and bonus insights');
  if(!heading) return;
  const card = heading.closest('section, .card, .panel, .container, div');
  if(!card) return;
  card.style.position = card.style.position || 'relative';

  // Remove regenerate button if present
  const regen = Array.from(card.querySelectorAll('button, .btn')).find(b => /regenerate/i.test(b.textContent||''));
  if(regen && regen.parentElement) regen.parentElement.removeChild(regen);

  // Prevent duplicates
  const old = card.querySelector('.als-legend');
  if(old) old.remove();

  const legend = document.createElement('div');
  legend.className = 'als-legend';
  legend.innerHTML = '<span class="item"><span class="dot lookback"></span>Lookback</span>' +
                     '<span class="item"><span class="dot forecast"></span>Forecast</span>';
  card/* removed ghost legend append */
})();
</script>
<script>
// === Insert legend into Performance & Bonus Insights header ===
(function(){
  function findHeaderEl() {
    // Look for a heading element that contains the label text
    const candidates = Array.from(document.querySelectorAll('h1,h2,h3,div,section'));
    for (const el of candidates) {
      const t = (el.textContent || '').trim();
      if (/^Performance\s*&\s*Bonus\s*Insights/i.test(t)) {
        return el;
      }
    }
    return null;
  }
  function ensurePanelClass(el){
    let panel = el.closest('.panel, .card, .tile, .section, .box');
    if (!panel) panel = el.parentElement;
    if (panel) panel.classList.add('perf-bonus-card');
    return panel;
  }
  function injectLegend(panel){
    if (!panel || panel.querySelector('.perf-legend')) return;
    const legend = document.createElement('div');
    legend.className = 'perf-legend';
    legend.innerHTML = `
      <div class="legend-chip"><span class="legend-dot cyan"></span>Lookback</div>
      <div class="legend-chip"><span class="legend-dot amber"></span>Forecast</div>
    `;
    panel/* removed ghost legend append */
  }
  // Wait a tick for UI to paint
  const start = performance.now();
  const tryInject = () => {
    const header = findHeaderEl();
    if (header) {
      const panel = ensurePanelClass(header);
      injectLegend(panel);
      return;
    }
    if (performance.now() - start < 3000) requestAnimationFrame(tryInject);
  };
  tryInject();
})();
</script>
<script>
// --- Patch: remove any old non-glow legend duplicates at runtime ---
document.addEventListener('DOMContentLoaded', function(){
  document.querySelectorAll('.trend-legend').forEach(function(el){
    try { el.remove(); } catch(e){ /* noop */ }
  });
});
</script>
<script>
document.addEventListener('DOMContentLoaded', function() {
  const killTexts = new Set([
    "Thresholds (from KPI Master)",
    "Read-only • Values come from each KPI’s definition.",
    "No KPIs selected yet. Add items to the Build Queue to preview R/Y/G cutpoints here."
  ]);
  // remove exact text nodes/elements that match
  const walker = document.createTreeWalker(document.body, NodeFilter.SHOW_ELEMENT, null);
  const toRemove = [];
  while (walker.nextNode()) {
    const el = walker.currentNode;
    const txt = (el.textContent || "").trim();
    if (killTexts.has(txt)) {
      toRemove.append ? toRemove.append(el) : toRemove.push(el);
    }
  }
  toRemove.forEach(el => el.remove());
});
</script>

</body>
</html>
<script>
// Override: dynamic R/Y/G from SETTINGS.bands
function bandFromScore(s){
  const b = (typeof SETTINGS!=='undefined' && SETTINGS.bands) ? SETTINGS.bands : {red:50, amber:75, yellow:90, green:100};
  if(s >= b.green) return 'green';
  if(s >= b.yellow) return 'yellow';
  if(s >= b.amber) return 'amber';
  return 'red';
}
</script>
<script>
function guidanceForKPI(pillar, kpiName, score, nextTargetBand, weight){
  const ACTION_LIBRARY = [
    { match:/near\s*miss/i, action:"Increase GEMBA walk frequency by 10% and prompt one quick-report per shift.", impact:"Near-miss reports +15% yields the biggest lift this week." },
    { match:/speak\s*up|voice|psych/i, action:"Run 2 micro-huddles asking for hazards/ideas; thank-by-name in end-of-week note.", impact:"Speak-up participation +12% improves culture KPIs." },
    { match:/training|lms|compliance/i, action:"Schedule two 15-min micro-sessions and auto-enroll overdue staff.", impact:"Training completion +12% measurably improves Safety pillar." },
    { match:/cap|closure|corrective/i, action:"Daily 10‑min unblocker and enforce a 7‑day closure SLA.", impact:"Each 10% CAP closure rise increases the pillar ~3–5 pts." },
    { match:/audit|inspection/i, action:"Convert to photo checklists; sample 20% more high‑risk areas.", impact:"Audit conformance +10% reduces repeat defects." },
    { match:/pm compliance|maintenance/i, action:"Lock PM windows; add pre‑shift checks; escalate repeats.", impact:"PM compliance +10% reduces unplanned downtime risk." },
    { match:/ergo|musculo/i, action:"Add 5‑min pre‑shift stretch; rotate high‑strain tasks every 90 min.", impact:"Expect 10–15% drop in ergo near-misses." },
    { match:/first\s*pass|quality/i, action:"Add constraint-step layer check and poka‑yoke common error.", impact:"FPY +8% lifts Operations most." },
    { match:/housekeeping|5s/i, action:"30‑min 5S blitz; label golden zones; set min/max for top 20 items.", impact:"Sustain 5S +12%; fewer search-time delays." },
    { match:/handoff|comms|response/i, action:"Use a standard handoff card and radio check at shift boundaries.", impact:"Handoff errors −20%; fewer rework loops." }
  ];
  const rule = ACTION_LIBRARY.find(r => r.match.test(kpiName)) || {action:"Run a focused Kaizen on the constraint; pilot one countermeasure for 2 weeks.", impact:"Expect a 3–6 pt lift if sustained."};
  const liftPts = Math.max(1, Math.round((100 - Math.min(100, score)) * (weight||0.1)));
  return `Focus: <b>${pillar}</b> — <b>${kpiName}</b>. ${rule.action} ${rule.impact} Estimated lift: +${liftPts} pts toward pillar average.`;
}
</script>
<script>
/* === ALS Executive Seeder v4 — reseeds on filter change with stable per-slice RNG === */
(function(){
  // Seeded RNG for stable variability per filter slice
  function mulberry32(a){return function(){var t=a+=0x6D2B79F5;t=Math.imul(t^t>>>15,t|1);t^=t+Math.imul(t^t>>>7,t|61);return ((t^t>>>14)>>>0)/4294967296;}}
  function hashStr(s){let h=2166136261>>>0; for(let i=0;i<s.length;i++){h^=s.charCodeAt(i); h=Math.imul(h,16777619);} return h>>>0;}

  const clamp=(v,a,b)=>Math.max(a,Math.min(b,v));
  const avg = arr => Math.round(arr.reduce((s,v)=>s+v,0)/arr.length);
  const band = s => s<60?'red':(s<75?'yellow':'green');
  const PILLARS=['Safety Integrity & Culture','Servant Leadership & Development','Operational Delivery & Quality','Regulatory Compliance & Governance','People & Resource Stewardship','CI Culture & Improvement'];
  const NAMES=["Jordan Lee","Avery Chen","Riley Patel","Casey Smith","Morgan Diaz","Taylor Brooks","Alex Nguyen","Jamie Park","Sam Rivera","Cameron Lee","Quinn Hall","Drew Fox","Harper Reed","Reese Martin","Parker James","Rowan Blake","Skylar Cruz","Devin Scott","Eden Wells","Dakota Lane","River Gray","Remy Collins","Shay Morgan","Blair Ellis","Kendall Roy","Charlie West","Taylor Reed","Bailey Quinn","Finley Hart","Logan Snow","Sage Porter","Ari Brooks","Jules Monroe","Kai Turner","Noa Hayes","Zion Pierce","Emery Lane","Lane Avery","Peyton Cole","Hayden Park","Robin Blake","Luca West","Micah Shaw","Rory Dean","Ari Fox","Ainsley Ford","Ellis Lowe","Keegan Rhodes","Rowe Nash","Lane Hart","Indy Webb","Milan Cruz","Rio West","Aspen Vale","Jai Brooks","Rey Collins"];

  function findExecScope(){
    const headers=[...document.querySelectorAll('h1,h2,h3,h4,h5,div,section')];
    const h=headers.find(el=>/executive roll[\s-]?up/i.test(el.textContent||''));
    return h? (h.closest('section')||h.closest('.card')||h):null;
  }
  function getFilters(scope){
    const selects=[...scope.querySelectorAll('select')];
    const find = key => selects.find(s=> new RegExp(key,'i').test((s.previousSibling&&s.previousSibling.textContent)||s.parentElement.textContent||'')) || selects.shift();
    const regionSel   = find('region');
    const positionSel = find('position');
    const deptSel     = find('department');
    const siteSel     = find('site');
    return {regionSel, positionSel, deptSel, siteSel};
  }
  const optionTexts = sel => sel? [...sel.options].map(o=>o.text.trim()).filter(Boolean):[];
  const selectedText = sel => sel && sel.selectedOptions && sel.selectedOptions[0] ? sel.selectedOptions[0].text.trim() : '';

  // Build seed key from current filter selections to get stable-but-different data per slice
  function currentKey(ctrl){
    return [selectedText(ctrl.regionSel), selectedText(ctrl.deptSel), selectedText(ctrl.positionSel), selectedText(ctrl.siteSel)].join('|');
  }
  // Domain from selects (drops "All ..." where present; fallback defaults)
  function buildDomain(ctrl){
    const dropAll = arr => arr.filter(t=>!/^all\s/i.test(t));
    const regions = (dropAll(optionTexts(ctrl.regionSel))).length? dropAll(optionTexts(ctrl.regionSel)) : ['East','West','North','South'];
    const depts   = (dropAll(optionTexts(ctrl.deptSel))).length? dropAll(optionTexts(ctrl.deptSel))   : ['Operations','Maintenance','Quality','Safety'];
    const positions=(dropAll(optionTexts(ctrl.positionSel))).length? dropAll(optionTexts(ctrl.positionSel)) : ['Manager','Supervisor','Specialist'];
    const sites   = (dropAll(optionTexts(ctrl.siteSel))).length? dropAll(optionTexts(ctrl.siteSel))   : ['Site A','Site B','Site C','Site D'];
    return {regions,depts,positions,sites};
  }

  // Generate dataset using a seeded RNG derived from the filter key so each filter slice gets unique scores
  function makeDataset(domain, seedKey){
    const rnd = mulberry32(hashStr(seedKey||'als-exec'));
    const rando=(a,b)=>Math.round(a + rnd()*(b-a));
    const rows=[], {regions,depts,positions,sites} = domain;
    let nameIdx=0, combo=0;
    const cap = 200;
    for(const r of regions){
      for(const d of depts){
        for(const p of positions){
          for(const s of sites){
            // deterministic tier by combo (rotates red/yellow/green) + RNG wobble
            const tier = (combo + rando(0,2)) % 3; // 0 red, 1 yellow, 2 green
            const center = tier===0? rando(52,59) : tier===1? rando(66,74) : rando(80,92);
            const k = 2;
            for(let i=0;i<k;i++){
              const wobble = rando(-8,8);
              const pillars = PILLARS.map((_,pi)=> clamp(center + rando(-10,10) + (pi%2? rando(-2,2):0) + wobble/3, 40, 100));
              rows.push({
                name: NAMES[nameIdx++ % NAMES.length],
                region:r, dept:d, pos:p, site:s,
                score: clamp(avg(pillars),40,100),
                pillars
              });
              if(rows.length>=cap) return rows;
            }
            combo++;
          }
        }
      }
    }
    return rows;
  }

  function applyFilters(rows, ctrl){
    const isAll = v => /^all\s/i.test(v||'');
    const region = selectedText(ctrl.regionSel),
          dept   = selectedText(ctrl.deptSel),
          pos    = selectedText(ctrl.positionSel),
          site   = selectedText(ctrl.siteSel);
    return rows.filter(r =>
      (isAll(region) || !region || r.region===region) &&
      (isAll(dept)   || !dept   || r.dept===dept) &&
      (isAll(pos)    || !pos    || r.pos===pos) &&
      (isAll(site)   || !site   || r.site===site)
    );
  }

  function findCard(scope, key){
    const t=[...scope.querySelectorAll('.card-title,h3,h4,h5,.title,span,div')]
      .find(el=> (el.textContent||'').toLowerCase().includes(key));
    return t? (t.closest('.card')||t.parentElement): null;
  }
  function ensureBody(card){
    if(!card) return null;
    let body=card.querySelector('.card-body');
    if(!body){ body=document.createElement('div'); body.className='card-body'; card.appendChild(body); }
    body.innerHTML=''; return body;
  }

  let STORE=null; // {key, rows, domain}

  function reseed(scope, ctrl){
    const domain = buildDomain(ctrl);
    const key = currentKey(ctrl) || 'ALL';
    STORE = { key, rows: makeDataset(domain, key), domain };
  }

  function paint(scope, ctrl){
    if(!STORE) reseed(scope, ctrl);
    const rows = applyFilters(STORE.rows, ctrl);
    if(!rows.length) return;
    const a=ensureBody(findCard(scope,'avg weighted total'));
    const t=ensureBody(findCard(scope,'tier distribution'));
    const m=ensureBody(findCard(scope,'managers included'));
    const h=ensureBody(findCard(scope,'pillar heatmap'));
    const l=ensureBody(findCard(scope,'top leaders'));

    const overall = avg(rows.map(r=>r.score));
    a && (a.innerHTML = `<div style="font-size:42px;font-weight:800">${overall}</div><div style="opacity:.75">Band: ${band(overall)}</div>`);

    const dist={red:0,yellow:0,green:0}; rows.forEach(r=>dist[band(r.score)]++);
    t && (t.innerHTML = `<div class="kpi-legend"><span class="kpi-dot r"></span>Red <b>${dist.red}</b> <span style="margin:0 6px">·</span><span class="kpi-dot y"></span>Yellow <b>${dist.yellow}</b> <span style="margin:0 6px">·</span><span class="kpi-dot g"></span>Green <b>${dist.green}</b></div>`);

    m && (m.textContent = String(rows.length));

    if(h){
      const pillarAvgs = PILLARS.map((_,i)=> avg(rows.map(r=>r.pillars[i])));
      h.innerHTML = `<table class="table" style="width:100%"><thead><tr><th style="text-align:left">Pillar</th><th style="text-align:right">Avg</th><th style="text-align:right">Band</th></tr></thead><tbody>${pillarAvgs.map((v,i)=>`<tr><td>${PILLARS[i]}</td><td style="text-align:right">${v}</td><td style="text-align:right"><span class="band band-chip ${band(v)}">${band(v)}</span></td></tr>`).join('')}</tbody></table>`;
    }

    if(l){
      const top = rows.slice().sort((a,b)=>b.score-a.score).slice(0,6);
      l.innerHTML = top.map(x=>`<div style="display:flex;gap:12px;align-items:center;justify-content:space-between;padding:6px 0;border-bottom:1px solid var(--border,rgba(255,255,255,.08))"><div>${x.name}</div><div style="opacity:.8;flex:1;text-align:center">${x.region} • ${x.dept} • ${x.pos} • ${x.site}</div><div><span class="score-chip" style="display:inline-block;min-width:40px;text-align:center;border:1px solid var(--border,rgba(255,255,255,.2));border-radius:999px;padding:2px 8px;font-weight:700">${x.score}</span></div></div>`).join('');
    }
  }

  function bind(){
    const scope = findExecScope(); if(!scope) return;
    const ctrl = getFilters(scope);
    function refresh(){ reseed(scope, ctrl); paint(scope, ctrl); }
    // Seed & paint on load
    refresh();
    // Re-seed + repaint on filter change (no need to click any button)
    [ctrl.regionSel, ctrl.deptSel, ctrl.positionSel, ctrl.siteSel].forEach(s=> s && s.addEventListener('change', refresh));
    // Keep the button (if present) as a manual regenerate too
    const seedBtn=[...scope.querySelectorAll('button,a')].find(b=>/seed exec demo/i.test(b.textContent||''));
    seedBtn && seedBtn.addEventListener('click', refresh);
  }
  document.readyState==='loading'?document.addEventListener('DOMContentLoaded',bind):bind();
})();
</script>
<script>
/* === ALS Executive Seeder v6 — repaint ALL exec cards on filter change (stronger targeting) === */
(function(){
  const clamp=(v,a,b)=>Math.max(a,Math.min(b,v));
  const avg = arr => Math.round(arr.reduce((s,v)=>s+v,0)/arr.length);
  const band = s => s<60?'red':(s<75?'yellow':'green');
  const PILLARS=['Safety Integrity & Culture','Servant Leadership & Development','Operational Delivery & Quality','Regulatory Compliance & Governance','People & Resource Stewardship','CI Culture & Improvement'];
  const NAMES=["Jordan Lee","Avery Chen","Riley Patel","Casey Smith","Morgan Diaz","Taylor Brooks","Alex Nguyen","Jamie Park","Sam Rivera","Cameron Lee","Quinn Hall","Drew Fox","Harper Reed","Reese Martin","Parker James","Rowan Blake","Skylar Cruz","Devin Scott","Eden Wells","Dakota Lane","River Gray","Remy Collins","Shay Morgan","Blair Ellis","Kendall Roy","Charlie West","Taylor Reed","Bailey Quinn","Finley Hart","Logan Snow","Sage Porter","Ari Brooks","Jules Monroe","Kai Turner","Noa Hayes","Zion Pierce","Emery Lane","Lane Avery","Peyton Cole","Hayden Park","Robin Blake","Luca West","Micah Shaw","Rory Dean","Ari Fox","Ainsley Ford","Ellis Lowe","Keegan Rhodes","Rowe Nash","Lane Hart"];

  function findExecScope(){
    const direct = document.querySelector('#exec, .exec, [data-pane="exec"]');
    if(direct) return direct;
    // Fallback: choose the container with most of our five titles present
    const cands = Array.from(document.querySelectorAll('section, .tab-pane, .container, .panel, main, .page, body'));
    function score(el){
      const t = (el.textContent||'').toLowerCase();
      return ['avg weighted total','tier distribution','managers included','pillar heatmap','top leaders']
        .reduce((n,k)=>n + (t.includes(k)?1:0), 0);
    }
    return cands.reduce((best,el)=> (score(el) > (best?best._s:0) ? (el._s=score(el),el) : best), null) || document.body;
  }

  function getExecSelects(scope){
    // Use selects in exec scope; if too many, prefer those near tier distribution card
    let selects = Array.from(scope.querySelectorAll('select'));
    if(selects.length>4){
      const tier = Array.from(scope.querySelectorAll('.card-title,h3,h4')).find(e=>(e.textContent||'').toLowerCase().includes('tier distribution'));
      if(tier){
        const row = tier.closest('.grid, .row, section, .container') || scope;
        const local = Array.from(row.querySelectorAll('select'));
        if(local.length>=1) selects = local;
      }
    }
    return selects;
  }

  function optionLabel(opt){ return (opt && (opt.value || opt.text || '')).toString().trim(); }
  const isAll = v => /^all\s/i.test(v||'');
  function optionsList(sel){ return sel? Array.from(sel.options).map(optionLabel).filter(Boolean):[]; }
  function selectedLabel(sel){ return sel && sel.selectedIndex>=0 ? optionLabel(sel.options[sel.selectedIndex]) : ''; }

  function buildDomain(selects){
    const [regionSel, posSel, deptSel, siteSel] = selects;
    const regions = optionsList(regionSel).filter(v=>!isAll(v)); if(!regions.length) regions.push('East','West','North','South');
    const depts   = optionsList(deptSel).filter(v=>!isAll(v));   if(!depts.length)   depts.push('Operations','Maintenance','Quality','Safety');
    const positions=optionsList(posSel).filter(v=>!isAll(v));    if(!positions.length) positions.push('Manager','Supervisor','Specialist');
    const sites   = optionsList(siteSel).filter(v=>!isAll(v));   if(!sites.length)   sites.push('Site A','Site B','Site C','Site D');
    return {regions,depts,positions,sites};
  }

  function makeDataset(domain){
    const {regions,depts,positions,sites} = domain;
    const rows=[]; let idx=0;
    regions.forEach((r,ri)=> depts.forEach((d,di)=> positions.forEach((p,pi)=> sites.forEach((s,si)=>{
      const tier=(ri+di+pi+si)%3; // rotate band by combination
      const center = tier===0? 55 : tier===1? 70 : 85;
      const k=2;
      for(let m=0;m<k;m++){
        const pillars = PILLARS.map((_,i)=> clamp(center + (Math.random()*16-8) + (i%2? (Math.random()*4-2):0), 40, 100));
        rows.push({name:NAMES[idx++%NAMES.length], region:r, dept:d, pos:p, site:s, score: avg(pillars), pillars});
      }
    }))));
    return rows;
  }

  function findCardByTitle(scope, keys){
    const titles = Array.from(scope.querySelectorAll('.card-title,h3,h4,h5,.title'));
    const low = s => (s||'').toLowerCase();
    const k = keys.map(low);
    // exact/contains match
    let el = titles.find(t=> k.some(kk=> low(t.textContent).includes(kk)));
    if(el) return el.closest('.card') || el.parentElement;
    // last resort: pick nth card in exec scope
    const cards = Array.from(scope.querySelectorAll('.card'));
    const mapOrder = {'avg weighted total':0,'tier distribution':1,'managers included':2,'pillar heatmap':3,'top leaders':4};
    const firstKey = k[0];
    const order = mapOrder[firstKey] ?? 0;
    return cards[order] || cards[0] || scope;
  }
  function ensureBody(card){
    if(!card) return null;
    let body = card.querySelector('.card-body');
    if(!body){ body=document.createElement('div'); body.className='card-body'; card.appendChild(body); }
    body.innerHTML=''; return body;
  }

  function sliceRows(rows, selects){
    const [regionSel, posSel, deptSel, siteSel] = selects;
    const region = selectedLabel(regionSel), pos=selectedLabel(posSel), dept=selectedLabel(deptSel), site=selectedLabel(siteSel);
    return rows.filter(r =>
      (isAll(region) || !region || r.region===region) &&
      (isAll(pos)    || !pos    || r.pos===pos) &&
      (isAll(dept)   || !dept   || r.dept===dept) &&
      (isAll(site)   || !site   || r.site===site)
    );
  }

  function paint(scope, selects, rows){
    const view = sliceRows(rows, selects);
    if(!view.length) return;

    const avgCard  = findCardByTitle(scope, ['avg weighted total']);
    const tierCard = findCardByTitle(scope, ['tier distribution']);
    const mgrCard  = findCardByTitle(scope, ['managers included']);
    const heatCard = findCardByTitle(scope, ['pillar heatmap']);
    const leadCard = findCardByTitle(scope, ['top leaders']);

    const ov = avg(view.map(r=>r.score));
    const dist = {red:0,yellow:0,green:0}; view.forEach(r=> dist[band(r.score)]++);
    const pillarAvgs = PILLARS.map((_,i)=> avg(view.map(r=>r.pillars[i])));

    const a=ensureBody(avgCard);  if(a){ a.innerHTML = `<div class="big-num">${ov}</div><div style="opacity:.75">Band: <span class="band band-chip ${band(ov)}">${band(ov)}</span></div>`; }
    const t=ensureBody(tierCard); if(t){ t.innerHTML = `<div class="kpi-legend"><span class="kpi-dot r"></span>Red <b>${dist.red}</b> <span style="margin:0 6px">·</span><span class="kpi-dot y"></span>Yellow <b>${dist.yellow}</b> <span style="margin:0 6px">·</span><span class="kpi-dot g"></span>Green <b>${dist.green}</b></div>`; }
    const m=ensureBody(mgrCard);  if(m){ m.textContent = String(view.length); }
    const h=ensureBody(heatCard); if(h){ h.innerHTML = `<table class="table" style="width:100%"><thead><tr><th style="text-align:left">Pillar</th><th style="text-align:right">Avg</th><th style="text-align:right">Band</th></tr></thead><tbody>${pillarAvgs.map((v,i)=>`<tr><td>${PILLARS[i]}</td><td style="text-align:right">${v}</td><td style="text-align:right"><span class="band band-chip ${band(v)}">${band(v)}</span></td></tr>`).join('')}</tbody></table>`; }
    const l=ensureBody(leadCard); if(l){
      const top = view.slice().sort((a,b)=>b.score-a.score).slice(0,6);
      l.innerHTML = top.map(x=>`<div style="display:flex;gap:12px;align-items:center;justify-content:space-between;padding:6px 0;border-bottom:1px solid var(--border,rgba(255,255,255,.08))">
        <div>${x.name}</div>
        <div style="opacity:.8;flex:1;text-align:center">${x.region} • ${x.dept} • ${x.pos} • ${x.site}</div>
        <div><span class="score-chip" style="display:inline-block;min-width:40px;text-align:center;border:1px solid var(--border,rgba(255,255,255,.2));border-radius:999px;padding:2px 8px;font-weight:700">${x.score}</span></div>
      </div>`).join('');
    }
  }

  function bind(){
    const scope = findExecScope();
    if(!scope) return;
    const selects = getExecSelects(scope);
    if(!selects.length) return;

    // Build once and slice on change (fast, consistent)
    const domain = buildDomain(selects);
    const rows = makeDataset(domain);

    // Initial paint and on change
    const repaint = ()=> paint(scope, selects, rows);
    repaint();
    selects.forEach(sel=> sel && sel.addEventListener('change', repaint));

    // If SPA mutates exec area, rebind
    const mo = new MutationObserver(()=>{
      const fresh = getExecSelects(scope);
      if(fresh.length && fresh[0] !== selects[0]){
        fresh.forEach(sel=> sel && sel.addEventListener('change', repaint));
        paint(scope, fresh, rows);
      }
    });
    mo.observe(scope, {childList:true, subtree:true});
  }

  if(document.readyState==='loading') document.addEventListener('DOMContentLoaded', bind);
  else bind();
})();
</script>
